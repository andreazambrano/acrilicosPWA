import { __decorate, __metadata } from "tslib";
import { Injectable } from '@angular/core';
import { InjectionService } from '../../services/injection/injection.service';
import { LoadingComponent } from './loading.component';
let LoadingService = class LoadingService {
    constructor(injectionService) {
        this.injectionService = injectionService;
        this.threshold = 250;
        this._count = 0;
        this._progress = 0;
    }
    set progress(val) {
        if (this.instance) {
            this.instance.progress = val;
        }
        this._progress = val;
    }
    get progress() {
        return this._progress;
    }
    get count() {
        return this._count;
    }
    get instance() {
        if (this.component)
            return this.component.instance;
    }
    start(autoIncrement = true) {
        this.create();
        this._count++;
        if (autoIncrement) {
            clearTimeout(this.timeout);
            const fn = () => {
                this.increment();
                if (this.progress < 100) {
                    this.timeout = setTimeout(fn.bind(this), this.threshold);
                }
                else {
                    this.complete();
                }
            };
            this.timeout = setTimeout(fn.bind(this), this.threshold);
        }
    }
    stop() {
        this._count--;
        clearTimeout(this.timeout);
    }
    reset(num = 0) {
        this.progress = num;
    }
    complete(all = false) {
        this._count--;
        if (this.count <= 0 || all) {
            this.progress = 100;
            this._count = 0;
            setTimeout(() => {
                this.hide();
                this.progress = 0;
            }, this.threshold * 2);
        }
    }
    hide() {
        this.stop();
        if (this.instance) {
            this.instance.visible = false;
        }
    }
    create() {
        if (!this.component) {
            this.component = this.injectionService.appendComponent(LoadingComponent);
        }
        this.instance.visible = true;
        this.instance.progress = this.progress;
        return this.component;
    }
    increment() {
        if (this.progress >= 100)
            return;
        // inspired by angular-loading-bar
        // https://github.com/chieffancypants/angular-loading-bar
        const stat = this.progress / 100;
        let rnd = 0;
        if (stat >= 0 && stat < 0.25) {
            // Start out between 3 - 6% increments
            rnd = (Math.random() * (5 - 3 + 1) + 3) / 100;
        }
        else if (stat >= 0.25 && stat < 0.65) {
            // increment between 0 - 3%
            rnd = (Math.random() * 3) / 100;
        }
        else if (stat >= 0.65 && stat < 0.9) {
            // increment between 0 - 2%
            rnd = (Math.random() * 2) / 100;
        }
        else {
            // finally, increment it .5 %
            // after 99%, don't increment:
            rnd = 0.005;
        }
        this.progress = (stat + rnd) * 100;
    }
};
LoadingService.ctorParameters = () => [
    { type: InjectionService }
];
LoadingService = __decorate([
    Injectable(),
    __metadata("design:paramtypes", [InjectionService])
], LoadingService);
export { LoadingService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGluZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHN3aW1sYW5lL25neC11aS8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2xvYWRpbmcvbG9hZGluZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFnQixNQUFNLGVBQWUsQ0FBQztBQUV6RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0Q0FBNEMsQ0FBQztBQUM5RSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUd2RCxJQUFhLGNBQWMsR0FBM0IsTUFBYSxjQUFjO0lBNEJ6QixZQUE2QixnQkFBa0M7UUFBbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQTNCL0QsY0FBUyxHQUFXLEdBQUcsQ0FBQztRQXNCaEIsV0FBTSxHQUFXLENBQUMsQ0FBQztRQUduQixjQUFTLEdBQVcsQ0FBQyxDQUFDO0lBRW9DLENBQUM7SUF6Qm5FLElBQUksUUFBUSxDQUFDLEdBQVc7UUFDdEIsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2pCLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQztTQUM5QjtRQUVELElBQUksQ0FBQyxTQUFTLEdBQUcsR0FBRyxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxJQUFJLFFBQVE7UUFDVixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDeEIsQ0FBQztJQUVELElBQUksS0FBSztRQUNQLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUNyQixDQUFDO0lBRUQsSUFBWSxRQUFRO1FBQ2xCLElBQUksSUFBSSxDQUFDLFNBQVM7WUFBRSxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO0lBQ3JELENBQUM7SUFTRCxLQUFLLENBQUMsZ0JBQXlCLElBQUk7UUFDakMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2QsSUFBSSxDQUFDLE1B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LEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDO1NBQ2pDO2FBQU0sSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksR0FBRyxHQUFHLEVBQUU7WUFDckMsMkJBQTJCO1lBQzNCLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUM7U0FDakM7YUFBTTtZQUNMLDZCQUE2QjtZQUM3Qiw4QkFBOEI7WUFDOUIsR0FBRyxHQUFHLEtBQUssQ0FBQztTQUNiO1FBRUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7SUFDckMsQ0FBQztDQUNGLENBQUE7O1lBekZnRCxnQkFBZ0I7O0FBNUJwRCxjQUFjO0lBRDFCLFVBQVUsRUFBRTtxQ0E2Qm9DLGdCQUFnQjtHQTVCcEQsY0FBYyxDQXFIMUI7U0FySFksY0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIENvbXBvbmVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBJbmplY3Rpb25TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvaW5qZWN0aW9uL2luamVjdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IExvYWRpbmdDb21wb25lbnQgfSBmcm9tICcuL2xvYWRpbmcuY29tcG9uZW50JztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIExvYWRpbmdTZXJ2aWNlIHtcbiAgdGhyZXNob2xkOiBudW1iZXIgPSAyNTA7XG5cbiAgc2V0IHByb2dyZXNzKHZhbDogbnVtYmVyKSB7XG4gICAgaWYgKHRoaXMuaW5zdGFuY2UpIHtcbiAgICAgIHRoaXMuaW5zdGFuY2UucHJvZ3Jlc3MgPSB2YWw7XG4gICAgfVxuXG4gICAgdGhpcy5fcHJvZ3Jlc3MgPSB2YWw7XG4gIH1cblxuICBnZXQgcHJvZ3Jlc3MoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fcHJvZ3Jlc3M7XG4gIH1cblxuICBnZXQgY291bnQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fY291bnQ7XG4gIH1cblxuICBwcml2YXRlIGdldCBpbnN0YW5jZSgpIHtcbiAgICBpZiAodGhpcy5jb21wb25lbnQpIHJldHVybiB0aGlzLmNvbXBvbmVudC5pbnN0YW5jZTtcbiAgfVxuXG4gIHByaXZhdGUgX2NvdW50OiBudW1iZXIgPSAwO1xuICBwcml2YXRlIHRpbWVvdXQ6IGFueTtcbiAgcHJpdmF0ZSBjb21wb25lbnQ6IENvbXBvbmVudFJlZjxMb2FkaW5nQ29tcG9uZW50PjtcbiAgcHJpdmF0ZSBfcHJvZ3Jlc3M6IG51bWJlciA9IDA7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBpbmplY3Rpb25TZXJ2aWNlOiBJbmplY3Rpb25TZXJ2aWNlKSB7fVxuXG4gIHN0YXJ0KGF1dG9JbmNyZW1lbnQ6IGJvb2xlYW4gPSB0cnVlKTogdm9pZCB7XG4gICAgdGhpcy5jcmVhdGUoKTtcbiAgICB0aGlzLl9jb3VudCsrO1xuXG4gICAgaWYgKGF1dG9JbmNyZW1lbnQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXQpO1xuXG4gICAgICBjb25zdCBmbiA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5pbmNyZW1lbnQoKTtcbiAgICAgICAgaWYgKHRoaXMucHJvZ3Jlc3MgPCAxMDApIHtcbiAgICAgICAgICB0aGlzLnRpbWVvdXQgPSBzZXRUaW1lb3V0KGZuLmJpbmQodGhpcyksIHRoaXMudGhyZXNob2xkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmNvbXBsZXRlKCk7XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIHRoaXMudGltZW91dCA9IHNldFRpbWVvdXQoZm4uYmluZCh0aGlzKSwgdGhpcy50aHJlc2hvbGQpO1xuICAgIH1cbiAgfVxuXG4gIHN0b3AoKTogdm9pZCB7XG4gICAgdGhpcy5fY291bnQtLTtcbiAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0KTtcbiAgfVxuXG4gIHJlc2V0KG51bTogbnVtYmVyID0gMCk6IHZvaWQge1xuICAgIHRoaXMucHJvZ3Jlc3MgPSBudW07XG4gIH1cblxuICBjb21wbGV0ZShhbGw6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xuICAgIHRoaXMuX2NvdW50LS07XG5cbiAgICBpZiAodGhpcy5jb3VudCA8PSAwIHx8IGFsbCkge1xuICAgICAgdGhpcy5wcm9ncmVzcyA9IDEwMDtcbiAgICAgIHRoaXMuX2NvdW50ID0gMDtcblxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMuaGlkZSgpO1xuICAgICAgICB0aGlzLnByb2dyZXNzID0gMDtcbiAgICAgIH0sIHRoaXMudGhyZXNob2xkICogMik7XG4gICAgfVxuICB9XG5cbiAgaGlkZSgpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3AoKTtcblxuICAgIGlmICh0aGlzLmluc3RhbmNlKSB7XG4gICAgICB0aGlzLmluc3RhbmNlLnZpc2libGUgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZSgpOiBDb21wb25lbnRSZWY8TG9hZGluZ0NvbXBvbmVudD4ge1xuICAgIGlmICghdGhpcy5jb21wb25lbnQpIHtcbiAgICAgIHRoaXMuY29tcG9uZW50ID0gdGhpcy5pbmplY3Rpb25TZXJ2aWNlLmFwcGVuZENvbXBvbmVudChMb2FkaW5nQ29tcG9uZW50KTtcbiAgICB9XG5cbiAgICB0aGlzLmluc3RhbmNlLnZpc2libGUgPSB0cnVlO1xuICAgIHRoaXMuaW5zdGFuY2UucHJvZ3Jlc3MgPSB0aGlzLnByb2dyZXNzO1xuXG4gICAgcmV0dXJuIHRoaXMuY29tcG9uZW50O1xuICB9XG5cbiAgcHJpdmF0ZSBpbmNyZW1lbnQoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMucHJvZ3Jlc3MgPj0gMTAwKSByZXR1cm47XG5cbiAgICAvLyBpbnNwaXJlZCBieSBhbmd1bGFyLWxvYWRpbmctYmFyXG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoaWVmZmFuY3lwYW50cy9hbmd1bGFyLWxvYWRpbmctYmFyXG4gICAgY29uc3Qgc3RhdCA9IHRoaXMucHJvZ3Jlc3MgLyAxMDA7XG4gICAgbGV0IHJuZCA9IDA7XG5cbiAgICBpZiAoc3RhdCA+PSAwICYmIHN0YXQgPCAwLjI1KSB7XG4gICAgICAvLyBTdGFydCBvdXQgYmV0d2VlbiAzIC0gNiUgaW5jcmVtZW50c1xuICAgICAgcm5kID0gKE1hdGgucmFuZG9tKCkgKiAoNSAtIDMgKyAxKSArIDMpIC8gMTAwO1xuICAgIH0gZWxzZSBpZiAoc3RhdCA+PSAwLjI1ICYmIHN0YXQgPCAwLjY1KSB7XG4gICAgICAvLyBpbmNyZW1lbnQgYmV0d2VlbiAwIC0gMyVcbiAgICAgIHJuZCA9IChNYXRoLnJhbmRvbSgpICogMykgLyAxMDA7XG4gICAgfSBlbHNlIGlmIChzdGF0ID49IDAuNjUgJiYgc3RhdCA8IDAuOSkge1xuICAgICAgLy8gaW5jcmVtZW50IGJldHdlZW4gMCAtIDIlXG4gICAgICBybmQgPSAoTWF0aC5yYW5kb20oKSAqIDIpIC8gMTAwO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBmaW5hbGx5LCBpbmNyZW1lbnQgaXQgLjUgJVxuICAgICAgLy8gYWZ0ZXIgOTklLCBkb24ndCBpbmNyZW1lbnQ6XG4gICAgICBybmQgPSAwLjAwNTtcbiAgICB9XG5cbiAgICB0aGlzLnByb2dyZXNzID0gKHN0YXQgKyBybmQpICogMTAwO1xuICB9XG59XG4iXX0=