import { __decorate, __metadata } from "tslib";
import { Input, EventEmitter, Output } from '@angular/core';
import { createValueForSchema, jsonSchemaDataTypes, dataTypeMap, inferType, getIcon, getCurrentType, jsonSchemaDataFormats } from '../json-editor.helper';
export class ArrayNode {
    constructor() {
        this.required = false;
        this.modelChange = new EventEmitter();
        this.schemaChange = new EventEmitter();
        this.requiredCache = {};
        this.schemas = [];
        this.dataTypes = [...jsonSchemaDataTypes, ...jsonSchemaDataFormats];
        this.dataTypeMap = dataTypeMap;
        this._array = Array;
    }
    ngOnChanges(changes) {
        if (changes.schema) {
            if (this.schema && this.schema.required) {
                for (const prop of this.schema.required) {
                    this.requiredCache[prop] = true;
                }
            }
        }
        this.initSchemasTypeByModelValue();
        this.updateIcons();
    }
    /**
     * Updates an array item of the model and emits the change event
     * @param index
     * @param value
     */
    updateArrayItem(index, value) {
        this.model[index] = value;
        this.modelChange.emit(this.model);
    }
    /**
     * Adds a new item to the model
     */
    addArrayItem(dataType) {
        let schema;
        if (dataType) {
            schema = JSON.parse(JSON.stringify(Object.assign(Object.assign({}, this.schema.items), dataType.schema)));
        }
        else {
            schema = JSON.parse(JSON.stringify(this.schema.items));
        }
        if (!schema.type) {
            schema.type = 'object';
        }
        if (!schema.$meta) {
            schema.$meta = {};
        }
        if (Array.isArray(schema.type)) {
            schema.$meta.type = [...schema.type];
            schema.type = schema.type[0];
            schema.$meta.currentType = getCurrentType(schema);
        }
        const value = createValueForSchema(schema);
        if (value !== undefined) {
            this.model.push(value);
            this.schemas.push(schema);
        }
        this.modelChange.emit(this.model);
        this.updateIcons();
    }
    /**
     * Deletes an item from the array
     * @param index
     */
    deleteArrayItem(index) {
        this.model.splice(index, 1);
        this.schemas.splice(index, 1);
        this.model = [...this.model];
        this.schemas = [...this.schemas];
        this.modelChange.emit(this.model);
    }
    /**
     * Track By function for the array ittierator
     * @param index
     * @param value
     */
    arrayTrackBy(index) {
        return index;
    }
    /**
     *
     * @param property
     * @param type
     */
    changeItemType(index, type) {
        const schema = this.schemas[index];
        const dataType = this.dataTypeMap[type];
        if (dataType) {
            delete schema.format;
            schema.type = dataType.schema.type;
            if (dataType.schema.format) {
                schema.format = dataType.schema.format;
            }
            schema.$meta.currentType = getCurrentType(schema);
        }
        const value = createValueForSchema(schema);
        this.model[index] = value;
        this.modelChange.emit(this.model);
        this.updateIcons();
    }
    /**
     * Infers the schema type for each item in the array
     */
    initSchemasTypeByModelValue() {
        this.schemas = [];
        this.model.forEach(value => {
            let schema = inferType(value, this.typeCheckOverrides);
            if (this.schema.items) {
                schema = JSON.parse(JSON.stringify(Object.assign(Object.assign({}, this.schema.items), schema)));
            }
            this.schemas.push(schema);
        });
    }
    /**
     * Updates the icons in the schemas
     */
    updateIcons() {
        for (const schema of this.schemas) {
            if (!schema.$meta) {
                schema.$meta = {};
            }
            schema.$meta.icon = getIcon(schema);
        }
    }
}
__decorate([
    Input(),
    __metadata("design:type", Object)
], ArrayNode.prototype, "schema", void 0);
__decorate([
    Input(),
    __metadata("design:type", Array)
], ArrayNode.prototype, "model", void 0);
__decorate([
    Input(),
    __metadata("design:type", Boolean)
], ArrayNode.prototype, "required", void 0);
__decorate([
    Input(),
    __metadata("design:type", Boolean)
], ArrayNode.prototype, "expanded", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], ArrayNode.prototype, "path", void 0);
__decorate([
    Input(),
    __metadata("design:type", Array)
], ArrayNode.prototype, "errors", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], ArrayNode.prototype, "typeCheckOverrides", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], ArrayNode.prototype, "schemaRef", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], ArrayNode.prototype, "modelChange", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], ArrayNode.prototype, "schemaChange", void 0);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJyYXktbm9kZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ac3dpbWxhbmUvbmd4LXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvanNvbi1lZGl0b3Ivbm9kZS10eXBlcy9hcnJheS1ub2RlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUE0QixNQUFNLGVBQWUsQ0FBQztBQUV0RixPQUFPLEVBQ0wsb0JBQW9CLEVBQ3BCLG1CQUFtQixFQUNuQixXQUFXLEVBQ1gsU0FBUyxFQUNULE9BQU8sRUFDUCxjQUFjLEVBR2QscUJBQXFCLEVBQ3RCLE1BQU0sdUJBQXVCLENBQUM7QUFFL0IsTUFBTSxPQUFPLFNBQVM7SUFBdEI7UUFNVyxhQUFRLEdBQVksS0FBSyxDQUFDO1FBWXpCLGdCQUFXLEdBQXdCLElBQUksWUFBWSxFQUFFLENBQUM7UUFFdEQsaUJBQVksR0FBbUMsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUU1RSxrQkFBYSxHQUFRLEVBQUUsQ0FBQztRQUN4QixZQUFPLEdBQXVCLEVBQUUsQ0FBQztRQUNqQyxjQUFTLEdBQXlCLENBQUMsR0FBRyxtQkFBbUIsRUFBRSxHQUFHLHFCQUFxQixDQUFDLENBQUM7UUFDckYsZ0JBQVcsR0FBRyxXQUFXLENBQUM7UUFFMUIsV0FBTSxHQUFHLEtBQUssQ0FBQztJQXFJakIsQ0FBQztJQW5JQyxXQUFXLENBQUMsT0FBc0I7UUFDaEMsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFO1lBQ2xCLElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRTtnQkFDdkMsS0FBSyxNQUFNLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRTtvQkFDdkMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7aUJBQ2pDO2FBQ0Y7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QUM7SUFFRDs7T0FFRztJQUNLLFdBQVc7UUFDakIsS0FBSyxNQUFNLE1BQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2pDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFO2dCQUNqQixNQUFNLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQzthQUNuQjtZQUNELE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNyQztJQUNILENBQUM7Q0FDRjtBQTlKQztJQURDLEtBQUssRUFBRTs7eUNBQ2lCO0FBRWhCO0lBQVIsS0FBSyxFQUFFOzt3Q0FBYztBQUViO0lBQVIsS0FBSyxFQUFFOzsyQ0FBMkI7QUFFMUI7SUFBUixLQUFLLEVBQUU7OzJDQUFtQjtBQUVsQjtJQUFSLEtBQUssRUFBRTs7dUNBQWM7QUFFYjtJQUFSLEtBQUssRUFBRTs7eUNBQWU7QUFFZDtJQUFSLEtBQUssRUFBRTs7cURBQTBCO0FBRXpCO0lBQVIsS0FBSyxFQUFFOzs0Q0FBNkI7QUFFM0I7SUFBVCxNQUFNLEVBQUU7OEJBQWMsWUFBWTs4Q0FBNkI7QUFFdEQ7SUFBVCxNQUFNLEVBQUU7OEJBQWUsWUFBWTsrQ0FBd0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbnB1dCwgRXZlbnRFbWl0dGVyLCBPdXRwdXQsIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQge1xuICBjcmVhdGVWYWx1ZUZvclNjaGVtYSxcbiAganNvblNjaGVtYURhdGFUeXBlcyxcbiAgZGF0YVR5cGVNYXAsXG4gIGluZmVyVHlwZSxcbiAgZ2V0SWNvbixcbiAgZ2V0Q3VycmVudFR5cGUsXG4gIEpzb25TY2hlbWFEYXRhVHlwZSxcbiAgSlNPTkVkaXRvclNjaGVtYSxcbiAganNvblNjaGVtYURhdGFGb3JtYXRzXG59IGZyb20gJy4uL2pzb24tZWRpdG9yLmhlbHBlcic7XG5cbmV4cG9ydCBjbGFzcyBBcnJheU5vZGUgaW1wbGVtZW50cyBPbkNoYW5nZXMge1xuICBASW5wdXQoKVxuICBzY2hlbWE6IEpTT05FZGl0b3JTY2hlbWE7XG5cbiAgQElucHV0KCkgbW9kZWw6IGFueVtdO1xuXG4gIEBJbnB1dCgpIHJlcXVpcmVkOiBib29sZWFuID0gZmFsc2U7XG5cbiAgQElucHV0KCkgZXhwYW5kZWQ6IGJvb2xlYW47XG5cbiAgQElucHV0KCkgcGF0aDogc3RyaW5nO1xuXG4gIEBJbnB1dCgpIGVycm9yczogYW55W107XG5cbiAgQElucHV0KCkgdHlwZUNoZWNrT3ZlcnJpZGVzPzogYW55O1xuXG4gIEBJbnB1dCgpIHNjaGVtYVJlZjogSlNPTkVkaXRvclNjaGVtYTtcblxuICBAT3V0cHV0KCkgbW9kZWxDaGFuZ2U6IEV2ZW50RW1pdHRlcjxhbnlbXT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgQE91dHB1dCgpIHNjaGVtYUNoYW5nZTogRXZlbnRFbWl0dGVyPEpTT05FZGl0b3JTY2hlbWE+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIHJlcXVpcmVkQ2FjaGU6IGFueSA9IHt9O1xuICBzY2hlbWFzOiBKU09ORWRpdG9yU2NoZW1hW10gPSBbXTtcbiAgZGF0YVR5cGVzOiBKc29uU2NoZW1hRGF0YVR5cGVbXSA9IFsuLi5qc29uU2NoZW1hRGF0YVR5cGVzLCAuLi5qc29uU2NoZW1hRGF0YUZvcm1hdHNdO1xuICBkYXRhVHlwZU1hcCA9IGRhdGFUeXBlTWFwO1xuXG4gIF9hcnJheSA9IEFycmF5O1xuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoY2hhbmdlcy5zY2hlbWEpIHtcbiAgICAgIGlmICh0aGlzLnNjaGVtYSAmJiB0aGlzLnNjaGVtYS5yZXF1aXJlZCkge1xuICAgICAgICBmb3IgKGNvbnN0IHByb3Agb2YgdGhpcy5zY2hlbWEucmVxdWlyZWQpIHtcbiAgICAgICAgICB0aGlzLnJlcXVpcmVkQ2FjaGVbcHJvcF0gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5pbml0U2NoZW1hc1R5cGVCeU1vZGVsVmFsdWUoKTtcbiAgICB0aGlzLnVwZGF0ZUljb25zKCk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlcyBhbiBhcnJheSBpdGVtIG9mIHRoZSBtb2RlbCBhbmQgZW1pdHMgdGhlIGNoYW5nZSBldmVudFxuICAgKiBAcGFyYW0gaW5kZXhcbiAgICogQHBhcmFtIHZhbHVlXG4gICAqL1xuICB1cGRhdGVBcnJheUl0ZW0oaW5kZXg6IG51bWJlciwgdmFsdWU6IGFueSk6IHZvaWQge1xuICAgIHRoaXMubW9kZWxbaW5kZXhdID0gdmFsdWU7XG4gICAgdGhpcy5tb2RlbENoYW5nZS5lbWl0KHRoaXMubW9kZWwpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBuZXcgaXRlbSB0byB0aGUgbW9kZWxcbiAgICovXG4gIGFkZEFycmF5SXRlbShkYXRhVHlwZT86IEpzb25TY2hlbWFEYXRhVHlwZSk6IHZvaWQge1xuICAgIGxldCBzY2hlbWE7XG4gICAgaWYgKGRhdGFUeXBlKSB7XG4gICAgICBzY2hlbWEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHsgLi4uKHRoaXMuc2NoZW1hLml0ZW1zIGFzIG9iamVjdCksIC4uLmRhdGFUeXBlLnNjaGVtYSB9KSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNjaGVtYSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5zY2hlbWEuaXRlbXMpKTtcbiAgICB9XG5cbiAgICBpZiAoIXNjaGVtYS50eXBlKSB7XG4gICAgICBzY2hlbWEudHlwZSA9ICdvYmplY3QnO1xuICAgIH1cblxuICAgIGlmICghc2NoZW1hLiRtZXRhKSB7XG4gICAgICBzY2hlbWEuJG1ldGEgPSB7fTtcbiAgICB9XG5cbiAgICBpZiAoQXJyYXkuaXNBcnJheShzY2hlbWEudHlwZSkpIHtcbiAgICAgIHNjaGVtYS4kbWV0YS50eXBlID0gWy4uLnNjaGVtYS50eXBlXTtcbiAgICAgIHNjaGVtYS50eXBlID0gc2NoZW1hLnR5cGVbMF07XG4gICAgICBzY2hlbWEuJG1ldGEuY3VycmVudFR5cGUgPSBnZXRDdXJyZW50VHlwZShzY2hlbWEpO1xuICAgIH1cblxuICAgIGNvbnN0IHZhbHVlOiBhbnkgPSBjcmVhdGVWYWx1ZUZvclNjaGVtYShzY2hlbWEpO1xuXG4gICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMubW9kZWwucHVzaCh2YWx1ZSk7XG4gICAgICB0aGlzLnNjaGVtYXMucHVzaChzY2hlbWEpO1xuICAgIH1cblxuICAgIHRoaXMubW9kZWxDaGFuZ2UuZW1pdCh0aGlzLm1vZGVsKTtcbiAgICB0aGlzLnVwZGF0ZUljb25zKCk7XG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlcyBhbiBpdGVtIGZyb20gdGhlIGFycmF5XG4gICAqIEBwYXJhbSBpbmRleFxuICAgKi9cbiAgZGVsZXRlQXJyYXlJdGVtKGluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLm1vZGVsLnNwbGljZShpbmRleCwgMSk7XG4gICAgdGhpcy5zY2hlbWFzLnNwbGljZShpbmRleCwgMSk7XG4gICAgdGhpcy5tb2RlbCA9IFsuLi50aGlzLm1vZGVsXTtcbiAgICB0aGlzLnNjaGVtYXMgPSBbLi4udGhpcy5zY2hlbWFzXTtcbiAgICB0aGlzLm1vZGVsQ2hhbmdlLmVtaXQodGhpcy5tb2RlbCk7XG4gIH1cblxuICAvKipcbiAgICogVHJhY2sgQnkgZnVuY3Rpb24gZm9yIHRoZSBhcnJheSBpdHRpZXJhdG9yXG4gICAqIEBwYXJhbSBpbmRleFxuICAgKiBAcGFyYW0gdmFsdWVcbiAgICovXG4gIGFycmF5VHJhY2tCeShpbmRleDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICByZXR1cm4gaW5kZXg7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIHByb3BlcnR5XG4gICAqIEBwYXJhbSB0eXBlXG4gICAqL1xuICBjaGFuZ2VJdGVtVHlwZShpbmRleDogbnVtYmVyLCB0eXBlOiBzdHJpbmcpIHtcbiAgICBjb25zdCBzY2hlbWEgPSB0aGlzLnNjaGVtYXNbaW5kZXhdO1xuICAgIGNvbnN0IGRhdGFUeXBlID0gdGhpcy5kYXRhVHlwZU1hcFt0eXBlXTtcbiAgICBpZiAoZGF0YVR5cGUpIHtcbiAgICAgIGRlbGV0ZSBzY2hlbWEuZm9ybWF0O1xuICAgICAgc2NoZW1hLnR5cGUgPSBkYXRhVHlwZS5zY2hlbWEudHlwZTtcbiAgICAgIGlmIChkYXRhVHlwZS5zY2hlbWEuZm9ybWF0KSB7XG4gICAgICAgIHNjaGVtYS5mb3JtYXQgPSBkYXRhVHlwZS5zY2hlbWEuZm9ybWF0O1xuICAgICAgfVxuICAgICAgc2NoZW1hLiRtZXRhLmN1cnJlbnRUeXBlID0gZ2V0Q3VycmVudFR5cGUoc2NoZW1hKTtcbiAgICB9XG5cbiAgICBjb25zdCB2YWx1ZTogYW55ID0gY3JlYXRlVmFsdWVGb3JTY2hlbWEoc2NoZW1hKTtcbiAgICB0aGlzLm1vZGVsW2luZGV4XSA9IHZhbHVlO1xuXG4gICAgdGhpcy5tb2RlbENoYW5nZS5lbWl0KHRoaXMubW9kZWwpO1xuICAgIHRoaXMudXBkYXRlSWNvbnMoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbmZlcnMgdGhlIHNjaGVtYSB0eXBlIGZvciBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5XG4gICAqL1xuICBwcml2YXRlIGluaXRTY2hlbWFzVHlwZUJ5TW9kZWxWYWx1ZSgpOiB2b2lkIHtcbiAgICB0aGlzLnNjaGVtYXMgPSBbXTtcbiAgICB0aGlzLm1vZGVsLmZvckVhY2godmFsdWUgPT4ge1xuICAgICAgbGV0IHNjaGVtYSA9IGluZmVyVHlwZSh2YWx1ZSwgdGhpcy50eXBlQ2hlY2tPdmVycmlkZXMpO1xuXG4gICAgICBpZiAodGhpcy5zY2hlbWEuaXRlbXMpIHtcbiAgICAgICAgc2NoZW1hID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh7IC4uLih0aGlzLnNjaGVtYS5pdGVtcyBhcyBvYmplY3QpLCAuLi5zY2hlbWEgfSkpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnNjaGVtYXMucHVzaChzY2hlbWEpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgdGhlIGljb25zIGluIHRoZSBzY2hlbWFzXG4gICAqL1xuICBwcml2YXRlIHVwZGF0ZUljb25zKCk6IHZvaWQge1xuICAgIGZvciAoY29uc3Qgc2NoZW1hIG9mIHRoaXMuc2NoZW1hcykge1xuICAgICAgaWYgKCFzY2hlbWEuJG1ldGEpIHtcbiAgICAgICAgc2NoZW1hLiRtZXRhID0ge307XG4gICAgICB9XG4gICAgICBzY2hlbWEuJG1ldGEuaWNvbiA9IGdldEljb24oc2NoZW1hKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==