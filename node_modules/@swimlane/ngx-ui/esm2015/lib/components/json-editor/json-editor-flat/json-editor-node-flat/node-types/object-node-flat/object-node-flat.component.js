import { __decorate, __metadata } from "tslib";
import { Component, ViewEncapsulation, Input, ViewChild, TemplateRef, OnInit, ChangeDetectionStrategy, ChangeDetectorRef } from '@angular/core';
import { ObjectNode } from '../../../../node-types/object-node.component';
import { DialogService } from '../../../../../dialog/dialog.service';
import { jsonSchemaDataTypes, createValueForSchema } from '../../../../json-editor.helper';
import { moveItemInArray } from '@angular/cdk/drag-drop';
let ObjectNodeFlatComponent = class ObjectNodeFlatComponent extends ObjectNode {
    constructor(dialogService, cdr) {
        super(cdr);
        this.dialogService = dialogService;
        this.cdr = cdr;
        this.indentationArray = [];
        this.objectKeys = Object.keys;
    }
    ngOnInit() {
        if (this.schemaBuilderMode) {
            this.dataTypes = [...jsonSchemaDataTypes, ...this.formats];
        }
        setTimeout(() => {
            this.initSchemaProperties(this.schema);
            this.initSchemaProperties(this.schemaRef);
        });
        if (this.level > 0) {
            this.indentationArray = Array(this.level).fill(this.level);
        }
    }
    onUpdatePropertyName(options) {
        this.updatePropertyName(options.id, options.name);
    }
    onPropertyConfig(property, index) {
        this.dialogService.create({
            template: this.propertyConfigTmpl,
            context: {
                property,
                index,
                schema: this.schema,
                formats: this.formats
            },
            class: 'property-config-dialog'
        });
    }
    updateSchema(options) {
        const oldProperty = options.oldProperty;
        const newProperty = options.newProperty;
        const oldName = oldProperty.propertyName;
        const newName = newProperty.propertyName;
        if (newName !== oldName) {
            if (oldName in this.schema.properties) {
                this.updateSchemaPropertyName(this.schema, newName, oldName);
            }
            this.updateSchemaPropertyName(this.schemaRef, newName, oldName);
            this.updatePropertyName(options.newProperty.id, newName);
        }
        this.toggleRequiredValue(options.required, newName);
        this.schema.properties[newName] = newProperty;
        this.propertyIndex[options.newProperty.id] = newProperty;
        this.updateSchemaRefProperty(newProperty);
        if (newName !== oldName) {
            this.swapSchemaProperties(options.index);
        }
        if (oldProperty.type !== newProperty.type) {
            const value = createValueForSchema(newProperty);
            this.model[newProperty.propertyName] = value;
        }
        this.propertyIndex = Object.assign({}, this.propertyIndex);
        this.schemaChange.emit();
    }
    addProperty(dataType) {
        super.addProperty(dataType);
        this.updateSchemaRefProperty(this.propertyIndex[this.propertyId - 1]);
        this.schemaChange.emit();
    }
    deleteProperty(propName) {
        if (this.schemaBuilderMode) {
            delete this.schema.properties[propName];
            delete this.schemaRef.properties[propName];
            this.toggleRequiredValue(false, propName);
        }
        else if (!this.schema.required.includes(propName) && !(propName in this.schema.properties)) {
            delete this.schemaRef.properties[propName];
        }
        this.schemaChange.emit();
        super.deleteProperty(propName);
    }
    drop(event) {
        const propertyIndexValues = Object.values(this.propertyIndex);
        moveItemInArray(propertyIndexValues, event.previousIndex, event.currentIndex);
        let index = 0;
        for (const prop in this.propertyIndex) {
            this.propertyIndex[prop] = propertyIndexValues[index];
            this.propertyIndex[prop].id = parseInt(prop, 10);
            index += 1;
        }
        this.propertyIndex = Object.assign({}, this.propertyIndex);
        this.swapSchemaProperties(event.currentIndex, event.previousIndex);
    }
    swapSchemaProperties(currentIndex, previousIndex) {
        const propertiesIds = Object.keys(this.schemaRef.properties);
        if (previousIndex === undefined) {
            previousIndex = propertiesIds.length - 1;
        }
        moveItemInArray(propertiesIds, previousIndex, currentIndex);
        this.schemaRef.properties = propertiesIds.reduce((result, prop) => {
            result[prop] = this.schemaRef.properties[prop];
            return result;
        }, {});
        this.schemaChange.emit();
    }
    initSchemaProperties(schema) {
        if (schema) {
            schema.required = schema.required || [];
            schema.properties = schema.properties || {};
        }
    }
    updateSchemaRefProperty(prop) {
        this.schemaRef.properties[prop.propertyName] = Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({ type: prop.type }, (prop['format'] && { format: prop['format'] })), (prop['title'] && { title: prop['title'] })), (prop['items'] && { items: prop['items'] })), (prop['required'] && { required: prop['required'] })), (prop['properties'] && { properties: prop['properties'] })), (prop['enum'] && { enum: prop['enum'] })), (prop['default'] && { default: prop['default'] })), (prop['description'] && { description: prop['description'] })), (prop['nameEditable'] && { nameEditable: prop['nameEditable'] })), (prop['minimum'] && { minimum: prop['minimum'] })), (prop['maximum'] && { maximum: prop['maximum'] })), (prop['minLength'] && { minLength: prop['minLength'] })), (prop['maxLength'] && { maxLength: prop['maxLength'] })), (prop['minItems'] && { minItems: prop['minItems'] })), (prop['maxItems'] && { maxItems: prop['maxItems'] })), (prop['pattern'] && { pattern: prop['pattern'] }));
    }
    updateSchemaPropertyName(schema, newName, oldName) {
        this.updateRequiredProperties(schema, newName, oldName);
        schema.properties[newName] = schema.properties[oldName];
        delete schema.properties[oldName];
    }
    toggleRequiredValue(required, propertyName) {
        const requiredIndex = this.schema.required.indexOf(propertyName);
        if (requiredIndex >= 0 && !required) {
            this.schema.required.splice(requiredIndex, 1);
        }
        else if (requiredIndex < 0 && required) {
            this.schema.required.push(propertyName);
        }
        this.schemaRef.required = [...this.schema.required];
        this.updateRequiredCache();
    }
    updateRequiredProperties(schema, newName, oldName) {
        const requiredIndex = schema.required.indexOf(oldName);
        if (requiredIndex >= 0) {
            schema.required[requiredIndex] = newName;
        }
    }
};
ObjectNodeFlatComponent.ctorParameters = () => [
    { type: DialogService },
    { type: ChangeDetectorRef }
];
__decorate([
    ViewChild('propertyConfigTmpl', { static: false }),
    __metadata("design:type", TemplateRef)
], ObjectNodeFlatComponent.prototype, "propertyConfigTmpl", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], ObjectNodeFlatComponent.prototype, "level", void 0);
__decorate([
    Input(),
    __metadata("design:type", Boolean)
], ObjectNodeFlatComponent.prototype, "schemaBuilderMode", void 0);
__decorate([
    Input(),
    __metadata("design:type", Array)
], ObjectNodeFlatComponent.prototype, "formats", void 0);
__decorate([
    Input(),
    __metadata("design:type", Boolean)
], ObjectNodeFlatComponent.prototype, "compressed", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], ObjectNodeFlatComponent.prototype, "hideRoot", void 0);
ObjectNodeFlatComponent = __decorate([
    Component({
        selector: 'ngx-json-object-node-flat',
        template: "<div\n  class=\"object-node-flat\"\n  [hidden]=\"!expanded\"\n  cdkDropList\n  [cdkDropListDisabled]=\"!schemaBuilderMode\"\n  (cdkDropListDropped)=\"drop($event)\"\n>\n  <div\n    cdkDrag\n    cdkDragLockAxis=\"y\"\n    class=\"object-node-content\"\n    *ngFor=\"let prop of propertyIndex | objectValues; let index = index; trackBy: trackBy\"\n  >\n    <ngx-json-editor-node-flat\n      [model]=\"model[prop.propertyName]\"\n      (modelChange)=\"updateProp(prop.id, $event)\"\n      [schema]=\"prop\"\n      [schemaRef]=\"schemaRef && schemaRef.properties ? schemaRef.properties[prop.propertyName] : null\"\n      [required]=\"!!requiredCache[prop.propertyName]\"\n      [inline]=\"prop.type !== 'array' && prop.type !== 'object'\"\n      [path]=\"path + getPath(prop.propertyName)\"\n      [errors]=\"errors\"\n      [hideRoot]=\"hideRoot\"\n      [typeCheckOverrides]=\"typeCheckOverrides\"\n      [level]=\"level\"\n      [schemaBuilderMode]=\"schemaBuilderMode\"\n      [formats]=\"formats\"\n      [compressed]=\"compressed\"\n      [indentationArray]=\"indentationArray\"\n      (schemaChange)=\"schemaChange.emit(schemaRef)\"\n      (updatePropertyNameEvent)=\"onUpdatePropertyName($event)\"\n    >\n      <div class=\"node-options\" node-options>\n        <button\n          *ngIf=\"schemaBuilderMode\"\n          type=\"button\"\n          class=\"node-options-btn\"\n          (click)=\"onPropertyConfig(prop, index)\"\n        >\n          <i class=\"ngx-icon ngx-cog\"></i>\n        </button>\n        <ngx-dropdown [showCaret]=\"true\">\n          <ngx-dropdown-toggle>\n            <button type=\"button\" class=\"node-options-btn\">\n              <i class=\"ngx-icon ngx-dots-vert-round\"></i>\n            </button>\n          </ngx-dropdown-toggle>\n          <ngx-dropdown-menu class=\"ngx-dropdown-dark-outline align-right\">\n            <ul class=\"vertical-list\">\n              <li>\n                <button\n                  type=\"button\"\n                  (click)=\"deleteProperty(prop.propertyName)\"\n                  [disabled]=\"requiredCache[prop.propertyName] && !schemaBuilderMode\"\n                >\n                  Delete\n                </button>\n              </li>\n              <ng-container *ngIf=\"prop?.$meta?.type && !schemaBuilderMode\">\n                <li *ngFor=\"let type of prop?.$meta?.type\">\n                  <button\n                    type=\"button\"\n                    (click)=\"changePropertyType(prop, type)\"\n                    [disabled]=\"prop.$meta.currentType === type\"\n                  >\n                    Change type to {{ dataTypeMap[type].name }}\n                  </button>\n                </li>\n              </ng-container>\n            </ul>\n          </ngx-dropdown-menu>\n        </ngx-dropdown>\n      </div>\n      <div *ngIf=\"schemaBuilderMode\" class=\"drag-drop-handle\" cdkDragHandle>\n        <i class=\"ngx-icon ngx-handle\"></i>\n      </div>\n    </ngx-json-editor-node-flat>\n    <div\n      *cdkDragPlaceholder\n      class=\"indentation-placeholder\"\n      [ngStyle]=\"{ width: 'calc(100% + ' + level * 20 + 'px)' }\"\n    ></div>\n  </div>\n\n  <div class=\"add-button\" [class.compressed]=\"compressed\" [class.background]=\"hideRoot ? level > -1 : level\">\n    <span class=\"separator\" *ngFor=\"let separator of indentationArray\"></span>\n    <div class=\"indented-content\" [style.marginLeft]=\"hideRoot && level === 0 ? '20px' : '0'\">\n      <ngx-dropdown [showCaret]=\"true\">\n        <ngx-dropdown-toggle>\n          <button type=\"button\">\n            <i class=\"ngx-icon ngx-tree-expand\"></i>\n            <span>Add {{ objectKeys(propertyIndex).length ? 'a' : 'your first' }} property</span>\n          </button>\n        </ngx-dropdown-toggle>\n        <ngx-dropdown-menu class=\"ngx-dropdown-dark-outline\">\n          <ul class=\"vertical-list dropdown-column\" *ngIf=\"schema.properties && !schemaBuilderMode\">\n            <li *ngFor=\"let prop of schema.properties | keyvalue\" (click)=\"addSchemaProperty(prop.key)\">\n              <button [disabled]=\"model[prop.key] !== undefined\" type=\"button\">\n                {{ prop.value.title ? prop.value.title : prop.key }}\n              </button>\n            </li>\n          </ul>\n          <ul\n            class=\"vertical-list dropdown-column\"\n            *ngIf=\"!schema || schema.patternProperties || schema.additionalProperties !== false\"\n          >\n            <li *ngFor=\"let prop of schema.patternProperties | keyvalue\" (click)=\"addSchemaPatternProperty(prop.key)\">\n              <button type=\"button\">{{ prop.value.title ? prop.value.title : prop.key }}</button>\n            </li>\n            <ng-template [ngIf]=\"!schema || schema.additionalProperties !== false\">\n              <li *ngFor=\"let dataType of dataTypes\" (click)=\"addProperty(dataType)\">\n                <button type=\"button\">{{ dataType.name }}</button>\n              </li>\n            </ng-template>\n          </ul>\n        </ngx-dropdown-menu>\n      </ngx-dropdown>\n    </div>\n  </div>\n</div>\n\n<!-- Property Config Dialog -->\n<ng-template #propertyConfigTmpl let-context=\"context\">\n  <ngx-property-config\n    [property]=\"context.property\"\n    [index]=\"context.index\"\n    [schema]=\"context.schema\"\n    [formats]=\"context.formats\"\n    (updateSchema)=\"updateSchema($event)\"\n  >\n  </ngx-property-config>\n</ng-template>\n",
        encapsulation: ViewEncapsulation.None,
        changeDetection: ChangeDetectionStrategy.OnPush,
        styles: [".object-node-flat .object-node-content{display:-webkit-box;display:flex;margin-bottom:5px;position:relative}.object-node-flat .object-node-content ngx-json-editor-node-flat{-webkit-box-flex:1;flex:1}.object-node-flat .add-button{height:100px;position:relative;display:-webkit-box;display:flex}.object-node-flat .add-button ngx-dropdown{padding-bottom:0}.object-node-flat .compressed.add-button{max-height:80px}.object-node-flat .background.add-button{background-color:rgba(49,56,71,.4);padding:7px 7px 7px 0;height:120px}.object-node-flat .add-button .indented-content{border:2px dotted rgba(59,68,87,.5);width:100%;display:-webkit-box;display:flex;-webkit-box-pack:center;justify-content:center;-webkit-box-align:center;align-items:center;color:#909cb4}.object-node-flat .add-button .indented-content button{display:-webkit-box;display:flex}.object-node-flat .add-button .indented-content button i{font-size:18px}.object-node-flat .add-button .indented-content button span{font-size:14px;margin-left:10px}.object-node-flat .add-button .indented-content .ngx-dropdown-menu{white-space:nowrap;margin-top:10px}.object-node-flat .add-button .indented-content .ngx-dropdown-menu .dropdown-column{vertical-align:top;display:inline-block;min-width:150px}.object-node-flat .add-button .indented-content .ngx-dropdown-menu .dropdown-column:nth-child(2){border-left:1px solid #505c75}.indentation-placeholder{border-radius:2px 0 0 2px;display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;background-color:rgba(49,56,71,.4)}.separator{background-color:#3b4457;opacity:.5;border-radius:2px;width:1px;height:calc(100% - 4px);margin-right:20px}.separator:first-child{margin-left:20px}.object-node-flat{margin-top:5px}.cdk-drag-preview .indentation{opacity:.5}.cdk-drag-preview .add-button{display:none}.cdk-drag-animating,.object-node-flat.cdk-drop-list-dragging .object-node-content:not(.cdk-drag-placeholder){-webkit-transition:-webkit-transform 250ms cubic-bezier(0,0,.2,1);transition:transform 250ms cubic-bezier(0,0,.2,1);transition:transform 250ms cubic-bezier(0,0,.2,1),-webkit-transform 250ms cubic-bezier(0,0,.2,1)}.indentation-placeholder{position:relative;height:117px;margin-bottom:5px;-webkit-transition:-webkit-transform 250ms cubic-bezier(0,0,.2,1);transition:transform 250ms cubic-bezier(0,0,.2,1),-webkit-transform 250ms cubic-bezier(0,0,.2,1)}"]
    }),
    __metadata("design:paramtypes", [DialogService, ChangeDetectorRef])
], ObjectNodeFlatComponent);
export { ObjectNodeFlatComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JqZWN0LW5vZGUtZmxhdC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ac3dpbWxhbmUvbmd4LXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvanNvbi1lZGl0b3IvanNvbi1lZGl0b3ItZmxhdC9qc29uLWVkaXRvci1ub2RlLWZsYXQvbm9kZS10eXBlcy9vYmplY3Qtbm9kZS1mbGF0L29iamVjdC1ub2RlLWZsYXQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULGlCQUFpQixFQUNqQixLQUFLLEVBQ0wsU0FBUyxFQUNULFdBQVcsRUFDWCxNQUFNLEVBQ04sdUJBQXVCLEVBQ3ZCLGlCQUFpQixFQUNsQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sOENBQThDLENBQUM7QUFDMUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ3JFLE9BQU8sRUFFTCxtQkFBbUIsRUFFbkIsb0JBQW9CLEVBQ3JCLE1BQU0sZ0NBQWdDLENBQUM7QUFDeEMsT0FBTyxFQUFlLGVBQWUsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBVXRFLElBQWEsdUJBQXVCLEdBQXBDLE1BQWEsdUJBQXdCLFNBQVEsVUFBVTtJQWlCckQsWUFBb0IsYUFBNEIsRUFBWSxHQUFzQjtRQUNoRixLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFETyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUFZLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBSmxGLHFCQUFnQixHQUFhLEVBQUUsQ0FBQztRQUVoQyxlQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztJQUl6QixDQUFDO0lBRUQsUUFBUTtRQUNOLElBQUksSUFBSSxDQUFDLGlCQUFpQixFQUFFO1lBQzFCLElBQUksQ0FBQyxTQUFTLEdBQUcsQ0FBQyxHQUFHLG1CQUFtQixFQUFFLEdBQUcsSUFBSSxDQUFDLE9B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O0lBQVIsS0FBSyxFQUFFOzt5REFBVTtBQVhQLHVCQUF1QjtJQVBuQyxTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsMkJBQTJCO1FBQ3JDLHExS0FBZ0Q7UUFFaEQsYUFBYSxFQUFFLGlCQUFpQixDQUFDLElBQUk7UUFDckMsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07O0tBQ2hELENBQUM7cUNBa0JtQyxhQUFhLEVBQWlCLGlCQUFpQjtHQWpCdkUsdUJBQXVCLENBbU1uQztTQW5NWSx1QkFBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIFZpZXdFbmNhcHN1bGF0aW9uLFxuICBJbnB1dCxcbiAgVmlld0NoaWxkLFxuICBUZW1wbGF0ZVJlZixcbiAgT25Jbml0LFxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgQ2hhbmdlRGV0ZWN0b3JSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYmplY3ROb2RlIH0gZnJvbSAnLi4vLi4vLi4vLi4vbm9kZS10eXBlcy9vYmplY3Qtbm9kZS5jb21wb25lbnQnO1xuaW1wb3J0IHsgRGlhbG9nU2VydmljZSB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL2RpYWxvZy9kaWFsb2cuc2VydmljZSc7XG5pbXBvcnQge1xuICBKc29uU2NoZW1hRGF0YVR5cGUsXG4gIGpzb25TY2hlbWFEYXRhVHlwZXMsXG4gIEpTT05FZGl0b3JTY2hlbWEsXG4gIGNyZWF0ZVZhbHVlRm9yU2NoZW1hXG59IGZyb20gJy4uLy4uLy4uLy4uL2pzb24tZWRpdG9yLmhlbHBlcic7XG5pbXBvcnQgeyBDZGtEcmFnRHJvcCwgbW92ZUl0ZW1JbkFycmF5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2RyYWctZHJvcCc7XG5pbXBvcnQgeyBQcm9wZXJ0eUNvbmZpZ09wdGlvbnMsIFByb3BlcnR5Q29uZmlnQ29tcG9uZW50IH0gZnJvbSAnLi4vcHJvcGVydHktY29uZmlnL3Byb3BlcnR5LWNvbmZpZy5jb21wb25lbnQnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ3gtanNvbi1vYmplY3Qtbm9kZS1mbGF0JyxcbiAgdGVtcGxhdGVVcmw6ICcuL29iamVjdC1ub2RlLWZsYXQuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9vYmplY3Qtbm9kZS1mbGF0LmNvbXBvbmVudC5zY3NzJ10sXG4gIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmUsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoXG59KVxuZXhwb3J0IGNsYXNzIE9iamVjdE5vZGVGbGF0Q29tcG9uZW50IGV4dGVuZHMgT2JqZWN0Tm9kZSBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIEBWaWV3Q2hpbGQoJ3Byb3BlcnR5Q29uZmlnVG1wbCcsIHsgc3RhdGljOiBmYWxzZSB9KSBwcm9wZXJ0eUNvbmZpZ1RtcGw6IFRlbXBsYXRlUmVmPFByb3BlcnR5Q29uZmlnQ29tcG9uZW50PjtcblxuICBASW5wdXQoKSBsZXZlbDogbnVtYmVyO1xuXG4gIEBJbnB1dCgpIHNjaGVtYUJ1aWxkZXJNb2RlOiBib29sZWFuO1xuXG4gIEBJbnB1dCgpIGZvcm1hdHM6IEpzb25TY2hlbWFEYXRhVHlwZVtdO1xuXG4gIEBJbnB1dCgpIGNvbXByZXNzZWQ6IGJvb2xlYW47XG5cbiAgQElucHV0KCkgaGlkZVJvb3Q7XG5cbiAgaW5kZW50YXRpb25BcnJheTogbnVtYmVyW10gPSBbXTtcblxuICBvYmplY3RLZXlzID0gT2JqZWN0LmtleXM7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBkaWFsb2dTZXJ2aWNlOiBEaWFsb2dTZXJ2aWNlLCBwcm90ZWN0ZWQgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZikge1xuICAgIHN1cGVyKGNkcik7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICBpZiAodGhpcy5zY2hlbWFCdWlsZGVyTW9kZSkge1xuICAgICAgdGhpcy5kYXRhVHlwZXMgPSBbLi4uanNvblNjaGVtYURhdGFUeXBlcywgLi4udGhpcy5mb3JtYXRzXTtcbiAgICB9XG5cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuaW5pdFNjaGVtYVByb3BlcnRpZXModGhpcy5zY2hlbWEpO1xuICAgICAgdGhpcy5pbml0U2NoZW1hUHJvcGVydGllcyh0aGlzLnNjaGVtYVJlZik7XG4gICAgfSk7XG5cbiAgICBpZiAodGhpcy5sZXZlbCA+IDApIHtcbiAgICAgIHRoaXMuaW5kZW50YXRpb25BcnJheSA9IEFycmF5KHRoaXMubGV2ZWwpLmZpbGwodGhpcy5sZXZlbCk7XG4gICAgfVxuICB9XG5cbiAgb25VcGRhdGVQcm9wZXJ0eU5hbWUob3B0aW9uczogeyBpZDogc3RyaW5nOyBuYW1lOiBzdHJpbmcgfSk6IHZvaWQge1xuICAgIHRoaXMudXBkYXRlUHJvcGVydHlOYW1lKG9wdGlvbnMuaWQsIG9wdGlvbnMubmFtZSk7XG4gIH1cblxuICBvblByb3BlcnR5Q29uZmlnKHByb3BlcnR5OiBKU09ORWRpdG9yU2NoZW1hLCBpbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5kaWFsb2dTZXJ2aWNlLmNyZWF0ZSh7XG4gICAgICB0ZW1wbGF0ZTogdGhpcy5wcm9wZXJ0eUNvbmZpZ1RtcGwsXG4gICAgICBjb250ZXh0OiB7XG4gICAgICAgIHByb3BlcnR5LFxuICAgICAgICBpbmRleCxcbiAgICAgICAgc2NoZW1hOiB0aGlzLnNjaGVtYSxcbiAgICAgICAgZm9ybWF0czogdGhpcy5mb3JtYXRzXG4gICAgICB9LFxuICAgICAgY2xhc3M6ICdwcm9wZXJ0eS1jb25maWctZGlhbG9nJ1xuICAgIH0pO1xuICB9XG5cbiAgdXBkYXRlU2NoZW1hKG9wdGlvbnM6IFByb3BlcnR5Q29uZmlnT3B0aW9ucyk6IHZvaWQge1xuICAgIGNvbnN0IG9sZFByb3BlcnR5ID0gb3B0aW9ucy5vbGRQcm9wZXJ0eTtcbiAgICBjb25zdCBuZXdQcm9wZXJ0eSA9IG9wdGlvbnMubmV3UHJvcGVydHk7XG5cbiAgICBjb25zdCBvbGROYW1lID0gb2xkUHJvcGVydHkucHJvcGVydHlOYW1lO1xuICAgIGNvbnN0IG5ld05hbWUgPSBuZXdQcm9wZXJ0eS5wcm9wZXJ0eU5hbWU7XG5cbiAgICBpZiAobmV3TmFtZSAhPT0gb2xkTmFtZSkge1xuICAgICAgaWYgKG9sZE5hbWUgaW4gdGhpcy5zY2hlbWEucHJvcGVydGllcykge1xuICAgICAgICB0aGlzLnVwZGF0ZVNjaGVtYVByb3BlcnR5TmFtZSh0aGlzLnNjaGVtYSwgbmV3TmFtZSwgb2xkTmFtZSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMudXBkYXRlU2NoZW1hUHJvcGVydHlOYW1lKHRoaXMuc2NoZW1hUmVmLCBuZXdOYW1lLCBvbGROYW1lKTtcbiAgICAgIHRoaXMudXBkYXRlUHJvcGVydHlOYW1lKG9wdGlvbnMubmV3UHJvcGVydHkuaWQsIG5ld05hbWUpO1xuICAgIH1cblxuICAgIHRoaXMudG9nZ2xlUmVxdWlyZWRWYWx1ZShvcHRpb25zLnJlcXVpcmVkLCBuZXdOYW1lKTtcblxuICAgIHRoaXMuc2NoZW1hLnByb3BlcnRpZXNbbmV3TmFtZV0gPSBuZXdQcm9wZXJ0eTtcbiAgICB0aGlzLnByb3BlcnR5SW5kZXhbb3B0aW9ucy5uZXdQcm9wZXJ0eS5pZF0gPSBuZXdQcm9wZXJ0eTtcbiAgICB0aGlzLnVwZGF0ZVNjaGVtYVJlZlByb3BlcnR5KG5ld1Byb3BlcnR5KTtcblxuICAgIGlmIChuZXdOYW1lICE9PSBvbGROYW1lKSB7XG4gICAgICB0aGlzLnN3YXBTY2hlbWFQcm9wZXJ0aWVzKG9wdGlvbnMuaW5kZXgpO1xuICAgIH1cblxuICAgIGlmIChvbGRQcm9wZXJ0eS50eXBlICE9PSBuZXdQcm9wZXJ0eS50eXBlKSB7XG4gICAgICBjb25zdCB2YWx1ZTogYW55ID0gY3JlYXRlVmFsdWVGb3JTY2hlbWEobmV3UHJvcGVydHkpO1xuICAgICAgdGhpcy5tb2RlbFtuZXdQcm9wZXJ0eS5wcm9wZXJ0eU5hbWVdID0gdmFsdWU7XG4gICAgfVxuXG4gICAgdGhpcy5wcm9wZXJ0eUluZGV4ID0geyAuLi50aGlzLnByb3BlcnR5SW5kZXggfTtcbiAgICB0aGlzLnNjaGVtYUNoYW5nZS5lbWl0KCk7XG4gIH1cblxuICBhZGRQcm9wZXJ0eShkYXRhVHlwZTogSnNvblNjaGVtYURhdGFUeXBlKTogdm9pZCB7XG4gICAgc3VwZXIuYWRkUHJvcGVydHkoZGF0YVR5cGUpO1xuXG4gICAgdGhpcy51cGRhdGVTY2hlbWFSZWZQcm9wZXJ0eSh0aGlzLnByb3BlcnR5SW5kZXhbdGhpcy5wcm9wZXJ0eUlkIC0gMV0pO1xuICAgIHRoaXMuc2NoZW1hQ2hhbmdlLmVtaXQoKTtcbiAgfVxuXG4gIGRlbGV0ZVByb3BlcnR5KHByb3BOYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5zY2hlbWFCdWlsZGVyTW9kZSkge1xuICAgICAgZGVsZXRlIHRoaXMuc2NoZW1hLnByb3BlcnRpZXNbcHJvcE5hbWVdO1xuICAgICAgZGVsZXRlIHRoaXMuc2NoZW1hUmVmLnByb3BlcnRpZXNbcHJvcE5hbWVdO1xuICAgICAgdGhpcy50b2dnbGVSZXF1aXJlZFZhbHVlKGZhbHNlLCBwcm9wTmFtZSk7XG4gICAgfSBlbHNlIGlmICghdGhpcy5zY2hlbWEucmVxdWlyZWQuaW5jbHVkZXMocHJvcE5hbWUpICYmICEocHJvcE5hbWUgaW4gdGhpcy5zY2hlbWEucHJvcGVydGllcykpIHtcbiAgICAgIGRlbGV0ZSB0aGlzLnNjaGVtYVJlZi5wcm9wZXJ0aWVzW3Byb3BOYW1lXTtcbiAgICB9XG5cbiAgICB0aGlzLnNjaGVtYUNoYW5nZS5lbWl0KCk7XG4gICAgc3VwZXIuZGVsZXRlUHJvcGVydHkocHJvcE5hbWUpO1xuICB9XG5cbiAgZHJvcChldmVudDogQ2RrRHJhZ0Ryb3A8c3RyaW5nW10+KTogdm9pZCB7XG4gICAgY29uc3QgcHJvcGVydHlJbmRleFZhbHVlcyA9IE9iamVjdC52YWx1ZXModGhpcy5wcm9wZXJ0eUluZGV4KTtcblxuICAgIG1vdmVJdGVtSW5BcnJheShwcm9wZXJ0eUluZGV4VmFsdWVzLCBldmVudC5wcmV2aW91c0luZGV4LCBldmVudC5jdXJyZW50SW5kZXgpO1xuXG4gICAgbGV0IGluZGV4ID0gMDtcbiAgICBmb3IgKGNvbnN0IHByb3AgaW4gdGhpcy5wcm9wZXJ0eUluZGV4KSB7XG4gICAgICB0aGlzLnByb3BlcnR5SW5kZXhbcHJvcF0gPSBwcm9wZXJ0eUluZGV4VmFsdWVzW2luZGV4XTtcbiAgICAgIHRoaXMucHJvcGVydHlJbmRleFtwcm9wXS5pZCA9IHBhcnNlSW50KHByb3AsIDEwKTtcbiAgICAgIGluZGV4ICs9IDE7XG4gICAgfVxuXG4gICAgdGhpcy5wcm9wZXJ0eUluZGV4ID0geyAuLi50aGlzLnByb3BlcnR5SW5kZXggfTtcblxuICAgIHRoaXMuc3dhcFNjaGVtYVByb3BlcnRpZXMoZXZlbnQuY3VycmVudEluZGV4LCBldmVudC5wcmV2aW91c0luZGV4KTtcbiAgfVxuXG4gIHByaXZhdGUgc3dhcFNjaGVtYVByb3BlcnRpZXMoY3VycmVudEluZGV4OiBudW1iZXIsIHByZXZpb3VzSW5kZXg/OiBudW1iZXIpOiB2b2lkIHtcbiAgICBjb25zdCBwcm9wZXJ0aWVzSWRzID0gT2JqZWN0LmtleXModGhpcy5zY2hlbWFSZWYucHJvcGVydGllcyk7XG5cbiAgICBpZiAocHJldmlvdXNJbmRleCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBwcmV2aW91c0luZGV4ID0gcHJvcGVydGllc0lkcy5sZW5ndGggLSAxO1xuICAgIH1cblxuICAgIG1vdmVJdGVtSW5BcnJheShwcm9wZXJ0aWVzSWRzLCBwcmV2aW91c0luZGV4LCBjdXJyZW50SW5kZXgpO1xuXG4gICAgdGhpcy5zY2hlbWFSZWYucHJvcGVydGllcyA9IHByb3BlcnRpZXNJZHMucmVkdWNlKChyZXN1bHQsIHByb3ApID0+IHtcbiAgICAgIHJlc3VsdFtwcm9wXSA9IHRoaXMuc2NoZW1hUmVmLnByb3BlcnRpZXNbcHJvcF07XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sIHt9KTtcblxuICAgIHRoaXMuc2NoZW1hQ2hhbmdlLmVtaXQoKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdFNjaGVtYVByb3BlcnRpZXMoc2NoZW1hOiBKU09ORWRpdG9yU2NoZW1hKTogdm9pZCB7XG4gICAgaWYgKHNjaGVtYSkge1xuICAgICAgc2NoZW1hLnJlcXVpcmVkID0gc2NoZW1hLnJlcXVpcmVkIHx8IFtdO1xuICAgICAgc2NoZW1hLnByb3BlcnRpZXMgPSBzY2hlbWEucHJvcGVydGllcyB8fCB7fTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVNjaGVtYVJlZlByb3BlcnR5KHByb3A6IGFueSk6IHZvaWQge1xuICAgIHRoaXMuc2NoZW1hUmVmLnByb3BlcnRpZXNbcHJvcC5wcm9wZXJ0eU5hbWVdID0ge1xuICAgICAgdHlwZTogcHJvcC50eXBlLFxuICAgICAgLi4uKHByb3BbJ2Zvcm1hdCddICYmIHsgZm9ybWF0OiBwcm9wWydmb3JtYXQnXSB9KSxcbiAgICAgIC4uLihwcm9wWyd0aXRsZSddICYmIHsgdGl0bGU6IHByb3BbJ3RpdGxlJ10gfSksXG4gICAgICAuLi4ocHJvcFsnaXRlbXMnXSAmJiB7IGl0ZW1zOiBwcm9wWydpdGVtcyddIH0pLFxuICAgICAgLi4uKHByb3BbJ3JlcXVpcmVkJ10gJiYgeyByZXF1aXJlZDogcHJvcFsncmVxdWlyZWQnXSB9KSxcbiAgICAgIC4uLihwcm9wWydwcm9wZXJ0aWVzJ10gJiYgeyBwcm9wZXJ0aWVzOiBwcm9wWydwcm9wZXJ0aWVzJ10gfSksXG4gICAgICAuLi4ocHJvcFsnZW51bSddICYmIHsgZW51bTogcHJvcFsnZW51bSddIH0pLFxuICAgICAgLi4uKHByb3BbJ2RlZmF1bHQnXSAmJiB7IGRlZmF1bHQ6IHByb3BbJ2RlZmF1bHQnXSB9KSxcbiAgICAgIC4uLihwcm9wWydkZXNjcmlwdGlvbiddICYmIHsgZGVzY3JpcHRpb246IHByb3BbJ2Rlc2NyaXB0aW9uJ10gfSksXG4gICAgICAuLi4ocHJvcFsnbmFtZUVkaXRhYmxlJ10gJiYgeyBuYW1lRWRpdGFibGU6IHByb3BbJ25hbWVFZGl0YWJsZSddIH0pLFxuICAgICAgLi4uKHByb3BbJ21pbmltdW0nXSAmJiB7IG1pbmltdW06IHByb3BbJ21pbmltdW0nXSB9KSxcbiAgICAgIC4uLihwcm9wWydtYXhpbXVtJ10gJiYgeyBtYXhpbXVtOiBwcm9wWydtYXhpbXVtJ10gfSksXG4gICAgICAuLi4ocHJvcFsnbWluTGVuZ3RoJ10gJiYgeyBtaW5MZW5ndGg6IHByb3BbJ21pbkxlbmd0aCddIH0pLFxuICAgICAgLi4uKHByb3BbJ21heExlbmd0aCddICYmIHsgbWF4TGVuZ3RoOiBwcm9wWydtYXhMZW5ndGgnXSB9KSxcbiAgICAgIC4uLihwcm9wWydtaW5JdGVtcyddICYmIHsgbWluSXRlbXM6IHByb3BbJ21pbkl0ZW1zJ10gfSksXG4gICAgICAuLi4ocHJvcFsnbWF4SXRlbXMnXSAmJiB7IG1heEl0ZW1zOiBwcm9wWydtYXhJdGVtcyddIH0pLFxuICAgICAgLi4uKHByb3BbJ3BhdHRlcm4nXSAmJiB7IHBhdHRlcm46IHByb3BbJ3BhdHRlcm4nXSB9KVxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVNjaGVtYVByb3BlcnR5TmFtZShzY2hlbWE6IEpTT05FZGl0b3JTY2hlbWEsIG5ld05hbWU6IHN0cmluZywgb2xkTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy51cGRhdGVSZXF1aXJlZFByb3BlcnRpZXMoc2NoZW1hLCBuZXdOYW1lLCBvbGROYW1lKTtcbiAgICBzY2hlbWEucHJvcGVydGllc1tuZXdOYW1lXSA9IHNjaGVtYS5wcm9wZXJ0aWVzW29sZE5hbWVdO1xuICAgIGRlbGV0ZSBzY2hlbWEucHJvcGVydGllc1tvbGROYW1lXTtcbiAgfVxuXG4gIHByaXZhdGUgdG9nZ2xlUmVxdWlyZWRWYWx1ZShyZXF1aXJlZDogYm9vbGVhbiwgcHJvcGVydHlOYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCByZXF1aXJlZEluZGV4ID0gdGhpcy5zY2hlbWEucmVxdWlyZWQuaW5kZXhPZihwcm9wZXJ0eU5hbWUpO1xuICAgIGlmIChyZXF1aXJlZEluZGV4ID49IDAgJiYgIXJlcXVpcmVkKSB7XG4gICAgICB0aGlzLnNjaGVtYS5yZXF1aXJlZC5zcGxpY2UocmVxdWlyZWRJbmRleCwgMSk7XG4gICAgfSBlbHNlIGlmIChyZXF1aXJlZEluZGV4IDwgMCAmJiByZXF1aXJlZCkge1xuICAgICAgdGhpcy5zY2hlbWEucmVxdWlyZWQucHVzaChwcm9wZXJ0eU5hbWUpO1xuICAgIH1cblxuICAgIHRoaXMuc2NoZW1hUmVmLnJlcXVpcmVkID0gWy4uLnRoaXMuc2NoZW1hLnJlcXVpcmVkXTtcbiAgICB0aGlzLnVwZGF0ZVJlcXVpcmVkQ2FjaGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlUmVxdWlyZWRQcm9wZXJ0aWVzKHNjaGVtYTogSlNPTkVkaXRvclNjaGVtYSwgbmV3TmFtZTogc3RyaW5nLCBvbGROYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCByZXF1aXJlZEluZGV4ID0gc2NoZW1hLnJlcXVpcmVkLmluZGV4T2Yob2xkTmFtZSk7XG4gICAgaWYgKHJlcXVpcmVkSW5kZXggPj0gMCkge1xuICAgICAgc2NoZW1hLnJlcXVpcmVkW3JlcXVpcmVkSW5kZXhdID0gbmV3TmFtZTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==