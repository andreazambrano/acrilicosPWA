import { __decorate, __metadata } from "tslib";
import { Input, EventEmitter, Output, TemplateRef, ViewChild } from '@angular/core';
import { createValueForSchema, inferType } from './json-editor.helper';
export class JsonEditorNode {
    constructor(dialogMngr) {
        this.dialogMngr = dialogMngr;
        this.required = false;
        this.inline = false;
        this.path = '';
        this.modelChange = new EventEmitter();
        this.schemaChange = new EventEmitter();
        this.requiredCache = {};
        this.expanded = true;
        this.valid = true;
        this.childrenValid = true;
        this.editorConfig = {
            lineNumbers: true,
            theme: 'dracula',
            mode: {
                label: 'Javascript',
                name: 'javascript',
                json: true
            }
        };
        this.editorModel = '';
        this.editorVisible = true;
        this.editorModes = [
            {
                label: 'Javascript',
                name: 'javascript',
                json: true
            },
            {
                label: 'YAML',
                name: 'yaml'
            },
            {
                label: 'Python',
                name: 'python'
            },
            {
                label: 'Powershell',
                name: 'powershell'
            },
            {
                label: 'HTML',
                name: 'htmlmixed'
            }
        ];
    }
    ngOnInit() {
        if (!this.schema) {
            this.schema = Object.assign({}, inferType(this.model, this.typeCheckOverrides));
        }
        if (this.schema.required) {
            for (const prop of this.schema.required) {
                this.requiredCache[prop] = true;
            }
        }
        if (Array.isArray(this.schema.type) && this.schema.type.length > 0) {
            if (!this.schema.$meta) {
                this.schema.$meta = {};
            }
            this.schema.$meta.type = [...this.schema.type];
            if (this.model !== undefined) {
                this.schema = Object.assign(Object.assign({}, this.schema), inferType(this.model, this.typeCheckOverrides, this.schema.$meta.type));
            }
            else {
                this.schema.type = this.schema.type[0];
                this.schema.$meta.currentType = this.schema.type;
            }
        }
        setTimeout(() => {
            this.initModel();
        });
    }
    ngOnChanges(changes) {
        if (changes.errors) {
            this.processErrors();
        }
    }
    /**
     * Inits the model if it is not defined
     */
    initModel() {
        if (this.model !== undefined) {
            return;
        }
        if (!this.schema) {
            return;
        }
        const value = createValueForSchema(this.schema);
        if (value !== undefined) {
            this.updateModel(value);
        }
    }
    /**
     * Process the errors input to figure out whether it or any of its children are invalid
     */
    processErrors() {
        this.ownErrors = [];
        this.childrenErrors = [];
        if (this.errors && this.errors.length) {
            this.ownErrors = this.errors.filter(e => {
                return e.dataPath === this.path;
            });
            this.childrenErrors = this.errors.filter(e => {
                return e.dataPath.startsWith(this.path);
            });
        }
        this.childrenValid = this.childrenErrors.length === 0;
        this.valid = this.ownErrors.length === 0;
    }
    /**
     * Updates the whole model and emits the change event
     * @param value
     */
    updateModel(value) {
        this.model = value;
        this.modelChange.emit(this.model);
    }
    /**
     * Expand click event
     */
    onExpandClick() {
        this.expanded = !this.expanded;
    }
    /**
     * Opens the code editor dialog
     */
    openCodeEditor() {
        this.editorModel = this.model;
        this.editorDialog = this.dialogMngr.create({ template: this.codeEditorTpl, class: 'code-editor-dialog' });
    }
    /**
     * Closes the code editor dialog
     */
    closeCodeEditor() {
        this.dialogMngr.destroy(this.editorDialog);
    }
    /**
     * Sets the editor mode and refreshes the editor
     */
    selectEditorMode(modeName) {
        this.editorConfig.mode.name = modeName;
        this.editorConfig = Object.assign({}, this.editorConfig);
        this.editorVisible = false;
        setTimeout(() => {
            this.editorVisible = true;
        });
    }
}
__decorate([
    Input(),
    __metadata("design:type", Object)
], JsonEditorNode.prototype, "schema", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], JsonEditorNode.prototype, "model", void 0);
__decorate([
    Input(),
    __metadata("design:type", Boolean)
], JsonEditorNode.prototype, "required", void 0);
__decorate([
    Input(),
    __metadata("design:type", Boolean)
], JsonEditorNode.prototype, "inline", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], JsonEditorNode.prototype, "path", void 0);
__decorate([
    Input(),
    __metadata("design:type", Array)
], JsonEditorNode.prototype, "errors", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], JsonEditorNode.prototype, "typeCheckOverrides", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], JsonEditorNode.prototype, "modelChange", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], JsonEditorNode.prototype, "schemaChange", void 0);
__decorate([
    ViewChild('codeEditorTpl'),
    __metadata("design:type", TemplateRef)
], JsonEditorNode.prototype, "codeEditorTpl", void 0);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianNvbi1lZGl0b3Itbm9kZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bzd2ltbGFuZS9uZ3gtdWkvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9qc29uLWVkaXRvci9qc29uLWVkaXRvci1ub2RlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsS0FBSyxFQUNMLFlBQVksRUFDWixNQUFNLEVBSU4sV0FBVyxFQUNYLFNBQVMsRUFFVixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsU0FBUyxFQUFvQixNQUFNLHNCQUFzQixDQUFDO0FBSXpGLE1BQU0sT0FBTyxjQUFjO0lBbUV6QixZQUFtQixVQUF5QjtRQUF6QixlQUFVLEdBQVYsVUFBVSxDQUFlO1FBOURuQyxhQUFRLEdBQVksS0FBSyxDQUFDO1FBRTFCLFdBQU0sR0FBWSxLQUFLLENBQUM7UUFFeEIsU0FBSSxHQUFXLEVBQUUsQ0FBQztRQU1qQixnQkFBVyxHQUFzQixJQUFJLFlBQVksRUFBRSxDQUFDO1FBRXBELGlCQUFZLEdBQW1DLElBQUksWUFBWSxFQUFFLENBQUM7UUFJNUUsa0JBQWEsR0FBUSxFQUFFLENBQUM7UUFDeEIsYUFBUSxHQUFZLElBQUksQ0FBQztRQUd6QixVQUFLLEdBQVksSUFBSSxDQUFDO1FBR3RCLGtCQUFhLEdBQVksSUFBSSxDQUFDO1FBRzlCLGlCQUFZLEdBQUc7WUFDYixXQUFXLEVBQUUsSUFBSTtZQUNqQixLQUFLLEVBQUUsU0FBUztZQUNoQixJQUFJLEVBQUU7Z0JBQ0osS0FBSyxFQUFFLFlBQVk7Z0JBQ25CLElBQUksRUFBRSxZQUFZO2dCQUNsQixJQUFJLEVBQUUsSUFBSTthQUNYO1NBQ0YsQ0FBQztRQUNGLGdCQUFXLEdBQVcsRUFBRSxDQUFDO1FBQ3pCLGtCQUFhLEdBQVksSUFBSSxDQUFDO1FBRTlCLGdCQUFXLEdBQVU7WUFDbkI7Z0JBQ0UsS0FBSyxFQUFFLFlBQVk7Z0JBQ25CLElBQUksRUFBRSxZQUFZ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QyxDQUFDO0lBQzVHLENBQUM7SUFFRDs7T0FFRztJQUNILGVBQWU7UUFDYixJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVEOztPQUVHO0lBQ0gsZ0JBQWdCLENBQUMsUUFBZ0I7UUFDL0IsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQztRQUN2QyxJQUFJLENBQUMsWUFBWSxxQkFBUSxJQUFJLENBQUMsWUFBWSxDQUFFLENBQUM7UUFDN0MsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7UUFFM0IsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNkLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBL0xVO0lBQVIsS0FBSyxFQUFFOzs4Q0FBMEI7QUFFekI7SUFBUixLQUFLLEVBQUU7OzZDQUFZO0FBRVg7SUFBUixLQUFLLEVBQUU7O2dEQUEyQjtBQUUxQjtJQUFSLEtBQUssRUFBRTs7OENBQXlCO0FBRXhCO0lBQVIsS0FBSyxFQUFFOzs0Q0FBbUI7QUFFbEI7SUFBUixLQUFLLEVBQUU7OzhDQUFlO0FBRWQ7SUFBUixLQUFLLEVBQUU7OzBEQUEwQjtBQUV4QjtJQUFULE1BQU0sRUFBRTs4QkFBYyxZQUFZO21EQUEyQjtBQUVwRDtJQUFULE1BQU0sRUFBRTs4QkFBZSxZQUFZO29EQUF3QztBQUVoRDtJQUEzQixTQUFTLENBQUMsZUFBZSxDQUFDOzhCQUFnQixXQUFXO3FEQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5wdXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgT3V0cHV0LFxuICBPbkluaXQsXG4gIE9uQ2hhbmdlcyxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgVGVtcGxhdGVSZWYsXG4gIFZpZXdDaGlsZCxcbiAgQ29tcG9uZW50UmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBjcmVhdGVWYWx1ZUZvclNjaGVtYSwgaW5mZXJUeXBlLCBKU09ORWRpdG9yU2NoZW1hIH0gZnJvbSAnLi9qc29uLWVkaXRvci5oZWxwZXInO1xuaW1wb3J0IHsgRGlhbG9nQ29tcG9uZW50IH0gZnJvbSAnLi4vZGlhbG9nL2RpYWxvZy5jb21wb25lbnQnO1xuaW1wb3J0IHsgRGlhbG9nU2VydmljZSB9IGZyb20gJy4uL2RpYWxvZy9kaWFsb2cuc2VydmljZSc7XG5cbmV4cG9ydCBjbGFzcyBKc29uRWRpdG9yTm9kZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcbiAgQElucHV0KCkgc2NoZW1hOiBKU09ORWRpdG9yU2NoZW1hO1xuXG4gIEBJbnB1dCgpIG1vZGVsOiBhbnk7XG5cbiAgQElucHV0KCkgcmVxdWlyZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBASW5wdXQoKSBpbmxpbmU6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBASW5wdXQoKSBwYXRoOiBzdHJpbmcgPSAnJztcblxuICBASW5wdXQoKSBlcnJvcnM6IGFueVtdO1xuXG4gIEBJbnB1dCgpIHR5cGVDaGVja092ZXJyaWRlcz86IGFueTtcblxuICBAT3V0cHV0KCkgbW9kZWxDaGFuZ2U6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIEBPdXRwdXQoKSBzY2hlbWFDaGFuZ2U6IEV2ZW50RW1pdHRlcjxKU09ORWRpdG9yU2NoZW1hPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBAVmlld0NoaWxkKCdjb2RlRWRpdG9yVHBsJykgY29kZUVkaXRvclRwbDogVGVtcGxhdGVSZWY8YW55PjtcblxuICByZXF1aXJlZENhY2hlOiBhbnkgPSB7fTtcbiAgZXhwYW5kZWQ6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIG93bkVycm9yczogYW55W107XG4gIHZhbGlkOiBib29sZWFuID0gdHJ1ZTtcblxuICBjaGlsZHJlbkVycm9yczogYW55W107XG4gIGNoaWxkcmVuVmFsaWQ6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIGVkaXRvckRpYWxvZzogQ29tcG9uZW50UmVmPERpYWxvZ0NvbXBvbmVudD47XG4gIGVkaXRvckNvbmZpZyA9IHtcbiAgICBsaW5lTnVtYmVyczogdHJ1ZSxcbiAgICB0aGVtZTogJ2RyYWN1bGEnLFxuICAgIG1vZGU6IHtcbiAgICAgIGxhYmVsOiAnSmF2YXNjcmlwdCcsXG4gICAgICBuYW1lOiAnamF2YXNjcmlwdCcsXG4gICAgICBqc29uOiB0cnVlXG4gICAgfVxuICB9O1xuICBlZGl0b3JNb2RlbDogc3RyaW5nID0gJyc7XG4gIGVkaXRvclZpc2libGU6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIGVkaXRvck1vZGVzOiBhbnlbXSA9IFtcbiAgICB7XG4gICAgICBsYWJlbDogJ0phdmFzY3JpcHQnLFxuICAgICAgbmFtZTogJ2phdmFzY3JpcHQnLFxuICAgICAganNvbjogdHJ1ZVxuICAgIH0sXG4gICAge1xuICAgICAgbGFiZWw6ICdZQU1MJyxcbiAgICAgIG5hbWU6ICd5YW1sJ1xuICAgIH0sXG4gICAge1xuICAgICAgbGFiZWw6ICdQeXRob24nLFxuICAgICAgbmFtZTogJ3B5dGhvbidcbiAgICB9LFxuICAgIHtcbiAgICAgIGxhYmVsOiAnUG93ZXJzaGVsbCcsXG4gICAgICBuYW1lOiAncG93ZXJzaGVsbCdcbiAgICB9LFxuICAgIHtcbiAgICAgIGxhYmVsOiAnSFRNTCcsXG4gICAgICBuYW1lOiAnaHRtbG1peGVkJ1xuICAgIH1cbiAgXTtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgZGlhbG9nTW5ncjogRGlhbG9nU2VydmljZSkge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICBpZiAoIXRoaXMuc2NoZW1hKSB7XG4gICAgICB0aGlzLnNjaGVtYSA9IHtcbiAgICAgICAgLi4uaW5mZXJUeXBlKHRoaXMubW9kZWwsIHRoaXMudHlwZUNoZWNrT3ZlcnJpZGVzKVxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zY2hlbWEucmVxdWlyZWQpIHtcbiAgICAgIGZvciAoY29uc3QgcHJvcCBvZiB0aGlzLnNjaGVtYS5yZXF1aXJlZCkge1xuICAgICAgICB0aGlzLnJlcXVpcmVkQ2FjaGVbcHJvcF0gPSB0cnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChBcnJheS5pc0FycmF5KHRoaXMuc2NoZW1hLnR5cGUpICYmIHRoaXMuc2NoZW1hLnR5cGUubGVuZ3RoID4gMCkge1xuICAgICAgaWYgKCF0aGlzLnNjaGVtYS4kbWV0YSkge1xuICAgICAgICB0aGlzLnNjaGVtYS4kbWV0YSA9IHt9O1xuICAgICAgfVxuICAgICAgdGhpcy5zY2hlbWEuJG1ldGEudHlwZSA9IFsuLi50aGlzLnNjaGVtYS50eXBlXTtcblxuICAgICAgaWYgKHRoaXMubW9kZWwgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLnNjaGVtYSA9IHtcbiAgICAgICAgICAuLi50aGlzLnNjaGVtYSxcbiAgICAgICAgICAuLi5pbmZlclR5cGUodGhpcy5tb2RlbCwgdGhpcy50eXBlQ2hlY2tPdmVycmlkZXMsIHRoaXMuc2NoZW1hLiRtZXRhLnR5cGUpXG4gICAgICAgIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnNjaGVtYS50eXBlID0gdGhpcy5zY2hlbWEudHlwZVswXTtcbiAgICAgICAgdGhpcy5zY2hlbWEuJG1ldGEuY3VycmVudFR5cGUgPSB0aGlzLnNjaGVtYS50eXBlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5pbml0TW9kZWwoKTtcbiAgICB9KTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoY2hhbmdlcy5lcnJvcnMpIHtcbiAgICAgIHRoaXMucHJvY2Vzc0Vycm9ycygpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbml0cyB0aGUgbW9kZWwgaWYgaXQgaXMgbm90IGRlZmluZWRcbiAgICovXG4gIGluaXRNb2RlbCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5tb2RlbCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnNjaGVtYSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHZhbHVlOiBhbnkgPSBjcmVhdGVWYWx1ZUZvclNjaGVtYSh0aGlzLnNjaGVtYSk7XG5cbiAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy51cGRhdGVNb2RlbCh2YWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFByb2Nlc3MgdGhlIGVycm9ycyBpbnB1dCB0byBmaWd1cmUgb3V0IHdoZXRoZXIgaXQgb3IgYW55IG9mIGl0cyBjaGlsZHJlbiBhcmUgaW52YWxpZFxuICAgKi9cbiAgcHJvY2Vzc0Vycm9ycygpOiB2b2lkIHtcbiAgICB0aGlzLm93bkVycm9ycyA9IFtdO1xuICAgIHRoaXMuY2hpbGRyZW5FcnJvcnMgPSBbXTtcblxuICAgIGlmICh0aGlzLmVycm9ycyAmJiB0aGlzLmVycm9ycy5sZW5ndGgpIHtcbiAgICAgIHRoaXMub3duRXJyb3JzID0gdGhpcy5lcnJvcnMuZmlsdGVyKGUgPT4ge1xuICAgICAgICByZXR1cm4gZS5kYXRhUGF0aCA9PT0gdGhpcy5wYXRoO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuY2hpbGRyZW5FcnJvcnMgPSB0aGlzLmVycm9ycy5maWx0ZXIoZSA9PiB7XG4gICAgICAgIHJldHVybiBlLmRhdGFQYXRoLnN0YXJ0c1dpdGgodGhpcy5wYXRoKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICB0aGlzLmNoaWxkcmVuVmFsaWQgPSB0aGlzLmNoaWxkcmVuRXJyb3JzLmxlbmd0aCA9PT0gMDtcbiAgICB0aGlzLnZhbGlkID0gdGhpcy5vd25FcnJvcnMubGVuZ3RoID09PSAwO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgdGhlIHdob2xlIG1vZGVsIGFuZCBlbWl0cyB0aGUgY2hhbmdlIGV2ZW50XG4gICAqIEBwYXJhbSB2YWx1ZVxuICAgKi9cbiAgdXBkYXRlTW9kZWwodmFsdWU6IGFueSk6IHZvaWQge1xuICAgIHRoaXMubW9kZWwgPSB2YWx1ZTtcbiAgICB0aGlzLm1vZGVsQ2hhbmdlLmVtaXQodGhpcy5tb2RlbCk7XG4gIH1cblxuICAvKipcbiAgICogRXhwYW5kIGNsaWNrIGV2ZW50XG4gICAqL1xuICBvbkV4cGFuZENsaWNrKCk6IHZvaWQge1xuICAgIHRoaXMuZXhwYW5kZWQgPSAhdGhpcy5leHBhbmRlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVucyB0aGUgY29kZSBlZGl0b3IgZGlhbG9nXG4gICAqL1xuICBvcGVuQ29kZUVkaXRvcigpOiB2b2lkIHtcbiAgICB0aGlzLmVkaXRvck1vZGVsID0gdGhpcy5tb2RlbDtcbiAgICB0aGlzLmVkaXRvckRpYWxvZyA9IHRoaXMuZGlhbG9nTW5nci5jcmVhdGUoeyB0ZW1wbGF0ZTogdGhpcy5jb2RlRWRpdG9yVHBsLCBjbGFzczogJ2NvZGUtZWRpdG9yLWRpYWxvZycgfSk7XG4gIH1cblxuICAvKipcbiAgICogQ2xvc2VzIHRoZSBjb2RlIGVkaXRvciBkaWFsb2dcbiAgICovXG4gIGNsb3NlQ29kZUVkaXRvcigpOiB2b2lkIHtcbiAgICB0aGlzLmRpYWxvZ01uZ3IuZGVzdHJveSh0aGlzLmVkaXRvckRpYWxvZyk7XG4gIH1cblxuICAvKipcbiAgICogU2V0cyB0aGUgZWRpdG9yIG1vZGUgYW5kIHJlZnJlc2hlcyB0aGUgZWRpdG9yXG4gICAqL1xuICBzZWxlY3RFZGl0b3JNb2RlKG1vZGVOYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmVkaXRvckNvbmZpZy5tb2RlLm5hbWUgPSBtb2RlTmFtZTtcbiAgICB0aGlzLmVkaXRvckNvbmZpZyA9IHsgLi4udGhpcy5lZGl0b3JDb25maWcgfTtcbiAgICB0aGlzLmVkaXRvclZpc2libGUgPSBmYWxzZTtcblxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5lZGl0b3JWaXNpYmxlID0gdHJ1ZTtcbiAgICB9KTtcbiAgfVxufVxuIl19