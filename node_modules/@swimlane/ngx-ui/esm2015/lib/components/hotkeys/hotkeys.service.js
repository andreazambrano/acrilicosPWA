import { __decorate, __metadata } from "tslib";
import { Injectable, NgZone } from '@angular/core';
import * as Mousetrap from 'mousetrap';
import { Subject } from 'rxjs';
import { HotkeyStatus } from './hotkey-status.enum';
let hotkeys = {};
const hotkeyChangedSource = new Subject();
const isMac = /Mac|iPod|iPhone|iPad/.test(window.navigator.platform);
const tags = ['INPUT', 'SELECT', 'TEXTAREA'];
/*tslint:disable*/
const map = {
    command: '\u2318',
    shift: '\u21E7',
    left: '\u2190',
    right: '\u2192',
    up: '\u2191',
    down: '\u2193',
    return: '\u23CE',
    backspace: '\u232B' // âŒ«
};
/*tslint:enable*/
function _getDisplay(combo) {
    const keys = combo.split('+');
    const result = [];
    for (const k of keys) {
        if (k === 'mod') {
            result.push(isMac ? map.command : /* istanbul ignore next */ 'ctrl');
            continue;
        }
        const mapped = map[k];
        result.push(mapped || k);
    }
    return result;
}
export function _add(combo, opts) {
    opts.status = opts.status || HotkeyStatus.Active;
    opts.keys = _getDisplay(combo);
    opts.visible = opts.visible !== undefined ? opts.visible : true;
    opts.allowIn = Array.isArray(opts.allowIn) ? opts.allowIn.map(tag => tag.toUpperCase()) : [];
    const mousetrap = new Mousetrap();
    if (opts.allowIn.length) {
        /* istanbul ignore next */
        mousetrap.stopCallback = function (_, element) {
            if (!tags.includes(element.tagName) || opts.allowIn.includes(element.tagName)) {
                return false;
            }
            return true;
        };
    }
    mousetrap.bind(combo, callback);
    if (hotkeys[combo] === undefined) {
        hotkeys[combo] = [];
    }
    hotkeys[combo].push(opts);
    hotkeyChangedSource.next(hotkeys);
    /* istanbul ignore next */
    function callback(event) {
        if (event.preventDefault) {
            event.preventDefault();
        }
        else {
            // internet explorer
            event.returnValue = false;
        }
        if (opts && opts.status === HotkeyStatus.Active) {
            opts.zone.run(() => {
                opts.callback(event);
            });
        }
    }
}
export function _suspend(comp) {
    for (const comb in hotkeys) {
        const hotkeyList = hotkeys[comb];
        for (const hotkey of hotkeyList) {
            if (hotkey.component === comp) {
                hotkey.status = HotkeyStatus.Suspended;
            }
        }
    }
    hotkeyChangedSource.next(hotkeys);
}
export function _pauseOthers(comp) {
    for (const comb in hotkeys) {
        const hotkeyList = hotkeys[comb];
        for (const hotkey of hotkeyList) {
            if (hotkey.component !== comp) {
                hotkey.status = `*${hotkey.status}`;
            }
        }
    }
    hotkeyChangedSource.next(hotkeys);
}
export function _unpauseOthers(comp) {
    for (const comb in hotkeys) {
        const hotkeyList = hotkeys[comb];
        for (const hotkey of hotkeyList) {
            if (hotkey.component !== comp && hotkey.status[0] === '*') {
                hotkey.status = hotkey.status.replace('*', '');
            }
        }
    }
    hotkeyChangedSource.next(hotkeys);
}
export function _activate(comp) {
    for (const comb in hotkeys) {
        const hotkeyList = hotkeys[comb];
        for (const hotkey of hotkeyList) {
            if (hotkey.component === comp) {
                hotkey.status = HotkeyStatus.Active;
            }
        }
    }
    hotkeyChangedSource.next(hotkeys);
}
export function _deregister(comp) {
    for (const comb in hotkeys) {
        const hotkeyList = hotkeys[comb];
        for (let i = 0; i < hotkeyList.length; i++) {
            if (hotkeyList[i].component === comp) {
                hotkeyList[i].status = HotkeyStatus.Disabled;
                hotkeyList.splice(hotkeyList.indexOf(hotkeyList[i]), 1);
            }
        }
        if (!hotkeyList.length) {
            Mousetrap.unbind(comb);
        }
    }
    hotkeyChangedSource.next(hotkeys);
}
export function Hotkey(key, description, options) {
    return (target, name) => {
        const oldInit = target.ngOnInit;
        target.ngOnInit = function () {
            if (oldInit)
                oldInit.bind(this)();
            _add(key, Object.assign({ callback: /* istanbul ignore next */ () => {
                    target[name].bind(this)();
                }, description, component: this, zone: new NgZone({ enableLongStackTrace: false }) }, options));
        };
        const oldDestroy = target.ngOnDestroy;
        target.ngOnDestroy = function () {
            if (oldDestroy)
                oldDestroy.bind(this)();
            _deregister(this);
        };
    };
}
let HotkeysService = class HotkeysService {
    constructor(ngZone) {
        this.ngZone = ngZone;
        this.suspend = _suspend;
        this.activate = _activate;
        this.deregister = _deregister;
        this.pauseOthers = _pauseOthers;
        this.unpauseOthers = _unpauseOthers;
        this.changeEvent = hotkeyChangedSource.asObservable();
    }
    get hotkeys() {
        return hotkeys;
    }
    add(combo, opts) {
        _add(combo, Object.assign({ zone: this.ngZone }, opts));
    }
    clear() {
        hotkeys = {};
        Mousetrap.reset();
    }
};
HotkeysService.ctorParameters = () => [
    { type: NgZone }
];
HotkeysService = __decorate([
    Injectable(),
    __metadata("design:paramtypes", [NgZone])
], HotkeysService);
export { HotkeysService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG90a2V5cy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHN3aW1sYW5lL25neC11aS8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2hvdGtleXMvaG90a2V5cy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEtBQUssU0FBUyxNQUFNLFdBQVcsQ0FBQztBQUN2QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRy9CLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVwRCxJQUFJLE9BQU8sR0FBa0MsRUFBRSxDQUFDO0FBQ2hELE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxPQUFPLEVBQWlDLENBQUM7QUFDekUsTUFBTSxLQUFLLEdBQUcsc0JBQXNCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDckUsTUFBTSxJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBRTdDLGtCQUFrQjtBQUNsQixNQUFNLEdBQUcsR0FBRztJQUNWLE9BQU8sRUFBRSxRQUFRO0lBQ2pCLEtBQUssRUFBRSxRQUFRO0lBQ2YsSUFBSSxFQUFFLFFBQVE7SUFDZCxLQUFLLEVBQUUsUUFBUTtJQUNmLEVBQUUsRUFBRSxRQUFRO0lBQ1osSUFBSSxFQUFFLFFBQVE7SUFDZCxNQUFNLEVBQUUsUUFBUTtJQUNoQixTQUFTLEVBQUUsUUFBUSxDQUFDLElBQUk7Q0FDekIsQ0FBQztBQUNGLGlCQUFpQjtBQUVqQixTQUFTLFdBQVcsQ0FBQyxLQUFhO0lBQ2hDLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDOUIsTUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDO0lBRWxCLEtBQUssTUFB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T0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUlELEdBQUcsQ0FBQyxLQUFhLEVBQUUsSUFBWTtRQUM3QixJQUFJLENBQUMsS0FBSyxrQkFBSSxJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sSUFBSyxJQUFJLEVBQUcsQ0FBQztJQUM5QyxDQUFDO0lBRUQsS0FBSztRQUNILE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDcEIsQ0FBQztDQUNGLENBQUE7O1lBVnNDLE1BQU07O0FBWmhDLGNBQWM7SUFEMUIsVUFBVSxFQUFFO3FDQWEwQixNQUFNO0dBWmhDLGNBQWMsQ0FzQjFCO1NBdEJZLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCAqIGFzIE1vdXNldHJhcCBmcm9tICdtb3VzZXRyYXAnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBIb3RrZXkgfSBmcm9tICcuL2hvdGtleS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSG90a2V5U3RhdHVzIH0gZnJvbSAnLi9ob3RrZXktc3RhdHVzLmVudW0nO1xuXG5sZXQgaG90a2V5czogeyBbY29tYm86IHN0cmluZ106IEhvdGtleVtdIH0gPSB7fTtcbmNvbnN0IGhvdGtleUNoYW5nZWRTb3VyY2UgPSBuZXcgU3ViamVjdDx7IFtjb21ibzogc3RyaW5nXTogSG90a2V5W10gfT4oKTtcbmNvbnN0IGlzTWFjID0gL01hY3xpUG9kfGlQaG9uZXxpUGFkLy50ZXN0KHdpbmRvdy5uYXZpZ2F0b3IucGxhdGZvcm0pO1xuY29uc3QgdGFncyA9IFsnSU5QVVQnLCAnU0VMRUNUJywgJ1RFWFRBUkVBJ107XG5cbi8qdHNsaW50OmRpc2FibGUqL1xuY29uc3QgbWFwID0ge1xuICBjb21tYW5kOiAnXFx1MjMxOCcsIC8vIOKMmFxuICBzaGlmdDogJ1xcdTIxRTcnLCAvLyDih6dcbiAgbGVmdDogJ1xcdTIxOTAnLCAvLyDihpBcbiAgcmlnaHQ6ICdcXHUyMTkyJywgLy8g4oaSXG4gIHVwOiAnXFx1MjE5MScsIC8vIOKGkVxuICBkb3duOiAnXFx1MjE5MycsIC8vIOKGk1xuICByZXR1cm46ICdcXHUyM0NFJywgLy8g4o+OXG4gIGJhY2tzcGFjZTogJ1xcdTIzMkInIC8vIOKMq1xufTtcbi8qdHNsaW50OmVuYWJsZSovXG5cbmZ1bmN0aW9uIF9nZXREaXNwbGF5KGNvbWJvOiBzdHJpbmcpIHtcbiAgY29uc3Qga2V5cyA9IGNvbWJvLnNwbGl0KCcrJyk7XG4gIGNvbnN0IHJlc3VsdCA9IFtdO1xuXG4gIGZvciAoY29uc3QgayBvZiBrZXlzKSB7XG4gICAgaWYgKGsgPT09ICdtb2QnKSB7XG4gICAgICByZXN1bHQucHVzaChpc01hYyA/IG1hcC5jb21tYW5kIDogLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8gJ2N0cmwnKTtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGNvbnN0IG1hcHBlZCA9IG1hcFtrXTtcbiAgICByZXN1bHQucHVzaChtYXBwZWQgfHwgayk7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX2FkZChjb21ibzogc3RyaW5nLCBvcHRzOiBIb3RrZXkpIHtcbiAgb3B0cy5zdGF0dXMgPSBvcHRzLnN0YXR1cyB8fCBIb3RrZXlTdGF0dXMuQWN0aXZlO1xuICBvcHRzLmtleXMgPSBfZ2V0RGlzcGxheShjb21ibyk7XG4gIG9wdHMudmlzaWJsZSA9IG9wdHMudmlzaWJsZSAhPT0gdW5kZWZpbmVkID8gb3B0cy52aXNpYmxlIDogdHJ1ZTtcblxuICBvcHRzLmFsbG93SW4gPSBBcnJheS5pc0FycmF5KG9wdHMuYWxsb3dJbikgPyBvcHRzLmFsbG93SW4ubWFwKHRhZyA9PiB0YWcudG9VcHBlckNhc2UoKSkgOiBbXTtcblxuICBjb25zdCBtb3VzZXRyYXAgPSBuZXcgTW91c2V0cmFwKCk7XG5cbiAgaWYgKG9wdHMuYWxsb3dJbi5sZW5ndGgpIHtcbiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgIG1vdXNldHJhcC5zdG9wQ2FsbGJhY2sgPSBmdW5jdGlvbihfLCBlbGVtZW50KSB7XG4gICAgICBpZiAoIXRhZ3MuaW5jbHVkZXMoZWxlbWVudC50YWdOYW1lKSB8fCBvcHRzLmFsbG93SW4uaW5jbHVkZXMoZWxlbWVudC50YWdOYW1lKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH07XG4gIH1cblxuICBtb3VzZXRyYXAuYmluZChjb21ibywgY2FsbGJhY2spO1xuXG4gIGlmIChob3RrZXlzW2NvbWJvXSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgaG90a2V5c1tjb21ib10gPSBbXTtcbiAgfVxuXG4gIGhvdGtleXNbY29tYm9dLnB1c2gob3B0cyk7XG4gIGhvdGtleUNoYW5nZWRTb3VyY2UubmV4dChob3RrZXlzKTtcblxuICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICBmdW5jdGlvbiBjYWxsYmFjayhldmVudDogRXZlbnQpIHtcbiAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpIHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGludGVybmV0IGV4cGxvcmVyXG4gICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlO1xuICAgIH1cblxuICAgIGlmIChvcHRzICYmIG9wdHMuc3RhdHVzID09PSBIb3RrZXlTdGF0dXMuQWN0aXZlKSB7XG4gICAgICBvcHRzLnpvbmUucnVuKCgpID0+IHtcbiAgICAgICAgb3B0cy5jYWxsYmFjayhldmVudCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9zdXNwZW5kKGNvbXA6IGFueSkge1xuICBmb3IgKGNvbnN0IGNvbWIgaW4gaG90a2V5cykge1xuICAgIGNvbnN0IGhvdGtleUxpc3QgPSBob3RrZXlzW2NvbWJdO1xuXG4gICAgZm9yIChjb25zdCBob3RrZXkgb2YgaG90a2V5TGlzdCkge1xuICAgICAgaWYgKGhvdGtleS5jb21wb25lbnQgPT09IGNvbXApIHtcbiAgICAgICAgaG90a2V5LnN0YXR1cyA9IEhvdGtleVN0YXR1cy5TdXNwZW5kZWQ7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaG90a2V5Q2hhbmdlZFNvdXJjZS5uZXh0KGhvdGtleXMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX3BhdXNlT3RoZXJzKGNvbXA/OiBhbnkpIHtcbiAgZm9yIChjb25zdCBjb21iIGluIGhvdGtleXMpIHtcbiAgICBjb25zdCBob3RrZXlMaXN0ID0gaG90a2V5c1tjb21iXTtcblxuICAgIGZvciAoY29uc3QgaG90a2V5IG9mIGhvdGtleUxpc3QpIHtcbiAgICAgIGlmIChob3RrZXkuY29tcG9uZW50ICE9PSBjb21wKSB7XG4gICAgICAgIGhvdGtleS5zdGF0dXMgPSBgKiR7aG90a2V5LnN0YXR1c31gO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGhvdGtleUNoYW5nZWRTb3VyY2UubmV4dChob3RrZXlzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF91bnBhdXNlT3RoZXJzKGNvbXA/OiBhbnkpIHtcbiAgZm9yIChjb25zdCBjb21iIGluIGhvdGtleXMpIHtcbiAgICBjb25zdCBob3RrZXlMaXN0ID0gaG90a2V5c1tjb21iXTtcblxuICAgIGZvciAoY29uc3QgaG90a2V5IG9mIGhvdGtleUxpc3QpIHtcbiAgICAgIGlmIChob3RrZXkuY29tcG9uZW50ICE9PSBjb21wICYmIGhvdGtleS5zdGF0dXNbMF0gPT09ICcqJykge1xuICAgICAgICBob3RrZXkuc3RhdHVzID0gaG90a2V5LnN0YXR1cy5yZXBsYWNlKCcqJywgJycpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGhvdGtleUNoYW5nZWRTb3VyY2UubmV4dChob3RrZXlzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9hY3RpdmF0ZShjb21wOiBhbnkpIHtcbiAgZm9yIChjb25zdCBjb21iIGluIGhvdGtleXMpIHtcbiAgICBjb25zdCBob3RrZXlMaXN0ID0gaG90a2V5c1tjb21iXTtcblxuICAgIGZvciAoY29uc3QgaG90a2V5IG9mIGhvdGtleUxpc3QpIHtcbiAgICAgIGlmIChob3RrZXkuY29tcG9uZW50ID09PSBjb21wKSB7XG4gICAgICAgIGhvdGtleS5zdGF0dXMgPSBIb3RrZXlTdGF0dXMuQWN0aXZlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGhvdGtleUNoYW5nZWRTb3VyY2UubmV4dChob3RrZXlzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9kZXJlZ2lzdGVyKGNvbXA6IGFueSkge1xuICBmb3IgKGNvbnN0IGNvbWIgaW4gaG90a2V5cykge1xuICAgIGNvbnN0IGhvdGtleUxpc3QgPSBob3RrZXlzW2NvbWJdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBob3RrZXlMaXN0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoaG90a2V5TGlzdFtpXS5jb21wb25lbnQgPT09IGNvbXApIHtcbiAgICAgICAgaG90a2V5TGlzdFtpXS5zdGF0dXMgPSBIb3RrZXlTdGF0dXMuRGlzYWJsZWQ7XG4gICAgICAgIGhvdGtleUxpc3Quc3BsaWNlKGhvdGtleUxpc3QuaW5kZXhPZihob3RrZXlMaXN0W2ldKSwgMSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFob3RrZXlMaXN0Lmxlbmd0aCkge1xuICAgICAgTW91c2V0cmFwLnVuYmluZChjb21iKTtcbiAgICB9XG4gIH1cblxuICBob3RrZXlDaGFuZ2VkU291cmNlLm5leHQoaG90a2V5cyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBIb3RrZXkoa2V5OiBzdHJpbmcsIGRlc2NyaXB0aW9uOiBzdHJpbmcsIG9wdGlvbnM/OiBQYXJ0aWFsPEhvdGtleT4pIHtcbiAgcmV0dXJuICh0YXJnZXQ6IGFueSwgbmFtZTogc3RyaW5nKSA9PiB7XG4gICAgY29uc3Qgb2xkSW5pdCA9IHRhcmdldC5uZ09uSW5pdDtcbiAgICB0YXJnZXQubmdPbkluaXQgPSBmdW5jdGlvbigpIHtcbiAgICAgIGlmIChvbGRJbml0KSBvbGRJbml0LmJpbmQodGhpcykoKTtcblxuICAgICAgX2FkZChrZXksIHtcbiAgICAgICAgY2FsbGJhY2s6IC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovICgpID0+IHtcbiAgICAgICAgICB0YXJnZXRbbmFtZV0uYmluZCh0aGlzKSgpO1xuICAgICAgICB9LFxuICAgICAgICBkZXNjcmlwdGlvbixcbiAgICAgICAgY29tcG9uZW50OiB0aGlzLFxuICAgICAgICB6b25lOiBuZXcgTmdab25lKHsgZW5hYmxlTG9uZ1N0YWNrVHJhY2U6IGZhbHNlIH0pLFxuICAgICAgICAuLi5vcHRpb25zXG4gICAgICB9KTtcbiAgICB9O1xuXG4gICAgY29uc3Qgb2xkRGVzdHJveSA9IHRhcmdldC5uZ09uRGVzdHJveTtcbiAgICB0YXJnZXQubmdPbkRlc3Ryb3kgPSBmdW5jdGlvbigpIHtcbiAgICAgIGlmIChvbGREZXN0cm95KSBvbGREZXN0cm95LmJpbmQodGhpcykoKTtcbiAgICAgIF9kZXJlZ2lzdGVyKHRoaXMpO1xuICAgIH07XG4gIH07XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBIb3RrZXlzU2VydmljZSB7XG4gIHJlYWRvbmx5IHN1c3BlbmQgPSBfc3VzcGVuZDtcbiAgcmVhZG9ubHkgYWN0aXZhdGUgPSBfYWN0aXZhdGU7XG4gIHJlYWRvbmx5IGRlcmVnaXN0ZXIgPSBfZGVyZWdpc3RlcjtcbiAgcmVhZG9ubHkgcGF1c2VPdGhlcnMgPSBfcGF1c2VPdGhlcnM7XG4gIHJlYWRvbmx5IHVucGF1c2VPdGhlcnMgPSBfdW5wYXVzZU90aGVycztcbiAgcmVhZG9ubHkgY2hhbmdlRXZlbnQgPSBob3RrZXlDaGFuZ2VkU291cmNlLmFzT2JzZXJ2YWJsZSgpO1xuXG4gIGdldCBob3RrZXlzKCkge1xuICAgIHJldHVybiBob3RrZXlzO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBuZ1pvbmU6IE5nWm9uZSkge31cblxuICBhZGQoY29tYm86IHN0cmluZywgb3B0czogSG90a2V5KSB7XG4gICAgX2FkZChjb21ibywgeyB6b25lOiB0aGlzLm5nWm9uZSwgLi4ub3B0cyB9KTtcbiAgfVxuXG4gIGNsZWFyKCkge1xuICAgIGhvdGtleXMgPSB7fTtcbiAgICBNb3VzZXRyYXAucmVzZXQoKTtcbiAgfVxufVxuIl19