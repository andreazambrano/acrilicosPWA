import { __decorate, __metadata } from "tslib";
import { Component, Input, Output, EventEmitter, ViewChild, AfterViewInit, ElementRef, TemplateRef, ChangeDetectionStrategy } from '@angular/core';
import { coerceBooleanProperty, coerceNumberProperty } from '@angular/cdk/coercion';
import { KeyboardKeys } from '../../enums';
import { containsFilter } from './contains-filter.util';
let SelectDropdownComponent = class SelectDropdownComponent {
    constructor(elementRef) {
        this.elementRef = elementRef;
        this.allowAdditionsText = 'Add Value';
        this.keyup = new EventEmitter();
        this.selection = new EventEmitter();
        this.close = new EventEmitter();
        this._filterCaseSensitive = false;
    }
    get tagging() {
        return this._tagging;
    }
    set tagging(tagging) {
        this._tagging = coerceBooleanProperty(tagging);
    }
    get allowAdditions() {
        return this._allowAdditions;
    }
    set allowAdditions(allowAdditions) {
        this._allowAdditions = coerceBooleanProperty(allowAdditions);
    }
    get filterable() {
        return this._filterable;
    }
    set filterable(filterable) {
        this._filterable = coerceBooleanProperty(filterable);
    }
    get filterCaseSensitive() {
        return this._filterCaseSensitive;
    }
    set filterCaseSensitive(filterCaseSensitive) {
        this._filterCaseSensitive = coerceBooleanProperty(filterCaseSensitive);
    }
    get focusIndex() {
        return this._focusIndex;
    }
    set focusIndex(val) {
        this._focusIndex = coerceNumberProperty(val);
        this.focusElement(this._focusIndex);
    }
    get filterQuery() {
        return this._filterQuery;
    }
    set filterQuery(val) {
        this._filterQuery = val;
        this.groups = this.calculateGroups(this.groupBy, this.options, val);
    }
    get groupBy() {
        return this._groupBy;
    }
    set groupBy(val) {
        this._groupBy = val;
        this.groups = this.calculateGroups(val, this.options);
    }
    get options() {
        return this._options;
    }
    set options(val) {
        this.groups = this.calculateGroups(this.groupBy, val);
        this._options = val;
    }
    get element() {
        return this.elementRef.nativeElement;
    }
    get isNotTemplate() {
        return !(typeof this.allowAdditionsText === 'object' && this.allowAdditionsText instanceof TemplateRef);
    }
    ngAfterViewInit() {
        if (this.filterable && !this.tagging) {
            setTimeout(() => {
                this.filterInput.nativeElement.focus();
            }, 5);
        }
    }
    isSelected(option) {
        if (!this.selected || !this.selected.length)
            return false;
        const idx = this.selected.findIndex(o => {
            if (this.identifier)
                return o[this.identifier] === option.value[this.identifier];
            return o === option.value;
        });
        return idx > -1;
    }
    onInputKeyUp(event) {
        event.preventDefault();
        event.stopPropagation();
        const key = event.key;
        const value = event.target.value;
        if (key === KeyboardKeys.ESCAPE) {
            this.close.emit(true);
        }
        else if (event.key === KeyboardKeys.ARROW_DOWN) {
            ++this.focusIndex;
        }
        if (this.filterQuery !== value) {
            this.filterQuery = value;
        }
        this.keyup.emit({ event, value });
    }
    onOptionKeyDown(event) {
        event.preventDefault();
        event.stopPropagation();
        const key = event.key;
        if (key === KeyboardKeys.ARROW_DOWN) {
            if (this.focusIndex < this.options.length - 1)
                ++this.focusIndex;
        }
        else if (key === KeyboardKeys.ARROW_UP) {
            if (this.focusIndex > 0)
                --this.focusIndex;
        }
        else if (key === KeyboardKeys.ENTER) {
            this.selection.emit(this.options[this.focusIndex]);
        }
    }
    onAddClicked(event, value) {
        event.preventDefault();
        event.stopPropagation();
        this.selection.emit({ value, name: value });
        event.target.value = '';
        this.close.emit();
    }
    focusElement(index) {
        const elements = this.element.getElementsByClassName('ngx-select-dropdown-option');
        const element = elements[index];
        if (element) {
            setTimeout(() => element.focus(), 5);
        }
    }
    calculateGroups(groupBy, options, filter) {
        if (!options)
            return [];
        const filterOptions = { filterCaseSensitive: this.filterCaseSensitive };
        // no group by defined, skip and just return
        // empty group object...
        if (!groupBy) {
            if (filter) {
                // filter options
                options = options.filter(o => {
                    return containsFilter({ name: o.name, value: o.value }, filter, filterOptions);
                });
            }
            // need to map indexes
            options = options.map((option, index) => {
                return { option, index };
            });
            return [{ options }];
        }
        const map = new Map();
        let i = 0;
        for (const option of options) {
            // only show items in filter criteria
            if (filter && !containsFilter({ name: option.name, value: option.value }, filter, filterOptions)) {
                continue;
            }
            const group = option.value[groupBy];
            const opt = map.get(group);
            // need to map the true indexes
            const kv = { option, index: i++ };
            if (!opt) {
                map.set(group, [kv]);
            }
            else {
                opt.push(kv);
            }
        }
        const result = [];
        map.forEach((value, key) => {
            result.push({ name: key, options: value });
        });
        return result;
    }
};
SelectDropdownComponent.ctorParameters = () => [
    { type: ElementRef }
];
__decorate([
    Input(),
    __metadata("design:type", Array)
], SelectDropdownComponent.prototype, "selected", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], SelectDropdownComponent.prototype, "identifier", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], SelectDropdownComponent.prototype, "filterPlaceholder", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], SelectDropdownComponent.prototype, "filterEmptyPlaceholder", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], SelectDropdownComponent.prototype, "emptyPlaceholder", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], SelectDropdownComponent.prototype, "allowAdditionsText", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], SelectDropdownComponent.prototype, "tagging", null);
__decorate([
    Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], SelectDropdownComponent.prototype, "allowAdditions", null);
__decorate([
    Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], SelectDropdownComponent.prototype, "filterable", null);
__decorate([
    Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], SelectDropdownComponent.prototype, "filterCaseSensitive", null);
__decorate([
    Input(),
    __metadata("design:type", Number),
    __metadata("design:paramtypes", [Number])
], SelectDropdownComponent.prototype, "focusIndex", null);
__decorate([
    Input(),
    __metadata("design:type", String),
    __metadata("design:paramtypes", [String])
], SelectDropdownComponent.prototype, "filterQuery", null);
__decorate([
    Input(),
    __metadata("design:type", String),
    __metadata("design:paramtypes", [String])
], SelectDropdownComponent.prototype, "groupBy", null);
__decorate([
    Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], SelectDropdownComponent.prototype, "options", null);
__decorate([
    Output(),
    __metadata("design:type", Object)
], SelectDropdownComponent.prototype, "keyup", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], SelectDropdownComponent.prototype, "selection", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], SelectDropdownComponent.prototype, "close", void 0);
__decorate([
    ViewChild('filterInput'),
    __metadata("design:type", ElementRef)
], SelectDropdownComponent.prototype, "filterInput", void 0);
SelectDropdownComponent = __decorate([
    Component({
        exportAs: 'ngxSelectDropdown',
        selector: 'ngx-select-dropdown',
        template: "<div>\n  <div class=\"ngx-select-filter\" *ngIf=\"filterable && !tagging\">\n    <input\n      #filterInput\n      type=\"search\"\n      tabindex=\"\"\n      autocomplete=\"off\"\n      autocorrect=\"off\"\n      spellcheck=\"off\"\n      class=\"ngx-select-filter-input\"\n      [placeholder]=\"filterPlaceholder\"\n      (keyup)=\"onInputKeyUp($event)\"\n    />\n  </div>\n  <ul class=\"vertical-list ngx-select-dropdown-options\">\n    <li *ngFor=\"let group of groups\" class=\"ngx-select-option-group\">\n      <span class=\"ngx-select-option-group-name\" *ngIf=\"group.name\" [innerHTML]=\"group.name\"> </span>\n      <ul class=\"vertical-list ngx-select-dropdown-options\">\n        <li\n          *ngFor=\"let kv of group.options\"\n          class=\"ngx-select-dropdown-option\"\n          [class.disabled]=\"kv.option.disabled\"\n          [class.active]=\"kv.index === focusIndex\"\n          [class.selected]=\"isSelected(kv.option)\"\n          [hidden]=\"kv.option.hidden\"\n          tabindex=\"-1\"\n          (click)=\"selection.emit(kv.option)\"\n          (keydown)=\"onOptionKeyDown($event)\"\n        >\n          <ng-template\n            *ngIf=\"kv.option.optionTemplate\"\n            [ngTemplateOutlet]=\"kv.option.optionTemplate\"\n            [ngTemplateOutletContext]=\"{ option: kv.option }\"\n          >\n          </ng-template>\n          <span *ngIf=\"!kv.option.optionTemplate\" [innerHTML]=\"kv.option.name\"> </span>\n        </li>\n        <li\n          *ngIf=\"filterQuery && filterEmptyPlaceholder && !group.options?.length\"\n          class=\"ngx-select-empty-placeholder\"\n        >\n          <span class=\"ngx-select-empty-placeholder-text\" [innerHTML]=\"filterEmptyPlaceholder\"> </span>\n          <a\n            *ngIf=\"allowAdditions\"\n            href=\"#\"\n            class=\"ngx-select-empty-placeholder-add\"\n            (click)=\"onAddClicked($event, filterQuery)\"\n          >\n            <span *ngIf=\"isNotTemplate; else tpl\" [innerHTML]=\"allowAdditionsText\"> </span>\n            <ng-template #tpl>\n              <ng-container *ngTemplateOutlet=\"allowAdditionsText\"></ng-container>\n            </ng-template>\n          </a>\n        </li>\n        <li\n          *ngIf=\"!filterQuery && emptyPlaceholder && !group.options?.length\"\n          class=\"ngx-select-empty-placeholder\"\n          [innerHTML]=\"emptyPlaceholder\"\n        ></li>\n      </ul>\n    </li>\n  </ul>\n</div>\n",
        host: {
            class: 'ngx-select-dropdown',
            '[class.groupings]': 'groupBy'
        },
        changeDetection: ChangeDetectionStrategy.OnPush
    }),
    __metadata("design:paramtypes", [ElementRef])
], SelectDropdownComponent);
export { SelectDropdownComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LWRyb3Bkb3duLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bzd2ltbGFuZS9uZ3gtdWkvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9zZWxlY3Qvc2VsZWN0LWRyb3Bkb3duLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsTUFBTSxFQUNOLFlBQVksRUFDWixTQUFTLEVBQ1QsYUFBYSxFQUNiLFVBQVUsRUFDVixXQUFXLEVBQ1gsdUJBQXVCLEVBQ3hCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRXBGLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDM0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBYXhELElBQWEsdUJBQXVCLEdBQXBDLE1BQWEsdUJBQXVCO0lBc0dsQyxZQUE2QixVQUFzQjtRQUF0QixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBaEcxQyx1QkFBa0IsR0FBOEIsV0FBVyxDQUFDO1FBc0UzRCxVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQTRDLENBQUM7UUFDckUsY0FBUyxHQUFHLElBQUksWUFBWSxFQUF3QixDQUFDO1FBQ3JELFVBQUssR0FBRyxJQUFJLFlBQVksRUFBdUIsQ0FBQztRQXNCbEQseUJBQW9CLEdBQUcsS0FBSyxDQUFDO0lBRWlCLENBQUM7SUE3RnZELElBQUksT0FBTztRQUNULE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN2QixDQUFDO0lBQ0QsSUFBSSxPQUFPLENBQUMsT0FBTztRQUNqQixJQUFJLENBQUMsUUFBUSxHQUFHLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFHRCxJQUFJLGNBQWM7UUFDaEIsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDO0lB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LEVBQUU7OztzREFHUDtBQU9EO0lBREMsS0FBSyxFQUFFOzs7c0RBR1A7QUFNUztJQUFULE1BQU0sRUFBRTs7c0RBQXNFO0FBQ3JFO0lBQVQsTUFBTSxFQUFFOzswREFBc0Q7QUFDckQ7SUFBVCxNQUFNLEVBQUU7O3NEQUFpRDtBQUcxRDtJQURDLFNBQVMsQ0FBQyxhQUFhLENBQUM7OEJBQ0YsVUFBVTs0REFBbUI7QUFqRnpDLHVCQUF1QjtJQVZuQyxTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsbUJBQW1CO1FBQzdCLFFBQVEsRUFBRSxxQkFBcUI7UUFDL0IsMDZFQUErQztRQUMvQyxJQUFJLEVBQUU7WUFDSixLQUFLLEVBQUUscUJBQXFCO1lBQzVCLG1CQUFtQixFQUFFLFNBQVM7U0FDL0I7UUFDRCxlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTtLQUNoRCxDQUFDO3FDQXVHeUMsVUFBVTtHQXRHeEMsdUJBQXVCLENBcU9uQztTQXJPWSx1QkFBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgVmlld0NoaWxkLFxuICBBZnRlclZpZXdJbml0LFxuICBFbGVtZW50UmVmLFxuICBUZW1wbGF0ZVJlZixcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3lcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBjb2VyY2VCb29sZWFuUHJvcGVydHksIGNvZXJjZU51bWJlclByb3BlcnR5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2NvZXJjaW9uJztcblxuaW1wb3J0IHsgS2V5Ym9hcmRLZXlzIH0gZnJvbSAnLi4vLi4vZW51bXMnO1xuaW1wb3J0IHsgY29udGFpbnNGaWx0ZXIgfSBmcm9tICcuL2NvbnRhaW5zLWZpbHRlci51dGlsJztcbmltcG9ydCB7IFNlbGVjdERyb3Bkb3duT3B0aW9uIH0gZnJvbSAnLi9zZWxlY3QtZHJvcGRvd24tb3B0aW9uLmludGVyZmFjZSc7XG5cbkBDb21wb25lbnQoe1xuICBleHBvcnRBczogJ25neFNlbGVjdERyb3Bkb3duJyxcbiAgc2VsZWN0b3I6ICduZ3gtc2VsZWN0LWRyb3Bkb3duJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3NlbGVjdC1kcm9wZG93bi5jb21wb25lbnQuaHRtbCcsXG4gIGhvc3Q6IHtcbiAgICBjbGFzczogJ25neC1zZWxlY3QtZHJvcGRvd24nLFxuICAgICdbY2xhc3MuZ3JvdXBpbmdzXSc6ICdncm91cEJ5J1xuICB9LFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaFxufSlcbmV4cG9ydCBjbGFzcyBTZWxlY3REcm9wZG93bkNvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQge1xuICBASW5wdXQoKSBzZWxlY3RlZDogYW55W107XG4gIEBJbnB1dCgpIGlkZW50aWZpZXI6IGFueTtcbiAgQElucHV0KCkgZmlsdGVyUGxhY2Vob2xkZXI6IHN0cmluZztcbiAgQElucHV0KCkgZmlsdGVyRW1wdHlQbGFjZWhvbGRlcjogc3RyaW5nO1xuICBASW5wdXQoKSBlbXB0eVBsYWNlaG9sZGVyOiBzdHJpbmc7XG4gIEBJbnB1dCgpIGFsbG93QWRkaXRpb25zVGV4dDogc3RyaW5nIHwgVGVtcGxhdGVSZWY8YW55PiA9ICdBZGQgVmFsdWUnO1xuXG4gIEBJbnB1dCgpXG4gIGdldCB0YWdnaW5nKCkge1xuICAgIHJldHVybiB0aGlzLl90YWdnaW5nO1xuICB9XG4gIHNldCB0YWdnaW5nKHRhZ2dpbmcpIHtcbiAgICB0aGlzLl90YWdnaW5nID0gY29lcmNlQm9vbGVhblByb3BlcnR5KHRhZ2dpbmcpO1xuICB9XG5cbiAgQElucHV0KClcbiAgZ2V0IGFsbG93QWRkaXRpb25zKCkge1xuICAgIHJldHVybiB0aGlzLl9hbGxvd0FkZGl0aW9ucztcbiAgfVxuICBzZXQgYWxsb3dBZGRpdGlvbnMoYWxsb3dBZGRpdGlvbnMpIHtcbiAgICB0aGlzLl9hbGxvd0FkZGl0aW9ucyA9IGNvZXJjZUJvb2xlYW5Qcm9wZXJ0eShhbGxvd0FkZGl0aW9ucyk7XG4gIH1cblxuICBASW5wdXQoKVxuICBnZXQgZmlsdGVyYWJsZSgpIHtcbiAgICByZXR1cm4gdGhpcy5fZmlsdGVyYWJsZTtcbiAgfVxuICBzZXQgZmlsdGVyYWJsZShmaWx0ZXJhYmxlKSB7XG4gICAgdGhpcy5fZmlsdGVyYWJsZSA9IGNvZXJjZUJvb2xlYW5Qcm9wZXJ0eShmaWx0ZXJhYmxlKTtcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIGdldCBmaWx0ZXJDYXNlU2Vuc2l0aXZlKCkge1xuICAgIHJldHVybiB0aGlzLl9maWx0ZXJDYXNlU2Vuc2l0aXZlO1xuICB9XG4gIHNldCBmaWx0ZXJDYXNlU2Vuc2l0aXZlKGZpbHRlckNhc2VTZW5zaXRpdmUpIHtcbiAgICB0aGlzLl9maWx0ZXJDYXNlU2Vuc2l0aXZlID0gY29lcmNlQm9vbGVhblByb3BlcnR5KGZpbHRlckNhc2VTZW5zaXRpdmUpO1xuICB9XG5cbiAgQElucHV0KClcbiAgZ2V0IGZvY3VzSW5kZXgoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2ZvY3VzSW5kZXg7XG4gIH1cbiAgc2V0IGZvY3VzSW5kZXgodmFsOiBudW1iZXIpIHtcbiAgICB0aGlzLl9mb2N1c0luZGV4ID0gY29lcmNlTnVtYmVyUHJvcGVydHkodmFsKTtcbiAgICB0aGlzLmZvY3VzRWxlbWVudCh0aGlzLl9mb2N1c0luZGV4KTtcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIGdldCBmaWx0ZXJRdWVyeSgpIHtcbiAgICByZXR1cm4gdGhpcy5fZmlsdGVyUXVlcnk7XG4gIH1cbiAgc2V0IGZpbHRlclF1ZXJ5KHZhbDogc3RyaW5nKSB7XG4gICAgdGhpcy5fZmlsdGVyUXVlcnkgPSB2YWw7XG4gICAgdGhpcy5ncm91cHMgPSB0aGlzLmNhbGN1bGF0ZUdyb3Vwcyh0aGlzLmdyb3VwQnksIHRoaXMub3B0aW9ucywgdmFsKTtcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIGdldCBncm91cEJ5KCkge1xuICAgIHJldHVybiB0aGlzLl9ncm91cEJ5O1xuICB9XG4gIHNldCBncm91cEJ5KHZhbDogc3RyaW5nKSB7XG4gICAgdGhpcy5fZ3JvdXBCeSA9IHZhbDtcbiAgICB0aGlzLmdyb3VwcyA9IHRoaXMuY2FsY3VsYXRlR3JvdXBzKHZhbCwgdGhpcy5vcHRpb25zKTtcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIGdldCBvcHRpb25zKCkge1xuICAgIHJldHVybiB0aGlzLl9vcHRpb25zO1xuICB9XG4gIHNldCBvcHRpb25zKHZhbCkge1xuICAgIHRoaXMuZ3JvdXBzID0gdGhpcy5jYWxjdWxhdGVHcm91cHModGhpcy5ncm91cEJ5LCB2YWwpO1xuICAgIHRoaXMuX29wdGlvbnMgPSB2YWw7XG4gIH1cblxuICBAT3V0cHV0KCkga2V5dXAgPSBuZXcgRXZlbnRFbWl0dGVyPHsgZXZlbnQ6IEtleWJvYXJkRXZlbnQ7IHZhbHVlPzogc3RyaW5nIH0+KCk7XG4gIEBPdXRwdXQoKSBzZWxlY3Rpb24gPSBuZXcgRXZlbnRFbWl0dGVyPFNlbGVjdERyb3Bkb3duT3B0aW9uPigpO1xuICBAT3V0cHV0KCkgY2xvc2UgPSBuZXcgRXZlbnRFbWl0dGVyPGJvb2xlYW4gfCB1bmRlZmluZWQ+KCk7XG5cbiAgQFZpZXdDaGlsZCgnZmlsdGVySW5wdXQnKVxuICByZWFkb25seSBmaWx0ZXJJbnB1dD86IEVsZW1lbnRSZWY8SFRNTElucHV0RWxlbWVudD47XG5cbiAgZ2V0IGVsZW1lbnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xuICB9XG5cbiAgZ2V0IGlzTm90VGVtcGxhdGUoKSB7XG4gICAgcmV0dXJuICEodHlwZW9mIHRoaXMuYWxsb3dBZGRpdGlvbnNUZXh0ID09PSAnb2JqZWN0JyAmJiB0aGlzLmFsbG93QWRkaXRpb25zVGV4dCBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmKTtcbiAgfVxuXG4gIGdyb3VwczogYW55W107XG5cbiAgcHJpdmF0ZSBfb3B0aW9uczogU2VsZWN0RHJvcGRvd25PcHRpb25bXTtcbiAgcHJpdmF0ZSBfZ3JvdXBCeTogc3RyaW5nO1xuICBwcml2YXRlIF9maWx0ZXJRdWVyeTogc3RyaW5nO1xuICBwcml2YXRlIF9mb2N1c0luZGV4OiBudW1iZXI7XG4gIHByaXZhdGUgX3RhZ2dpbmc6IGJvb2xlYW47XG4gIHByaXZhdGUgX2FsbG93QWRkaXRpb25zOiBib29sZWFuO1xuICBwcml2YXRlIF9maWx0ZXJhYmxlOiBib29sZWFuO1xuICBwcml2YXRlIF9maWx0ZXJDYXNlU2Vuc2l0aXZlID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBlbGVtZW50UmVmOiBFbGVtZW50UmVmKSB7fVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5maWx0ZXJhYmxlICYmICF0aGlzLnRhZ2dpbmcpIHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLmZpbHRlcklucHV0Lm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcbiAgICAgIH0sIDUpO1xuICAgIH1cbiAgfVxuXG4gIGlzU2VsZWN0ZWQob3B0aW9uOiBTZWxlY3REcm9wZG93bk9wdGlvbik6IGJvb2xlYW4ge1xuICAgIGlmICghdGhpcy5zZWxlY3RlZCB8fCAhdGhpcy5zZWxlY3RlZC5sZW5ndGgpIHJldHVybiBmYWxzZTtcblxuICAgIGNvbnN0IGlkeCA9IHRoaXMuc2VsZWN0ZWQuZmluZEluZGV4KG8gPT4ge1xuICAgICAgaWYgKHRoaXMuaWRlbnRpZmllcikgcmV0dXJuIG9bdGhpcy5pZGVudGlmaWVyXSA9PT0gb3B0aW9uLnZhbHVlW3RoaXMuaWRlbnRpZmllcl07XG4gICAgICByZXR1cm4gbyA9PT0gb3B0aW9uLnZhbHVlO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGlkeCA+IC0xO1xuICB9XG5cbiAgb25JbnB1dEtleVVwKGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgIGNvbnN0IGtleSA9IGV2ZW50LmtleTtcbiAgICBjb25zdCB2YWx1ZSA9IChldmVudC50YXJnZXQgYXMgYW55KS52YWx1ZTtcblxuICAgIGlmIChrZXkgPT09IChLZXlib2FyZEtleXMuRVNDQVBFIGFzIGFueSkpIHtcbiAgICAgIHRoaXMuY2xvc2UuZW1pdCh0cnVlKTtcbiAgICB9IGVsc2UgaWYgKGV2ZW50LmtleSA9PT0gKEtleWJvYXJkS2V5cy5BUlJPV19ET1dOIGFzIGFueSkpIHtcbiAgICAgICsrdGhpcy5mb2N1c0luZGV4O1xuICAgIH1cblxuICAgIGlmICh0aGlzLmZpbHRlclF1ZXJ5ICE9PSB2YWx1ZSkge1xuICAgICAgdGhpcy5maWx0ZXJRdWVyeSA9IHZhbHVlO1xuICAgIH1cblxuICAgIHRoaXMua2V5dXAuZW1pdCh7IGV2ZW50LCB2YWx1ZSB9KTtcbiAgfVxuXG4gIG9uT3B0aW9uS2V5RG93bihldmVudDogS2V5Ym9hcmRFdmVudCk6IHZvaWQge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICBjb25zdCBrZXkgPSBldmVudC5rZXk7XG5cbiAgICBpZiAoa2V5ID09PSAoS2V5Ym9hcmRLZXlzLkFSUk9XX0RPV04gYXMgYW55KSkge1xuICAgICAgaWYgKHRoaXMuZm9jdXNJbmRleCA8IHRoaXMub3B0aW9ucy5sZW5ndGggLSAxKSArK3RoaXMuZm9jdXNJbmRleDtcbiAgICB9IGVsc2UgaWYgKGtleSA9PT0gKEtleWJvYXJkS2V5cy5BUlJPV19VUCBhcyBhbnkpKSB7XG4gICAgICBpZiAodGhpcy5mb2N1c0luZGV4ID4gMCkgLS10aGlzLmZvY3VzSW5kZXg7XG4gICAgfSBlbHNlIGlmIChrZXkgPT09IChLZXlib2FyZEtleXMuRU5URVIgYXMgYW55KSkge1xuICAgICAgdGhpcy5zZWxlY3Rpb24uZW1pdCh0aGlzLm9wdGlvbnNbdGhpcy5mb2N1c0luZGV4XSk7XG4gICAgfVxuICB9XG5cbiAgb25BZGRDbGlja2VkKGV2ZW50OiBFdmVudCwgdmFsdWU6IGFueSk6IHZvaWQge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICB0aGlzLnNlbGVjdGlvbi5lbWl0KHsgdmFsdWUsIG5hbWU6IHZhbHVlIH0pO1xuICAgIChldmVudC50YXJnZXQgYXMgYW55KS52YWx1ZSA9ICcnO1xuXG4gICAgdGhpcy5jbG9zZS5lbWl0KCk7XG4gIH1cblxuICBwcml2YXRlIGZvY3VzRWxlbWVudChpbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgY29uc3QgZWxlbWVudHMgPSB0aGlzLmVsZW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnbmd4LXNlbGVjdC1kcm9wZG93bi1vcHRpb24nKTtcbiAgICBjb25zdCBlbGVtZW50ID0gZWxlbWVudHNbaW5kZXhdO1xuXG4gICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gZWxlbWVudC5mb2N1cygpLCA1KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNhbGN1bGF0ZUdyb3Vwcyhncm91cEJ5OiBzdHJpbmcsIG9wdGlvbnM6IGFueVtdLCBmaWx0ZXI/OiBzdHJpbmcpOiBhbnlbXSB7XG4gICAgaWYgKCFvcHRpb25zKSByZXR1cm4gW107XG5cbiAgICBjb25zdCBmaWx0ZXJPcHRpb25zID0geyBmaWx0ZXJDYXNlU2Vuc2l0aXZlOiB0aGlzLmZpbHRlckNhc2VTZW5zaXRpdmUgfTtcblxuICAgIC8vIG5vIGdyb3VwIGJ5IGRlZmluZWQsIHNraXAgYW5kIGp1c3QgcmV0dXJuXG4gICAgLy8gZW1wdHkgZ3JvdXAgb2JqZWN0Li4uXG4gICAgaWYgKCFncm91cEJ5KSB7XG4gICAgICBpZiAoZmlsdGVyKSB7XG4gICAgICAgIC8vIGZpbHRlciBvcHRpb25zXG4gICAgICAgIG9wdGlvbnMgPSBvcHRpb25zLmZpbHRlcihvID0+IHtcbiAgICAgICAgICByZXR1cm4gY29udGFpbnNGaWx0ZXIoeyBuYW1lOiBvLm5hbWUsIHZhbHVlOiBvLnZhbHVlIH0sIGZpbHRlciwgZmlsdGVyT3B0aW9ucyk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBuZWVkIHRvIG1hcCBpbmRleGVzXG4gICAgICBvcHRpb25zID0gb3B0aW9ucy5tYXAoKG9wdGlvbiwgaW5kZXgpID0+IHtcbiAgICAgICAgcmV0dXJuIHsgb3B0aW9uLCBpbmRleCB9O1xuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiBbeyBvcHRpb25zIH1dO1xuICAgIH1cblxuICAgIGNvbnN0IG1hcCA9IG5ldyBNYXAoKTtcbiAgICBsZXQgaSA9IDA7XG5cbiAgICBmb3IgKGNvbnN0IG9wdGlvbiBvZiBvcHRpb25zKSB7XG4gICAgICAvLyBvbmx5IHNob3cgaXRlbXMgaW4gZmlsdGVyIGNyaXRlcmlhXG4gICAgICBpZiAoZmlsdGVyICYmICFjb250YWluc0ZpbHRlcih7IG5hbWU6IG9wdGlvbi5uYW1lLCB2YWx1ZTogb3B0aW9uLnZhbHVlIH0sIGZpbHRlciwgZmlsdGVyT3B0aW9ucykpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGdyb3VwID0gb3B0aW9uLnZhbHVlW2dyb3VwQnldO1xuICAgICAgY29uc3Qgb3B0OiBhbnkgPSBtYXAuZ2V0KGdyb3VwKTtcblxuICAgICAgLy8gbmVlZCB0byBtYXAgdGhlIHRydWUgaW5kZXhlc1xuICAgICAgY29uc3Qga3YgPSB7IG9wdGlvbiwgaW5kZXg6IGkrKyB9O1xuXG4gICAgICBpZiAoIW9wdCkge1xuICAgICAgICBtYXAuc2V0KGdyb3VwLCBba3ZdKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9wdC5wdXNoKGt2KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCByZXN1bHQgPSBbXTtcbiAgICBtYXAuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4ge1xuICAgICAgcmVzdWx0LnB1c2goeyBuYW1lOiBrZXksIG9wdGlvbnM6IHZhbHVlIH0pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxufVxuIl19