import { __assign, __decorate, __metadata, __read, __spread, __values } from "tslib";
import { Input, EventEmitter, Output, TemplateRef, ViewChild } from '@angular/core';
import { createValueForSchema, inferType } from './json-editor.helper';
var JsonEditorNode = /** @class */ (function () {
    function JsonEditorNode(dialogMngr) {
        this.dialogMngr = dialogMngr;
        this.required = false;
        this.inline = false;
        this.path = '';
        this.modelChange = new EventEmitter();
        this.schemaChange = new EventEmitter();
        this.requiredCache = {};
        this.expanded = true;
        this.valid = true;
        this.childrenValid = true;
        this.editorConfig = {
            lineNumbers: true,
            theme: 'dracula',
            mode: {
                label: 'Javascript',
                name: 'javascript',
                json: true
            }
        };
        this.editorModel = '';
        this.editorVisible = true;
        this.editorModes = [
            {
                label: 'Javascript',
                name: 'javascript',
                json: true
            },
            {
                label: 'YAML',
                name: 'yaml'
            },
            {
                label: 'Python',
                name: 'python'
            },
            {
                label: 'Powershell',
                name: 'powershell'
            },
            {
                label: 'HTML',
                name: 'htmlmixed'
            }
        ];
    }
    JsonEditorNode.prototype.ngOnInit = function () {
        var e_1, _a;
        var _this = this;
        if (!this.schema) {
            this.schema = __assign({}, inferType(this.model, this.typeCheckOverrides));
        }
        if (this.schema.required) {
            try {
                for (var _b = __values(this.schema.required), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var prop = _c.value;
                    this.requiredCache[prop] = true;
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_1) throw e_1.error; }
            }
        }
        if (Array.isArray(this.schema.type) && this.schema.type.length > 0) {
            if (!this.schema.$meta) {
                this.schema.$meta = {};
            }
            this.schema.$meta.type = __spread(this.schema.type);
            if (this.model !== undefined) {
                this.schema = __assign(__assign({}, this.schema), inferType(this.model, this.typeCheckOverrides, this.schema.$meta.type));
            }
            else {
                this.schema.type = this.schema.type[0];
                this.schema.$meta.currentType = this.schema.type;
            }
        }
        setTimeout(function () {
            _this.initModel();
        });
    };
    JsonEditorNode.prototype.ngOnChanges = function (changes) {
        if (changes.errors) {
            this.processErrors();
        }
    };
    /**
     * Inits the model if it is not defined
     */
    JsonEditorNode.prototype.initModel = function () {
        if (this.model !== undefined) {
            return;
        }
        if (!this.schema) {
            return;
        }
        var value = createValueForSchema(this.schema);
        if (value !== undefined) {
            this.updateModel(value);
        }
    };
    /**
     * Process the errors input to figure out whether it or any of its children are invalid
     */
    JsonEditorNode.prototype.processErrors = function () {
        var _this = this;
        this.ownErrors = [];
        this.childrenErrors = [];
        if (this.errors && this.errors.length) {
            this.ownErrors = this.errors.filter(function (e) {
                return e.dataPath === _this.path;
            });
            this.childrenErrors = this.errors.filter(function (e) {
                return e.dataPath.startsWith(_this.path);
            });
        }
        this.childrenValid = this.childrenErrors.length === 0;
        this.valid = this.ownErrors.length === 0;
    };
    /**
     * Updates the whole model and emits the change event
     * @param value
     */
    JsonEditorNode.prototype.updateModel = function (value) {
        this.model = value;
        this.modelChange.emit(this.model);
    };
    /**
     * Expand click event
     */
    JsonEditorNode.prototype.onExpandClick = function () {
        this.expanded = !this.expanded;
    };
    /**
     * Opens the code editor dialog
     */
    JsonEditorNode.prototype.openCodeEditor = function () {
        this.editorModel = this.model;
        this.editorDialog = this.dialogMngr.create({ template: this.codeEditorTpl, class: 'code-editor-dialog' });
    };
    /**
     * Closes the code editor dialog
     */
    JsonEditorNode.prototype.closeCodeEditor = function () {
        this.dialogMngr.destroy(this.editorDialog);
    };
    /**
     * Sets the editor mode and refreshes the editor
     */
    JsonEditorNode.prototype.selectEditorMode = function (modeName) {
        var _this = this;
        this.editorConfig.mode.name = modeName;
        this.editorConfig = __assign({}, this.editorConfig);
        this.editorVisible = false;
        setTimeout(function () {
            _this.editorVisible = true;
        });
    };
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], JsonEditorNode.prototype, "schema", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], JsonEditorNode.prototype, "model", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Boolean)
    ], JsonEditorNode.prototype, "required", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Boolean)
    ], JsonEditorNode.prototype, "inline", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], JsonEditorNode.prototype, "path", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Array)
    ], JsonEditorNode.prototype, "errors", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], JsonEditorNode.prototype, "typeCheckOverrides", void 0);
    __decorate([
        Output(),
        __metadata("design:type", EventEmitter)
    ], JsonEditorNode.prototype, "modelChange", void 0);
    __decorate([
        Output(),
        __metadata("design:type", EventEmitter)
    ], JsonEditorNode.prototype, "schemaChange", void 0);
    __decorate([
        ViewChild('codeEditorTpl'),
        __metadata("design:type", TemplateRef)
    ], JsonEditorNode.prototype, "codeEditorTpl", void 0);
    return JsonEditorNode;
}());
export { JsonEditorNode };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianNvbi1lZGl0b3Itbm9kZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bzd2ltbGFuZS9uZ3gtdWkvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9qc29uLWVkaXRvci9qc29uLWVkaXRvci1ub2RlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsS0FBSyxFQUNMLFlBQVksRUFDWixNQUFNLEVBSU4sV0FBVyxFQUNYLFNBQVMsRUFFVixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsU0FBUyxFQUFvQixNQUFNLHNCQUFzQixDQUFDO0FBSXpGO0lBbUVFLHdCQUFtQixVQUF5QjtRQUF6QixlQUFVLEdBQVYsVUFBVSxDQUFlO1FBOURuQyxhQUFRLEdBQVksS0FBSyxDQUFDO1FBRTFCLFdBQU0sR0FBWSxLQUFLLENBQUM7UUFFeEIsU0FBSSxHQUFXLEVBQUUsQ0FBQztRQU1qQixnQkFBVyxHQUFzQixJQUFJLFlBQVksRUFBRSxDQUFDO1FBRXBELGlCQUFZLEdBQW1DLElBQUksWUFBWSxFQUFFLENBQUM7UUFJNUUsa0JBQWEsR0FBUSxFQUFFLENBQUM7UUFDeEIsYUFBUSxHQUFZLElBQUksQ0FBQztRQUd6QixVQUFLLEdBQVksSUFBSSxDQUFDO1FBR3RCLGtCQUFhLEdBQVksSUFBSSxDQUFDO1FBRzlCLGlCQUFZLEdBQUc7WUFDYixXQUFXLEVBQUUsSUFBSTtZQUNqQixLQUFLLEVBQUUsU0FBUztZQUNoQixJQUFJLEVBQUU7Z0JBQ0osS0FBSyxFQUFFLFlBQVk7Z0JBQ25CLElBQUksRUFBRSxZQUFZO2dCQUNsQixJQUFJLEVBQUUsSUFBSTthQUNYO1NBQ0YsQ0FBQztRQUNGLGdCQUFXLEdBQVcsRUFBRSxDQUFDO1FBQ3pCLGtCQUFhLEdBQVksSUFBSSxDQUFDO1FBRTlCLGdCQUFXLEdBQVU7WUFDbkI7Z0JBQ0UsS0FBSyxFQUFFLFlBQVk7Z0JBQ25CLElBQUksRUFBRSxZQUFZO2dCQUNsQixJQUFJLEVB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bkluaXQsXG4gIE9uQ2hhbmdlcyxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgVGVtcGxhdGVSZWYsXG4gIFZpZXdDaGlsZCxcbiAgQ29tcG9uZW50UmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBjcmVhdGVWYWx1ZUZvclNjaGVtYSwgaW5mZXJUeXBlLCBKU09ORWRpdG9yU2NoZW1hIH0gZnJvbSAnLi9qc29uLWVkaXRvci5oZWxwZXInO1xuaW1wb3J0IHsgRGlhbG9nQ29tcG9uZW50IH0gZnJvbSAnLi4vZGlhbG9nL2RpYWxvZy5jb21wb25lbnQnO1xuaW1wb3J0IHsgRGlhbG9nU2VydmljZSB9IGZyb20gJy4uL2RpYWxvZy9kaWFsb2cuc2VydmljZSc7XG5cbmV4cG9ydCBjbGFzcyBKc29uRWRpdG9yTm9kZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcbiAgQElucHV0KCkgc2NoZW1hOiBKU09ORWRpdG9yU2NoZW1hO1xuXG4gIEBJbnB1dCgpIG1vZGVsOiBhbnk7XG5cbiAgQElucHV0KCkgcmVxdWlyZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBASW5wdXQoKSBpbmxpbmU6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBASW5wdXQoKSBwYXRoOiBzdHJpbmcgPSAnJztcblxuICBASW5wdXQoKSBlcnJvcnM6IGFueVtdO1xuXG4gIEBJbnB1dCgpIHR5cGVDaGVja092ZXJyaWRlcz86IGFueTtcblxuICBAT3V0cHV0KCkgbW9kZWxDaGFuZ2U6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIEBPdXRwdXQoKSBzY2hlbWFDaGFuZ2U6IEV2ZW50RW1pdHRlcjxKU09ORWRpdG9yU2NoZW1hPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBAVmlld0NoaWxkKCdjb2RlRWRpdG9yVHBsJykgY29kZUVkaXRvclRwbDogVGVtcGxhdGVSZWY8YW55PjtcblxuICByZXF1aXJlZENhY2hlOiBhbnkgPSB7fTtcbiAgZXhwYW5kZWQ6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIG93bkVycm9yczogYW55W107XG4gIHZhbGlkOiBib29sZWFuID0gdHJ1ZTtcblxuICBjaGlsZHJlbkVycm9yczogYW55W107XG4gIGNoaWxkcmVuVmFsaWQ6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIGVkaXRvckRpYWxvZzogQ29tcG9uZW50UmVmPERpYWxvZ0NvbXBvbmVudD47XG4gIGVkaXRvckNvbmZpZyA9IHtcbiAgICBsaW5lTnVtYmVyczogdHJ1ZSxcbiAgICB0aGVtZTogJ2RyYWN1bGEnLFxuICAgIG1vZGU6IHtcbiAgICAgIGxhYmVsOiAnSmF2YXNjcmlwdCcsXG4gICAgICBuYW1lOiAnamF2YXNjcmlwdCcsXG4gICAgICBqc29uOiB0cnVlXG4gICAgfVxuICB9O1xuICBlZGl0b3JNb2RlbDogc3RyaW5nID0gJyc7XG4gIGVkaXRvclZpc2libGU6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIGVkaXRvck1vZGVzOiBhbnlbXSA9IFtcbiAgICB7XG4gICAgICBsYWJlbDogJ0phdmFzY3JpcHQnLFxuICAgICAgbmFtZTogJ2phdmFzY3JpcHQnLFxuICAgICAganNvbjogdHJ1ZVxuICAgIH0sXG4gICAge1xuICAgICAgbGFiZWw6ICdZQU1MJyxcbiAgICAgIG5hbWU6ICd5YW1sJ1xuICAgIH0sXG4gICAge1xuICAgICAgbGFiZWw6ICdQeXRob24nLFxuICAgICAgbmFtZTogJ3B5dGhvbidcbiAgICB9LFxuICAgIHtcbiAgICAgIGxhYmVsOiAnUG93ZXJzaGVsbCcsXG4gICAgICBuYW1lOiAncG93ZXJzaGVsbCdcbiAgICB9LFxuICAgIHtcbiAgICAgIGxhYmVsOiAnSFRNTCcsXG4gICAgICBuYW1lOiAnaHRtbG1peGVkJ1xuICAgIH1cbiAgXTtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgZGlhbG9nTW5ncjogRGlhbG9nU2VydmljZSkge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICBpZiAoIXRoaXMuc2NoZW1hKSB7XG4gICAgICB0aGlzLnNjaGVtYSA9IHtcbiAgICAgICAgLi4uaW5mZXJUeXBlKHRoaXMubW9kZWwsIHRoaXMudHlwZUNoZWNrT3ZlcnJpZGVzKVxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zY2hlbWEucmVxdWlyZWQpIHtcbiAgICAgIGZvciAoY29uc3QgcHJvcCBvZiB0aGlzLnNjaGVtYS5yZXF1aXJlZCkge1xuICAgICAgICB0aGlzLnJlcXVpcmVkQ2FjaGVbcHJvcF0gPSB0cnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChBcnJheS5pc0FycmF5KHRoaXMuc2NoZW1hLnR5cGUpICYmIHRoaXMuc2NoZW1hLnR5cGUubGVuZ3RoID4gMCkge1xuICAgICAgaWYgKCF0aGlzLnNjaGVtYS4kbWV0YSkge1xuICAgICAgICB0aGlzLnNjaGVtYS4kbWV0YSA9IHt9O1xuICAgICAgfVxuICAgICAgdGhpcy5zY2hlbWEuJG1ldGEudHlwZSA9IFsuLi50aGlzLnNjaGVtYS50eXBlXTtcblxuICAgICAgaWYgKHRoaXMubW9kZWwgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLnNjaGVtYSA9IHtcbiAgICAgICAgICAuLi50aGlzLnNjaGVtYSxcbiAgICAgICAgICAuLi5pbmZlclR5cGUodGhpcy5tb2RlbCwgdGhpcy50eXBlQ2hlY2tPdmVycmlkZXMsIHRoaXMuc2NoZW1hLiRtZXRhLnR5cGUpXG4gICAgICAgIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnNjaGVtYS50eXBlID0gdGhpcy5zY2hlbWEudHlwZVswXTtcbiAgICAgICAgdGhpcy5zY2hlbWEuJG1ldGEuY3VycmVudFR5cGUgPSB0aGlzLnNjaGVtYS50eXBlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5pbml0TW9kZWwoKTtcbiAgICB9KTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoY2hhbmdlcy5lcnJvcnMpIHtcbiAgICAgIHRoaXMucHJvY2Vzc0Vycm9ycygpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbml0cyB0aGUgbW9kZWwgaWYgaXQgaXMgbm90IGRlZmluZWRcbiAgICovXG4gIGluaXRNb2RlbCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5tb2RlbCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnNjaGVtYSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHZhbHVlOiBhbnkgPSBjcmVhdGVWYWx1ZUZvclNjaGVtYSh0aGlzLnNjaGVtYSk7XG5cbiAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy51cGRhdGVNb2RlbCh2YWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFByb2Nlc3MgdGhlIGVycm9ycyBpbnB1dCB0byBmaWd1cmUgb3V0IHdoZXRoZXIgaXQgb3IgYW55IG9mIGl0cyBjaGlsZHJlbiBhcmUgaW52YWxpZFxuICAgKi9cbiAgcHJvY2Vzc0Vycm9ycygpOiB2b2lkIHtcbiAgICB0aGlzLm93bkVycm9ycyA9IFtdO1xuICAgIHRoaXMuY2hpbGRyZW5FcnJvcnMgPSBbXTtcblxuICAgIGlmICh0aGlzLmVycm9ycyAmJiB0aGlzLmVycm9ycy5sZW5ndGgpIHtcbiAgICAgIHRoaXMub3duRXJyb3JzID0gdGhpcy5lcnJvcnMuZmlsdGVyKGUgPT4ge1xuICAgICAgICByZXR1cm4gZS5kYXRhUGF0aCA9PT0gdGhpcy5wYXRoO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuY2hpbGRyZW5FcnJvcnMgPSB0aGlzLmVycm9ycy5maWx0ZXIoZSA9PiB7XG4gICAgICAgIHJldHVybiBlLmRhdGFQYXRoLnN0YXJ0c1dpdGgodGhpcy5wYXRoKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICB0aGlzLmNoaWxkcmVuVmFsaWQgPSB0aGlzLmNoaWxkcmVuRXJyb3JzLmxlbmd0aCA9PT0gMDtcbiAgICB0aGlzLnZhbGlkID0gdGhpcy5vd25FcnJvcnMubGVuZ3RoID09PSAwO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgdGhlIHdob2xlIG1vZGVsIGFuZCBlbWl0cyB0aGUgY2hhbmdlIGV2ZW50XG4gICAqIEBwYXJhbSB2YWx1ZVxuICAgKi9cbiAgdXBkYXRlTW9kZWwodmFsdWU6IGFueSk6IHZvaWQge1xuICAgIHRoaXMubW9kZWwgPSB2YWx1ZTtcbiAgICB0aGlzLm1vZGVsQ2hhbmdlLmVtaXQodGhpcy5tb2RlbCk7XG4gIH1cblxuICAvKipcbiAgICogRXhwYW5kIGNsaWNrIGV2ZW50XG4gICAqL1xuICBvbkV4cGFuZENsaWNrKCk6IHZvaWQge1xuICAgIHRoaXMuZXhwYW5kZWQgPSAhdGhpcy5leHBhbmRlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVucyB0aGUgY29kZSBlZGl0b3IgZGlhbG9nXG4gICAqL1xuICBvcGVuQ29kZUVkaXRvcigpOiB2b2lkIHtcbiAgICB0aGlzLmVkaXRvck1vZGVsID0gdGhpcy5tb2RlbDtcbiAgICB0aGlzLmVkaXRvckRpYWxvZyA9IHRoaXMuZGlhbG9nTW5nci5jcmVhdGUoeyB0ZW1wbGF0ZTogdGhpcy5jb2RlRWRpdG9yVHBsLCBjbGFzczogJ2NvZGUtZWRpdG9yLWRpYWxvZycgfSk7XG4gIH1cblxuICAvKipcbiAgICogQ2xvc2VzIHRoZSBjb2RlIGVkaXRvciBkaWFsb2dcbiAgICovXG4gIGNsb3NlQ29kZUVkaXRvcigpOiB2b2lkIHtcbiAgICB0aGlzLmRpYWxvZ01uZ3IuZGVzdHJveSh0aGlzLmVkaXRvckRpYWxvZyk7XG4gIH1cblxuICAvKipcbiAgICogU2V0cyB0aGUgZWRpdG9yIG1vZGUgYW5kIHJlZnJlc2hlcyB0aGUgZWRpdG9yXG4gICAqL1xuICBzZWxlY3RFZGl0b3JNb2RlKG1vZGVOYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmVkaXRvckNvbmZpZy5tb2RlLm5hbWUgPSBtb2RlTmFtZTtcbiAgICB0aGlzLmVkaXRvckNvbmZpZyA9IHsgLi4udGhpcy5lZGl0b3JDb25maWcgfTtcbiAgICB0aGlzLmVkaXRvclZpc2libGUgPSBmYWxzZTtcblxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5lZGl0b3JWaXNpYmxlID0gdHJ1ZTtcbiAgICB9KTtcbiAgfVxufVxuIl19