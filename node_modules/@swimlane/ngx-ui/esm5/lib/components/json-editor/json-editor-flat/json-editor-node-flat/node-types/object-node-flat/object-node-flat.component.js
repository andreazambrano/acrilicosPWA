import { __assign, __decorate, __extends, __metadata, __read, __spread } from "tslib";
import { Component, ViewEncapsulation, Input, ViewChild, TemplateRef, OnInit, ChangeDetectionStrategy, ChangeDetectorRef } from '@angular/core';
import { ObjectNode } from '../../../../node-types/object-node.component';
import { DialogService } from '../../../../../dialog/dialog.service';
import { jsonSchemaDataTypes, createValueForSchema } from '../../../../json-editor.helper';
import { moveItemInArray } from '@angular/cdk/drag-drop';
var ObjectNodeFlatComponent = /** @class */ (function (_super) {
    __extends(ObjectNodeFlatComponent, _super);
    function ObjectNodeFlatComponent(dialogService, cdr) {
        var _this = _super.call(this, cdr) || this;
        _this.dialogService = dialogService;
        _this.cdr = cdr;
        _this.indentationArray = [];
        _this.objectKeys = Object.keys;
        return _this;
    }
    ObjectNodeFlatComponent.prototype.ngOnInit = function () {
        var _this = this;
        if (this.schemaBuilderMode) {
            this.dataTypes = __spread(jsonSchemaDataTypes, this.formats);
        }
        setTimeout(function () {
            _this.initSchemaProperties(_this.schema);
            _this.initSchemaProperties(_this.schemaRef);
        });
        if (this.level > 0) {
            this.indentationArray = Array(this.level).fill(this.level);
        }
    };
    ObjectNodeFlatComponent.prototype.onUpdatePropertyName = function (options) {
        this.updatePropertyName(options.id, options.name);
    };
    ObjectNodeFlatComponent.prototype.onPropertyConfig = function (property, index) {
        this.dialogService.create({
            template: this.propertyConfigTmpl,
            context: {
                property: property,
                index: index,
                schema: this.schema,
                formats: this.formats
            },
            class: 'property-config-dialog'
        });
    };
    ObjectNodeFlatComponent.prototype.updateSchema = function (options) {
        var oldProperty = options.oldProperty;
        var newProperty = options.newProperty;
        var oldName = oldProperty.propertyName;
        var newName = newProperty.propertyName;
        if (newName !== oldName) {
            if (oldName in this.schema.properties) {
                this.updateSchemaPropertyName(this.schema, newName, oldName);
            }
            this.updateSchemaPropertyName(this.schemaRef, newName, oldName);
            this.updatePropertyName(options.newProperty.id, newName);
        }
        this.toggleRequiredValue(options.required, newName);
        this.schema.properties[newName] = newProperty;
        this.propertyIndex[options.newProperty.id] = newProperty;
        this.updateSchemaRefProperty(newProperty);
        if (newName !== oldName) {
            this.swapSchemaProperties(options.index);
        }
        if (oldProperty.type !== newProperty.type) {
            var value = createValueForSchema(newProperty);
            this.model[newProperty.propertyName] = value;
        }
        this.propertyIndex = __assign({}, this.propertyIndex);
        this.schemaChange.emit();
    };
    ObjectNodeFlatComponent.prototype.addProperty = function (dataType) {
        _super.prototype.addProperty.call(this, dataType);
        this.updateSchemaRefProperty(this.propertyIndex[this.propertyId - 1]);
        this.schemaChange.emit();
    };
    ObjectNodeFlatComponent.prototype.deleteProperty = function (propName) {
        if (this.schemaBuilderMode) {
            delete this.schema.properties[propName];
            delete this.schemaRef.properties[propName];
            this.toggleRequiredValue(false, propName);
        }
        else if (!this.schema.required.includes(propName) && !(propName in this.schema.properties)) {
            delete this.schemaRef.properties[propName];
        }
        this.schemaChange.emit();
        _super.prototype.deleteProperty.call(this, propName);
    };
    ObjectNodeFlatComponent.prototype.drop = function (event) {
        var propertyIndexValues = Object.values(this.propertyIndex);
        moveItemInArray(propertyIndexValues, event.previousIndex, event.currentIndex);
        var index = 0;
        for (var prop in this.propertyIndex) {
            this.propertyIndex[prop] = propertyIndexValues[index];
            this.propertyIndex[prop].id = parseInt(prop, 10);
            index += 1;
        }
        this.propertyIndex = __assign({}, this.propertyIndex);
        this.swapSchemaProperties(event.currentIndex, event.previousIndex);
    };
    ObjectNodeFlatComponent.prototype.swapSchemaProperties = function (currentIndex, previousIndex) {
        var _this = this;
        var propertiesIds = Object.keys(this.schemaRef.properties);
        if (previousIndex === undefined) {
            previousIndex = propertiesIds.length - 1;
        }
        moveItemInArray(propertiesIds, previousIndex, currentIndex);
        this.schemaRef.properties = propertiesIds.reduce(function (result, prop) {
            result[prop] = _this.schemaRef.properties[prop];
            return result;
        }, {});
        this.schemaChange.emit();
    };
    ObjectNodeFlatComponent.prototype.initSchemaProperties = function (schema) {
        if (schema) {
            schema.required = schema.required || [];
            schema.properties = schema.properties || {};
        }
    };
    ObjectNodeFlatComponent.prototype.updateSchemaRefProperty = function (prop) {
        this.schemaRef.properties[prop.propertyName] = __assign(__assign(__assign(__assign(__assign(__assign(__assign(__assign(__assign(__assign(__assign(__assign(__assign(__assign(__assign(__assign({ type: prop.type }, (prop['format'] && { format: prop['format'] })), (prop['title'] && { title: prop['title'] })), (prop['items'] && { items: prop['items'] })), (prop['required'] && { required: prop['required'] })), (prop['properties'] && { properties: prop['properties'] })), (prop['enum'] && { enum: prop['enum'] })), (prop['default'] && { default: prop['default'] })), (prop['description'] && { description: prop['description'] })), (prop['nameEditable'] && { nameEditable: prop['nameEditable'] })), (prop['minimum'] && { minimum: prop['minimum'] })), (prop['maximum'] && { maximum: prop['maximum'] })), (prop['minLength'] && { minLength: prop['minLength'] })), (prop['maxLength'] && { maxLength: prop['maxLength'] })), (prop['minItems'] && { minItems: prop['minItems'] })), (prop['maxItems'] && { maxItems: prop['maxItems'] })), (prop['pattern'] && { pattern: prop['pattern'] }));
    };
    ObjectNodeFlatComponent.prototype.updateSchemaPropertyName = function (schema, newName, oldName) {
        this.updateRequiredProperties(schema, newName, oldName);
        schema.properties[newName] = schema.properties[oldName];
        delete schema.properties[oldName];
    };
    ObjectNodeFlatComponent.prototype.toggleRequiredValue = function (required, propertyName) {
        var requiredIndex = this.schema.required.indexOf(propertyName);
        if (requiredIndex >= 0 && !required) {
            this.schema.required.splice(requiredIndex, 1);
        }
        else if (requiredIndex < 0 && required) {
            this.schema.required.push(propertyName);
        }
        this.schemaRef.required = __spread(this.schema.required);
        this.updateRequiredCache();
    };
    ObjectNodeFlatComponent.prototype.updateRequiredProperties = function (schema, newName, oldName) {
        var requiredIndex = schema.required.indexOf(oldName);
        if (requiredIndex >= 0) {
            schema.required[requiredIndex] = newName;
        }
    };
    ObjectNodeFlatComponent.ctorParameters = function () { return [
        { type: DialogService },
        { type: ChangeDetectorRef }
    ]; };
    __decorate([
        ViewChild('propertyConfigTmpl', { static: false }),
        __metadata("design:type", TemplateRef)
    ], ObjectNodeFlatComponent.prototype, "propertyConfigTmpl", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Number)
    ], ObjectNodeFlatComponent.prototype, "level", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Boolean)
    ], ObjectNodeFlatComponent.prototype, "schemaBuilderMode", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Array)
    ], ObjectNodeFlatComponent.prototype, "formats", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Boolean)
    ], ObjectNodeFlatComponent.prototype, "compressed", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], ObjectNodeFlatComponent.prototype, "hideRoot", void 0);
    ObjectNodeFlatComponent = __decorate([
        Component({
            selector: 'ngx-json-object-node-flat',
            template: "<div\n  class=\"object-node-flat\"\n  [hidden]=\"!expanded\"\n  cdkDropList\n  [cdkDropListDisabled]=\"!schemaBuilderMode\"\n  (cdkDropListDropped)=\"drop($event)\"\n>\n  <div\n    cdkDrag\n    cdkDragLockAxis=\"y\"\n    class=\"object-node-content\"\n    *ngFor=\"let prop of propertyIndex | objectValues; let index = index; trackBy: trackBy\"\n  >\n    <ngx-json-editor-node-flat\n      [model]=\"model[prop.propertyName]\"\n      (modelChange)=\"updateProp(prop.id, $event)\"\n      [schema]=\"prop\"\n      [schemaRef]=\"schemaRef && schemaRef.properties ? schemaRef.properties[prop.propertyName] : null\"\n      [required]=\"!!requiredCache[prop.propertyName]\"\n      [inline]=\"prop.type !== 'array' && prop.type !== 'object'\"\n      [path]=\"path + getPath(prop.propertyName)\"\n      [errors]=\"errors\"\n      [hideRoot]=\"hideRoot\"\n      [typeCheckOverrides]=\"typeCheckOverrides\"\n      [level]=\"level\"\n      [schemaBuilderMode]=\"schemaBuilderMode\"\n      [formats]=\"formats\"\n      [compressed]=\"compressed\"\n      [indentationArray]=\"indentationArray\"\n      (schemaChange)=\"schemaChange.emit(schemaRef)\"\n      (updatePropertyNameEvent)=\"onUpdatePropertyName($event)\"\n    >\n      <div class=\"node-options\" node-options>\n        <button\n          *ngIf=\"schemaBuilderMode\"\n          type=\"button\"\n          class=\"node-options-btn\"\n          (click)=\"onPropertyConfig(prop, index)\"\n        >\n          <i class=\"ngx-icon ngx-cog\"></i>\n        </button>\n        <ngx-dropdown [showCaret]=\"true\">\n          <ngx-dropdown-toggle>\n            <button type=\"button\" class=\"node-options-btn\">\n              <i class=\"ngx-icon ngx-dots-vert-round\"></i>\n            </button>\n          </ngx-dropdown-toggle>\n          <ngx-dropdown-menu class=\"ngx-dropdown-dark-outline align-right\">\n            <ul class=\"vertical-list\">\n              <li>\n                <button\n                  type=\"button\"\n                  (click)=\"deleteProperty(prop.propertyName)\"\n                  [disabled]=\"requiredCache[prop.propertyName] && !schemaBuilderMode\"\n                >\n                  Delete\n                </button>\n              </li>\n              <ng-container *ngIf=\"prop?.$meta?.type && !schemaBuilderMode\">\n                <li *ngFor=\"let type of prop?.$meta?.type\">\n                  <button\n                    type=\"button\"\n                    (click)=\"changePropertyType(prop, type)\"\n                    [disabled]=\"prop.$meta.currentType === type\"\n                  >\n                    Change type to {{ dataTypeMap[type].name }}\n                  </button>\n                </li>\n              </ng-container>\n            </ul>\n          </ngx-dropdown-menu>\n        </ngx-dropdown>\n      </div>\n      <div *ngIf=\"schemaBuilderMode\" class=\"drag-drop-handle\" cdkDragHandle>\n        <i class=\"ngx-icon ngx-handle\"></i>\n      </div>\n    </ngx-json-editor-node-flat>\n    <div\n      *cdkDragPlaceholder\n      class=\"indentation-placeholder\"\n      [ngStyle]=\"{ width: 'calc(100% + ' + level * 20 + 'px)' }\"\n    ></div>\n  </div>\n\n  <div class=\"add-button\" [class.compressed]=\"compressed\" [class.background]=\"hideRoot ? level > -1 : level\">\n    <span class=\"separator\" *ngFor=\"let separator of indentationArray\"></span>\n    <div class=\"indented-content\" [style.marginLeft]=\"hideRoot && level === 0 ? '20px' : '0'\">\n      <ngx-dropdown [showCaret]=\"true\">\n        <ngx-dropdown-toggle>\n          <button type=\"button\">\n            <i class=\"ngx-icon ngx-tree-expand\"></i>\n            <span>Add {{ objectKeys(propertyIndex).length ? 'a' : 'your first' }} property</span>\n          </button>\n        </ngx-dropdown-toggle>\n        <ngx-dropdown-menu class=\"ngx-dropdown-dark-outline\">\n          <ul class=\"vertical-list dropdown-column\" *ngIf=\"schema.properties && !schemaBuilderMode\">\n            <li *ngFor=\"let prop of schema.properties | keyvalue\" (click)=\"addSchemaProperty(prop.key)\">\n              <button [disabled]=\"model[prop.key] !== undefined\" type=\"button\">\n                {{ prop.value.title ? prop.value.title : prop.key }}\n              </button>\n            </li>\n          </ul>\n          <ul\n            class=\"vertical-list dropdown-column\"\n            *ngIf=\"!schema || schema.patternProperties || schema.additionalProperties !== false\"\n          >\n            <li *ngFor=\"let prop of schema.patternProperties | keyvalue\" (click)=\"addSchemaPatternProperty(prop.key)\">\n              <button type=\"button\">{{ prop.value.title ? prop.value.title : prop.key }}</button>\n            </li>\n            <ng-template [ngIf]=\"!schema || schema.additionalProperties !== false\">\n              <li *ngFor=\"let dataType of dataTypes\" (click)=\"addProperty(dataType)\">\n                <button type=\"button\">{{ dataType.name }}</button>\n              </li>\n            </ng-template>\n          </ul>\n        </ngx-dropdown-menu>\n      </ngx-dropdown>\n    </div>\n  </div>\n</div>\n\n<!-- Property Config Dialog -->\n<ng-template #propertyConfigTmpl let-context=\"context\">\n  <ngx-property-config\n    [property]=\"context.property\"\n    [index]=\"context.index\"\n    [schema]=\"context.schema\"\n    [formats]=\"context.formats\"\n    (updateSchema)=\"updateSchema($event)\"\n  >\n  </ngx-property-config>\n</ng-template>\n",
            encapsulation: ViewEncapsulation.None,
            changeDetection: ChangeDetectionStrategy.OnPush,
            styles: [".object-node-flat .object-node-content{display:-webkit-box;display:flex;margin-bottom:5px;position:relative}.object-node-flat .object-node-content ngx-json-editor-node-flat{-webkit-box-flex:1;flex:1}.object-node-flat .add-button{height:100px;position:relative;display:-webkit-box;display:flex}.object-node-flat .add-button ngx-dropdown{padding-bottom:0}.object-node-flat .compressed.add-button{max-height:80px}.object-node-flat .background.add-button{background-color:rgba(49,56,71,.4);padding:7px 7px 7px 0;height:120px}.object-node-flat .add-button .indented-content{border:2px dotted rgba(59,68,87,.5);width:100%;display:-webkit-box;display:flex;-webkit-box-pack:center;justify-content:center;-webkit-box-align:center;align-items:center;color:#909cb4}.object-node-flat .add-button .indented-content button{display:-webkit-box;display:flex}.object-node-flat .add-button .indented-content button i{font-size:18px}.object-node-flat .add-button .indented-content button span{font-size:14px;margin-left:10px}.object-node-flat .add-button .indented-content .ngx-dropdown-menu{white-space:nowrap;margin-top:10px}.object-node-flat .add-button .indented-content .ngx-dropdown-menu .dropdown-column{vertical-align:top;display:inline-block;min-width:150px}.object-node-flat .add-button .indented-content .ngx-dropdown-menu .dropdown-column:nth-child(2){border-left:1px solid #505c75}.indentation-placeholder{border-radius:2px 0 0 2px;display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;background-color:rgba(49,56,71,.4)}.separator{background-color:#3b4457;opacity:.5;border-radius:2px;width:1px;height:calc(100% - 4px);margin-right:20px}.separator:first-child{margin-left:20px}.object-node-flat{margin-top:5px}.cdk-drag-preview .indentation{opacity:.5}.cdk-drag-preview .add-button{display:none}.cdk-drag-animating,.object-node-flat.cdk-drop-list-dragging .object-node-content:not(.cdk-drag-placeholder){-webkit-transition:-webkit-transform 250ms cubic-bezier(0,0,.2,1);transition:transform 250ms cubic-bezier(0,0,.2,1);transition:transform 250ms cubic-bezier(0,0,.2,1),-webkit-transform 250ms cubic-bezier(0,0,.2,1)}.indentation-placeholder{position:relative;height:117px;margin-bottom:5px;-webkit-transition:-webkit-transform 250ms cubic-bezier(0,0,.2,1);transition:transform 250ms cubic-bezier(0,0,.2,1),-webkit-transform 250ms cubic-bezier(0,0,.2,1)}"]
        }),
        __metadata("design:paramtypes", [DialogService, ChangeDetectorRef])
    ], ObjectNodeFlatComponent);
    return ObjectNodeFlatComponent;
}(ObjectNode));
export { ObjectNodeFlatComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JqZWN0LW5vZGUtZmxhdC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ac3dpbWxhbmUvbmd4LXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvanNvbi1lZGl0b3IvanNvbi1lZGl0b3ItZmxhdC9qc29uLWVkaXRvci1ub2RlLWZsYXQvbm9kZS10eXBlcy9vYmplY3Qtbm9kZS1mbGF0L29iamVjdC1ub2RlLWZsYXQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULGlCQUFpQixFQUNqQixLQUFLLEVBQ0wsU0FBUyxFQUNULFdBQVcsRUFDWCxNQUFNLEVBQ04sdUJBQXVCLEVBQ3ZCLGlCQUFpQixFQUNsQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sOENBQThDLENBQUM7QUFDMUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ3JFLE9BQU8sRUFFTCxtQkFBbUIsRUFFbkIsb0JBQW9CLEVBQ3JCLE1BQU0sZ0NBQWdDLENBQUM7QUFDeEMsT0FBTyxFQUFlLGVBQWUsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBVXRFO0lBQTZDLDJDQUFVO0lBaUJyRCxpQ0FBb0IsYUFBNEIsRUFBWSxHQUFzQjtRQUFsRixZQUNFLGtCQUFNLEdBQUcsQ0FBQyxTQUNYO1FBRm1CLG1CQUFhLEdBQWIsYUFBYSxDQUFlO1FBQVksU0FBRyxHQUFILEdBQUcsQ0FBbUI7UUFKbEYsc0JBQWdCLEdBQWEsRUFBRSxDQUFDO1FBRWhDLGdCQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQzs7SUFJekIsQ0FBQztJQUVELDBDQUFRLEdBQVI7UUFBQSxpQkFhQztRQVpDLElBQUksSUFBSSxDQUFDLGlCQUFpQixFQUFFO1lBQzFCLElBQUksQ0FBQyxTQUFTLFlBQU8sbUJBQW1CLEVBQUssSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQzVEO1FB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SUFFOUI7UUFBUixLQUFLLEVBQUU7OytEQUFxQjtJQUVwQjtRQUFSLEtBQUssRUFBRTs7NkRBQVU7SUFYUCx1QkFBdUI7UUFQbkMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLDJCQUEyQjtZQUNyQyxxMUtBQWdEO1lBRWhELGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJO1lBQ3JDLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNOztTQUNoRCxDQUFDO3lDQWtCbUMsYUFBYSxFQUFpQixpQkFBaUI7T0FqQnZFLHVCQUF1QixDQW1NbkM7SUFBRCw4QkFBQztDQUFBLEFBbk1ELENBQTZDLFVBQVUsR0FtTXREO1NBbk1ZLHVCQUF1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgVmlld0VuY2Fwc3VsYXRpb24sXG4gIElucHV0LFxuICBWaWV3Q2hpbGQsXG4gIFRlbXBsYXRlUmVmLFxuICBPbkluaXQsXG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDaGFuZ2VEZXRlY3RvclJlZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9iamVjdE5vZGUgfSBmcm9tICcuLi8uLi8uLi8uLi9ub2RlLXR5cGVzL29iamVjdC1ub2RlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBEaWFsb2dTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vZGlhbG9nL2RpYWxvZy5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIEpzb25TY2hlbWFEYXRhVHlwZSxcbiAganNvblNjaGVtYURhdGFUeXBlcyxcbiAgSlNPTkVkaXRvclNjaGVtYSxcbiAgY3JlYXRlVmFsdWVGb3JTY2hlbWFcbn0gZnJvbSAnLi4vLi4vLi4vLi4vanNvbi1lZGl0b3IuaGVscGVyJztcbmltcG9ydCB7IENka0RyYWdEcm9wLCBtb3ZlSXRlbUluQXJyYXkgfSBmcm9tICdAYW5ndWxhci9jZGsvZHJhZy1kcm9wJztcbmltcG9ydCB7IFByb3BlcnR5Q29uZmlnT3B0aW9ucywgUHJvcGVydHlDb25maWdDb21wb25lbnQgfSBmcm9tICcuLi9wcm9wZXJ0eS1jb25maWcvcHJvcGVydHktY29uZmlnLmNvbXBvbmVudCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ25neC1qc29uLW9iamVjdC1ub2RlLWZsYXQnLFxuICB0ZW1wbGF0ZVVybDogJy4vb2JqZWN0LW5vZGUtZmxhdC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL29iamVjdC1ub2RlLWZsYXQuY29tcG9uZW50LnNjc3MnXSxcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZSxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2hcbn0pXG5leHBvcnQgY2xhc3MgT2JqZWN0Tm9kZUZsYXRDb21wb25lbnQgZXh0ZW5kcyBPYmplY3ROb2RlIGltcGxlbWVudHMgT25Jbml0IHtcbiAgQFZpZXdDaGlsZCgncHJvcGVydHlDb25maWdUbXBsJywgeyBzdGF0aWM6IGZhbHNlIH0pIHByb3BlcnR5Q29uZmlnVG1wbDogVGVtcGxhdGVSZWY8UHJvcGVydHlDb25maWdDb21wb25lbnQ+O1xuXG4gIEBJbnB1dCgpIGxldmVsOiBudW1iZXI7XG5cbiAgQElucHV0KCkgc2NoZW1hQnVpbGRlck1vZGU6IGJvb2xlYW47XG5cbiAgQElucHV0KCkgZm9ybWF0czogSnNvblNjaGVtYURhdGFUeXBlW107XG5cbiAgQElucHV0KCkgY29tcHJlc3NlZDogYm9vbGVhbjtcblxuICBASW5wdXQoKSBoaWRlUm9vdDtcblxuICBpbmRlbnRhdGlvbkFycmF5OiBudW1iZXJbXSA9IFtdO1xuXG4gIG9iamVjdEtleXMgPSBPYmplY3Qua2V5cztcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRpYWxvZ1NlcnZpY2U6IERpYWxvZ1NlcnZpY2UsIHByb3RlY3RlZCBjZHI6IENoYW5nZURldGVjdG9yUmVmKSB7XG4gICAgc3VwZXIoY2RyKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICh0aGlzLnNjaGVtYUJ1aWxkZXJNb2RlKSB7XG4gICAgICB0aGlzLmRhdGFUeXBlcyA9IFsuLi5qc29uU2NoZW1hRGF0YVR5cGVzLCAuLi50aGlzLmZvcm1hdHNdO1xuICAgIH1cblxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5pbml0U2NoZW1hUHJvcGVydGllcyh0aGlzLnNjaGVtYSk7XG4gICAgICB0aGlzLmluaXRTY2hlbWFQcm9wZXJ0aWVzKHRoaXMuc2NoZW1hUmVmKTtcbiAgICB9KTtcblxuICAgIGlmICh0aGlzLmxldmVsID4gMCkge1xuICAgICAgdGhpcy5pbmRlbnRhdGlvbkFycmF5ID0gQXJyYXkodGhpcy5sZXZlbCkuZmlsbCh0aGlzLmxldmVsKTtcbiAgICB9XG4gIH1cblxuICBvblVwZGF0ZVByb3BlcnR5TmFtZShvcHRpb25zOiB7IGlkOiBzdHJpbmc7IG5hbWU6IHN0cmluZyB9KTogdm9pZCB7XG4gICAgdGhpcy51cGRhdGVQcm9wZXJ0eU5hbWUob3B0aW9ucy5pZCwgb3B0aW9ucy5uYW1lKTtcbiAgfVxuXG4gIG9uUHJvcGVydHlDb25maWcocHJvcGVydHk6IEpTT05FZGl0b3JTY2hlbWEsIGluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLmRpYWxvZ1NlcnZpY2UuY3JlYXRlKHtcbiAgICAgIHRlbXBsYXRlOiB0aGlzLnByb3BlcnR5Q29uZmlnVG1wbCxcbiAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgcHJvcGVydHksXG4gICAgICAgIGluZGV4LFxuICAgICAgICBzY2hlbWE6IHRoaXMuc2NoZW1hLFxuICAgICAgICBmb3JtYXRzOiB0aGlzLmZvcm1hdHNcbiAgICAgIH0sXG4gICAgICBjbGFzczogJ3Byb3BlcnR5LWNvbmZpZy1kaWFsb2cnXG4gICAgfSk7XG4gIH1cblxuICB1cGRhdGVTY2hlbWEob3B0aW9uczogUHJvcGVydHlDb25maWdPcHRpb25zKTogdm9pZCB7XG4gICAgY29uc3Qgb2xkUHJvcGVydHkgPSBvcHRpb25zLm9sZFByb3BlcnR5O1xuICAgIGNvbnN0IG5ld1Byb3BlcnR5ID0gb3B0aW9ucy5uZXdQcm9wZXJ0eTtcblxuICAgIGNvbnN0IG9sZE5hbWUgPSBvbGRQcm9wZXJ0eS5wcm9wZXJ0eU5hbWU7XG4gICAgY29uc3QgbmV3TmFtZSA9IG5ld1Byb3BlcnR5LnByb3BlcnR5TmFtZTtcblxuICAgIGlmIChuZXdOYW1lICE9PSBvbGROYW1lKSB7XG4gICAgICBpZiAob2xkTmFtZSBpbiB0aGlzLnNjaGVtYS5wcm9wZXJ0aWVzKSB7XG4gICAgICAgIHRoaXMudXBkYXRlU2NoZW1hUHJvcGVydHlOYW1lKHRoaXMuc2NoZW1hLCBuZXdOYW1lLCBvbGROYW1lKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy51cGRhdGVTY2hlbWFQcm9wZXJ0eU5hbWUodGhpcy5zY2hlbWFSZWYsIG5ld05hbWUsIG9sZE5hbWUpO1xuICAgICAgdGhpcy51cGRhdGVQcm9wZXJ0eU5hbWUob3B0aW9ucy5uZXdQcm9wZXJ0eS5pZCwgbmV3TmFtZSk7XG4gICAgfVxuXG4gICAgdGhpcy50b2dnbGVSZXF1aXJlZFZhbHVlKG9wdGlvbnMucmVxdWlyZWQsIG5ld05hbWUpO1xuXG4gICAgdGhpcy5zY2hlbWEucHJvcGVydGllc1tuZXdOYW1lXSA9IG5ld1Byb3BlcnR5O1xuICAgIHRoaXMucHJvcGVydHlJbmRleFtvcHRpb25zLm5ld1Byb3BlcnR5LmlkXSA9IG5ld1Byb3BlcnR5O1xuICAgIHRoaXMudXBkYXRlU2NoZW1hUmVmUHJvcGVydHkobmV3UHJvcGVydHkpO1xuXG4gICAgaWYgKG5ld05hbWUgIT09IG9sZE5hbWUpIHtcbiAgICAgIHRoaXMuc3dhcFNjaGVtYVByb3BlcnRpZXMob3B0aW9ucy5pbmRleCk7XG4gICAgfVxuXG4gICAgaWYgKG9sZFByb3BlcnR5LnR5cGUgIT09IG5ld1Byb3BlcnR5LnR5cGUpIHtcbiAgICAgIGNvbnN0IHZhbHVlOiBhbnkgPSBjcmVhdGVWYWx1ZUZvclNjaGVtYShuZXdQcm9wZXJ0eSk7XG4gICAgICB0aGlzLm1vZGVsW25ld1Byb3BlcnR5LnByb3BlcnR5TmFtZV0gPSB2YWx1ZTtcbiAgICB9XG5cbiAgICB0aGlzLnByb3BlcnR5SW5kZXggPSB7IC4uLnRoaXMucHJvcGVydHlJbmRleCB9O1xuICAgIHRoaXMuc2NoZW1hQ2hhbmdlLmVtaXQoKTtcbiAgfVxuXG4gIGFkZFByb3BlcnR5KGRhdGFUeXBlOiBKc29uU2NoZW1hRGF0YVR5cGUpOiB2b2lkIHtcbiAgICBzdXBlci5hZGRQcm9wZXJ0eShkYXRhVHlwZSk7XG5cbiAgICB0aGlzLnVwZGF0ZVNjaGVtYVJlZlByb3BlcnR5KHRoaXMucHJvcGVydHlJbmRleFt0aGlzLnByb3BlcnR5SWQgLSAxXSk7XG4gICAgdGhpcy5zY2hlbWFDaGFuZ2UuZW1pdCgpO1xuICB9XG5cbiAgZGVsZXRlUHJvcGVydHkocHJvcE5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLnNjaGVtYUJ1aWxkZXJNb2RlKSB7XG4gICAgICBkZWxldGUgdGhpcy5zY2hlbWEucHJvcGVydGllc1twcm9wTmFtZV07XG4gICAgICBkZWxldGUgdGhpcy5zY2hlbWFSZWYucHJvcGVydGllc1twcm9wTmFtZV07XG4gICAgICB0aGlzLnRvZ2dsZVJlcXVpcmVkVmFsdWUoZmFsc2UsIHByb3BOYW1lKTtcbiAgICB9IGVsc2UgaWYgKCF0aGlzLnNjaGVtYS5yZXF1aXJlZC5pbmNsdWRlcyhwcm9wTmFtZSkgJiYgIShwcm9wTmFtZSBpbiB0aGlzLnNjaGVtYS5wcm9wZXJ0aWVzKSkge1xuICAgICAgZGVsZXRlIHRoaXMuc2NoZW1hUmVmLnByb3BlcnRpZXNbcHJvcE5hbWVdO1xuICAgIH1cblxuICAgIHRoaXMuc2NoZW1hQ2hhbmdlLmVtaXQoKTtcbiAgICBzdXBlci5kZWxldGVQcm9wZXJ0eShwcm9wTmFtZSk7XG4gIH1cblxuICBkcm9wKGV2ZW50OiBDZGtEcmFnRHJvcDxzdHJpbmdbXT4pOiB2b2lkIHtcbiAgICBjb25zdCBwcm9wZXJ0eUluZGV4VmFsdWVzID0gT2JqZWN0LnZhbHVlcyh0aGlzLnByb3BlcnR5SW5kZXgpO1xuXG4gICAgbW92ZUl0ZW1JbkFycmF5KHByb3BlcnR5SW5kZXhWYWx1ZXMsIGV2ZW50LnByZXZpb3VzSW5kZXgsIGV2ZW50LmN1cnJlbnRJbmRleCk7XG5cbiAgICBsZXQgaW5kZXggPSAwO1xuICAgIGZvciAoY29uc3QgcHJvcCBpbiB0aGlzLnByb3BlcnR5SW5kZXgpIHtcbiAgICAgIHRoaXMucHJvcGVydHlJbmRleFtwcm9wXSA9IHByb3BlcnR5SW5kZXhWYWx1ZXNbaW5kZXhdO1xuICAgICAgdGhpcy5wcm9wZXJ0eUluZGV4W3Byb3BdLmlkID0gcGFyc2VJbnQocHJvcCwgMTApO1xuICAgICAgaW5kZXggKz0gMTtcbiAgICB9XG5cbiAgICB0aGlzLnByb3BlcnR5SW5kZXggPSB7IC4uLnRoaXMucHJvcGVydHlJbmRleCB9O1xuXG4gICAgdGhpcy5zd2FwU2NoZW1hUHJvcGVydGllcyhldmVudC5jdXJyZW50SW5kZXgsIGV2ZW50LnByZXZpb3VzSW5kZXgpO1xuICB9XG5cbiAgcHJpdmF0ZSBzd2FwU2NoZW1hUHJvcGVydGllcyhjdXJyZW50SW5kZXg6IG51bWJlciwgcHJldmlvdXNJbmRleD86IG51bWJlcik6IHZvaWQge1xuICAgIGNvbnN0IHByb3BlcnRpZXNJZHMgPSBPYmplY3Qua2V5cyh0aGlzLnNjaGVtYVJlZi5wcm9wZXJ0aWVzKTtcblxuICAgIGlmIChwcmV2aW91c0luZGV4ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHByZXZpb3VzSW5kZXggPSBwcm9wZXJ0aWVzSWRzLmxlbmd0aCAtIDE7XG4gICAgfVxuXG4gICAgbW92ZUl0ZW1JbkFycmF5KHByb3BlcnRpZXNJZHMsIHByZXZpb3VzSW5kZXgsIGN1cnJlbnRJbmRleCk7XG5cbiAgICB0aGlzLnNjaGVtYVJlZi5wcm9wZXJ0aWVzID0gcHJvcGVydGllc0lkcy5yZWR1Y2UoKHJlc3VsdCwgcHJvcCkgPT4ge1xuICAgICAgcmVzdWx0W3Byb3BdID0gdGhpcy5zY2hlbWFSZWYucHJvcGVydGllc1twcm9wXTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSwge30pO1xuXG4gICAgdGhpcy5zY2hlbWFDaGFuZ2UuZW1pdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0U2NoZW1hUHJvcGVydGllcyhzY2hlbWE6IEpTT05FZGl0b3JTY2hlbWEpOiB2b2lkIHtcbiAgICBpZiAoc2NoZW1hKSB7XG4gICAgICBzY2hlbWEucmVxdWlyZWQgPSBzY2hlbWEucmVxdWlyZWQgfHwgW107XG4gICAgICBzY2hlbWEucHJvcGVydGllcyA9IHNjaGVtYS5wcm9wZXJ0aWVzIHx8IHt9O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlU2NoZW1hUmVmUHJvcGVydHkocHJvcDogYW55KTogdm9pZCB7XG4gICAgdGhpcy5zY2hlbWFSZWYucHJvcGVydGllc1twcm9wLnByb3BlcnR5TmFtZV0gPSB7XG4gICAgICB0eXBlOiBwcm9wLnR5cGUsXG4gICAgICAuLi4ocHJvcFsnZm9ybWF0J10gJiYgeyBmb3JtYXQ6IHByb3BbJ2Zvcm1hdCddIH0pLFxuICAgICAgLi4uKHByb3BbJ3RpdGxlJ10gJiYgeyB0aXRsZTogcHJvcFsndGl0bGUnXSB9KSxcbiAgICAgIC4uLihwcm9wWydpdGVtcyddICYmIHsgaXRlbXM6IHByb3BbJ2l0ZW1zJ10gfSksXG4gICAgICAuLi4ocHJvcFsncmVxdWlyZWQnXSAmJiB7IHJlcXVpcmVkOiBwcm9wWydyZXF1aXJlZCddIH0pLFxuICAgICAgLi4uKHByb3BbJ3Byb3BlcnRpZXMnXSAmJiB7IHByb3BlcnRpZXM6IHByb3BbJ3Byb3BlcnRpZXMnXSB9KSxcbiAgICAgIC4uLihwcm9wWydlbnVtJ10gJiYgeyBlbnVtOiBwcm9wWydlbnVtJ10gfSksXG4gICAgICAuLi4ocHJvcFsnZGVmYXVsdCddICYmIHsgZGVmYXVsdDogcHJvcFsnZGVmYXVsdCddIH0pLFxuICAgICAgLi4uKHByb3BbJ2Rlc2NyaXB0aW9uJ10gJiYgeyBkZXNjcmlwdGlvbjogcHJvcFsnZGVzY3JpcHRpb24nXSB9KSxcbiAgICAgIC4uLihwcm9wWyduYW1lRWRpdGFibGUnXSAmJiB7IG5hbWVFZGl0YWJsZTogcHJvcFsnbmFtZUVkaXRhYmxlJ10gfSksXG4gICAgICAuLi4ocHJvcFsnbWluaW11bSddICYmIHsgbWluaW11bTogcHJvcFsnbWluaW11bSddIH0pLFxuICAgICAgLi4uKHByb3BbJ21heGltdW0nXSAmJiB7IG1heGltdW06IHByb3BbJ21heGltdW0nXSB9KSxcbiAgICAgIC4uLihwcm9wWydtaW5MZW5ndGgnXSAmJiB7IG1pbkxlbmd0aDogcHJvcFsnbWluTGVuZ3RoJ10gfSksXG4gICAgICAuLi4ocHJvcFsnbWF4TGVuZ3RoJ10gJiYgeyBtYXhMZW5ndGg6IHByb3BbJ21heExlbmd0aCddIH0pLFxuICAgICAgLi4uKHByb3BbJ21pbkl0ZW1zJ10gJiYgeyBtaW5JdGVtczogcHJvcFsnbWluSXRlbXMnXSB9KSxcbiAgICAgIC4uLihwcm9wWydtYXhJdGVtcyddICYmIHsgbWF4SXRlbXM6IHByb3BbJ21heEl0ZW1zJ10gfSksXG4gICAgICAuLi4ocHJvcFsncGF0dGVybiddICYmIHsgcGF0dGVybjogcHJvcFsncGF0dGVybiddIH0pXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlU2NoZW1hUHJvcGVydHlOYW1lKHNjaGVtYTogSlNPTkVkaXRvclNjaGVtYSwgbmV3TmFtZTogc3RyaW5nLCBvbGROYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnVwZGF0ZVJlcXVpcmVkUHJvcGVydGllcyhzY2hlbWEsIG5ld05hbWUsIG9sZE5hbWUpO1xuICAgIHNjaGVtYS5wcm9wZXJ0aWVzW25ld05hbWVdID0gc2NoZW1hLnByb3BlcnRpZXNbb2xkTmFtZV07XG4gICAgZGVsZXRlIHNjaGVtYS5wcm9wZXJ0aWVzW29sZE5hbWVdO1xuICB9XG5cbiAgcHJpdmF0ZSB0b2dnbGVSZXF1aXJlZFZhbHVlKHJlcXVpcmVkOiBib29sZWFuLCBwcm9wZXJ0eU5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHJlcXVpcmVkSW5kZXggPSB0aGlzLnNjaGVtYS5yZXF1aXJlZC5pbmRleE9mKHByb3BlcnR5TmFtZSk7XG4gICAgaWYgKHJlcXVpcmVkSW5kZXggPj0gMCAmJiAhcmVxdWlyZWQpIHtcbiAgICAgIHRoaXMuc2NoZW1hLnJlcXVpcmVkLnNwbGljZShyZXF1aXJlZEluZGV4LCAxKTtcbiAgICB9IGVsc2UgaWYgKHJlcXVpcmVkSW5kZXggPCAwICYmIHJlcXVpcmVkKSB7XG4gICAgICB0aGlzLnNjaGVtYS5yZXF1aXJlZC5wdXNoKHByb3BlcnR5TmFtZSk7XG4gICAgfVxuXG4gICAgdGhpcy5zY2hlbWFSZWYucmVxdWlyZWQgPSBbLi4udGhpcy5zY2hlbWEucmVxdWlyZWRdO1xuICAgIHRoaXMudXBkYXRlUmVxdWlyZWRDYWNoZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVSZXF1aXJlZFByb3BlcnRpZXMoc2NoZW1hOiBKU09ORWRpdG9yU2NoZW1hLCBuZXdOYW1lOiBzdHJpbmcsIG9sZE5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHJlcXVpcmVkSW5kZXggPSBzY2hlbWEucmVxdWlyZWQuaW5kZXhPZihvbGROYW1lKTtcbiAgICBpZiAocmVxdWlyZWRJbmRleCA+PSAwKSB7XG4gICAgICBzY2hlbWEucmVxdWlyZWRbcmVxdWlyZWRJbmRleF0gPSBuZXdOYW1lO1xuICAgIH1cbiAgfVxufVxuIl19