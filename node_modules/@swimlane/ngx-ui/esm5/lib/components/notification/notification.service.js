import { __decorate, __extends, __metadata, __param, __values } from "tslib";
import { Injectable, Inject } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { InjectionService } from '../../services/injection/injection.service';
import { InjectionRegistryService } from '../../services/injection-registry/injection-registry.service';
import { NotificationType } from './notification-type.enum';
import { NotificationStyleType } from './notification-style-type.enum';
import { NotificationPermissionType } from './notification-permission-type.enum';
import { NotificationComponent } from './notification.component';
import { NotificationContainerComponent } from './notification-container.component';
/** adding dynamic to suppress `Document` type metadata error  */
/** @dynamic */
var NotificationService = /** @class */ (function (_super) {
    __extends(NotificationService, _super);
    function NotificationService(injectionService, document) {
        var _this = _super.call(this, injectionService) || this;
        _this.injectionService = injectionService;
        _this.document = document;
        _this.defaults = {
            inputs: {
                timeout: 3000,
                rateLimit: true,
                pauseOnHover: true,
                type: NotificationType.html,
                styleType: NotificationStyleType.none,
                showClose: true,
                sound: false
            }
        };
        _this.type = NotificationComponent;
        return _this;
    }
    NotificationService_1 = NotificationService;
    Object.defineProperty(NotificationService.prototype, "isNativeSupported", {
        get: function () {
            return 'Notification' in window;
        },
        enumerable: true,
        configurable: true
    });
    NotificationService.prototype.create = function (bindings) {
        // verify flood not happening
        if (bindings.rateLimit && this.isFlooded(bindings)) {
            return;
        }
        // if limit reached, remove the first one
        var compsByType = this.getByType();
        if (compsByType && compsByType.length >= NotificationService_1.limit) {
            this.destroy(compsByType[0]);
        }
        // native notifications need to be invoked
        var component;
        if (bindings.type === NotificationType.native) {
            component = this.showNative(bindings);
        }
        else {
            component = _super.prototype.create.call(this, bindings);
            this.createSubscriptions(component);
            this.startTimer(component);
        }
        return component;
    };
    NotificationService.prototype.startTimer = function (component) {
        var _this = this;
        if (component.instance && component.instance.timeout !== false) {
            clearTimeout(component.instance.timer);
            component.instance.timer = setTimeout(function () {
                _this.destroy(component);
            }, component.instance.timeout);
        }
    };
    NotificationService.prototype.pauseTimer = function (component) {
        clearTimeout(component.instance.timer);
    };
    NotificationService.prototype.requestPermissions = function () {
        var _this = this;
        if (this.isNativeSupported) {
            Notification.requestPermission(/* istanbul ignore next */ function (/* istanbul ignore next */ status) { return (_this.permission = status); });
        }
    };
    NotificationService.prototype.assignDefaults = function (options) {
        var bindings = _super.prototype.assignDefaults.call(this, options);
        if (bindings.inputs && bindings.inputs.timeout === true) {
            bindings.inputs.timeout = this.defaults.inputs.timeout;
        }
        // add a timestamp for flood checks
        bindings.inputs.timestamp = +new Date();
        return bindings;
    };
    NotificationService.prototype.injectComponent = function (type, options) {
        if (!this.container || !this.document.contains(this.container.location.nativeElement)) {
            this.container = this.injectionService.appendComponent(NotificationContainerComponent);
        }
        return this.injectionService.appendComponent(type, options, this.container);
    };
    NotificationService.prototype.createSubscriptions = function (component) {
        var _this = this;
        var pauseSub;
        var resumeSub;
        var closeSub;
        var kill = function () {
            closeSub.unsubscribe();
            resumeSub.unsubscribe();
            pauseSub.unsubscribe();
            _this.destroy(component);
        };
        var pause = function () {
            _this.pauseTimer(component);
        };
        var resume = function () {
            _this.startTimer(component);
        };
        pauseSub = component.instance.pause.subscribe(pause);
        resumeSub = component.instance.resume.subscribe(resume);
        closeSub = component.instance.close.subscribe(kill);
    };
    NotificationService.prototype.isFlooded = function (options) {
        var e_1, _a;
        var compsByType = this.getByType();
        try {
            for (var compsByType_1 = __values(compsByType), compsByType_1_1 = compsByType_1.next(); !compsByType_1_1.done; compsByType_1_1 = compsByType_1.next()) {
                var notification = compsByType_1_1.value;
                var instance = notification.instance;
                if (instance.title === options.title &&
                    instance.body === options.body &&
                    instance.timestamp + 1000 > options.timestamp) {
                    return true;
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (compsByType_1_1 && !compsByType_1_1.done && (_a = compsByType_1.return)) _a.call(compsByType_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        return false;
    };
    NotificationService.prototype.showNative = function (options) {
        if (!this.isNativeSupported)
            return;
        if (!this.permission)
            this.requestPermissions();
        if (this.permission === NotificationPermissionType.denied)
            return;
        var note = new Notification(options.title, options);
        note.onerror = function () {
            console.error('Notification failed!', options);
        };
        // manually do this
        if (options && typeof options.timeout === 'number') {
            setTimeout(note.close.bind(note), options.timeout);
        }
        return note;
    };
    var NotificationService_1;
    NotificationService.limit = 10;
    NotificationService.ctorParameters = function () { return [
        { type: InjectionService },
        { type: Document, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
    ]; };
    NotificationService = NotificationService_1 = __decorate([
        Injectable(),
        __param(1, Inject(DOCUMENT)),
        __metadata("design:paramtypes", [InjectionService, Document])
    ], NotificationService);
    return NotificationService;
}(InjectionRegistryService));
export { NotificationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZpY2F0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ac3dpbWxhbmUvbmd4LXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvbm90aWZpY2F0aW9uL25vdGlmaWNhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFnQixNQUFNLEVBQVEsTUFBTSxlQUFlLENBQUM7QUFDdkUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRzNDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDRDQUE0QyxDQUFDO0FBQzlFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDhEQUE4RCxDQUFDO0FBR3hHLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzVELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ2pGLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBR3BGLGlFQUFpRTtBQUNqRSxlQUFlO0FBRWY7SUFBeUMsdUNBQStDO0lBc0J0Riw2QkFBcUIsZ0JBQWtDLEVBQXFDLFFBQWtCO1FBQTlHLFlBQ0Usa0JBQU0sZ0JBQWdCLENBQUMsU0FDeEI7UUFGb0Isc0JBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUFxQyxjQUFRLEdBQVIsUUFBUSxDQUFVO1FBcEJyRyxjQUFRLEdBQXdCO1lBQ3ZDLE1BQU0sRUFBRTtnQkFDTixPQUFPLEVBQUUsSUFBSTtnQkFDYixTQUFTLEVBQUUsSUFBSTtnQkFDZixZQUFZLEVBQUUsSUFBSTtnQkFDbEIsSUFBSSxFQUFFLGdCQUFnQixDQUFDLElBQUk7Z0JBQzNCLFNBQVMsRUFBRSxx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VSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUNwRDtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQzs7SUE1SmUseUJBQUssR0FBcUIsRUFBRSxDQUFDOztnQkFxQk4sZ0JBQWdCO2dCQUErQyxRQUFRLHVCQUFwRCxNQUFNLFNBQUMsUUFBUTs7SUF0QjlELG1CQUFtQjtRQUQvQixVQUFVLEVBQUU7UUF1QitDLFdBQUEsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFBO3lDQUFuQyxnQkFBZ0IsRUFBK0MsUUFBUTtPQXRCbkcsbUJBQW1CLENBOEovQjtJQUFELDBCQUFDO0NBQUEsQUE5SkQsQ0FBeUMsd0JBQXdCLEdBOEpoRTtTQTlKWSxtQkFBbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBDb21wb25lbnRSZWYsIEluamVjdCwgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IEluamVjdGlvblNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9pbmplY3Rpb24vaW5qZWN0aW9uLnNlcnZpY2UnO1xuaW1wb3J0IHsgSW5qZWN0aW9uUmVnaXN0cnlTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvaW5qZWN0aW9uLXJlZ2lzdHJ5L2luamVjdGlvbi1yZWdpc3RyeS5zZXJ2aWNlJztcbmltcG9ydCB7IFBhcnRpYWxCaW5kaW5ncyB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2luamVjdGlvbi1yZWdpc3RyeS9wYXJ0aWFsLWJpbmRpbmdzLmludGVyZmFjZSc7XG5cbmltcG9ydCB7IE5vdGlmaWNhdGlvblR5cGUgfSBmcm9tICcuL25vdGlmaWNhdGlvbi10eXBlLmVudW0nO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uU3R5bGVUeXBlIH0gZnJvbSAnLi9ub3RpZmljYXRpb24tc3R5bGUtdHlwZS5lbnVtJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvblBlcm1pc3Npb25UeXBlIH0gZnJvbSAnLi9ub3RpZmljYXRpb24tcGVybWlzc2lvbi10eXBlLmVudW0nO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uQ29tcG9uZW50IH0gZnJvbSAnLi9ub3RpZmljYXRpb24uY29tcG9uZW50JztcbmltcG9ydCB7IE5vdGlmaWNhdGlvbkNvbnRhaW5lckNvbXBvbmVudCB9IGZyb20gJy4vbm90aWZpY2F0aW9uLWNvbnRhaW5lci5jb21wb25lbnQnO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uT3B0aW9ucyB9IGZyb20gJy4vbm90aWZpY2F0aW9uLW9wdGlvbnMuaW50ZXJmYWNlJztcblxuLyoqIGFkZGluZyBkeW5hbWljIHRvIHN1cHByZXNzIGBEb2N1bWVudGAgdHlwZSBtZXRhZGF0YSBlcnJvciAgKi9cbi8qKiBAZHluYW1pYyAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5vdGlmaWNhdGlvblNlcnZpY2UgZXh0ZW5kcyBJbmplY3Rpb25SZWdpc3RyeVNlcnZpY2U8Tm90aWZpY2F0aW9uQ29tcG9uZW50PiB7XG4gIHN0YXRpYyByZWFkb25seSBsaW1pdDogbnVtYmVyIHwgYm9vbGVhbiA9IDEwO1xuICByZWFkb25seSBkZWZhdWx0czogTm90aWZpY2F0aW9uT3B0aW9ucyA9IHtcbiAgICBpbnB1dHM6IHtcbiAgICAgIHRpbWVvdXQ6IDMwMDAsXG4gICAgICByYXRlTGltaXQ6IHRydWUsXG4gICAgICBwYXVzZU9uSG92ZXI6IHRydWUsXG4gICAgICB0eXBlOiBOb3RpZmljYXRpb25UeXBlLmh0bWwsXG4gICAgICBzdHlsZVR5cGU6IE5vdGlmaWNhdGlvblN0eWxlVHlwZS5ub25lLFxuICAgICAgc2hvd0Nsb3NlOiB0cnVlLFxuICAgICAgc291bmQ6IGZhbHNlXG4gICAgfVxuICB9O1xuXG4gIHBlcm1pc3Npb246IE5vdGlmaWNhdGlvblBlcm1pc3Npb247XG4gIGNvbnRhaW5lcj86IENvbXBvbmVudFJlZjxOb3RpZmljYXRpb25Db250YWluZXJDb21wb25lbnQ+O1xuICB0eXBlID0gTm90aWZpY2F0aW9uQ29tcG9uZW50O1xuXG4gIGdldCBpc05hdGl2ZVN1cHBvcnRlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gJ05vdGlmaWNhdGlvbicgaW4gd2luZG93O1xuICB9XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgaW5qZWN0aW9uU2VydmljZTogSW5qZWN0aW9uU2VydmljZSwgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSByZWFkb25seSBkb2N1bWVudDogRG9jdW1lbnQpIHtcbiAgICBzdXBlcihpbmplY3Rpb25TZXJ2aWNlKTtcbiAgfVxuXG4gIGNyZWF0ZShiaW5kaW5nczogUGFydGlhbDxOb3RpZmljYXRpb25PcHRpb25zPik6IENvbXBvbmVudFJlZjxOb3RpZmljYXRpb25Db21wb25lbnQ+IHtcbiAgICAvLyB2ZXJpZnkgZmxvb2Qgbm90IGhhcHBlbmluZ1xuICAgIGlmIChiaW5kaW5ncy5yYXRlTGltaXQgJiYgdGhpcy5pc0Zsb29kZWQoYmluZGluZ3MpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gaWYgbGltaXQgcmVhY2hlZCwgcmVtb3ZlIHRoZSBmaXJzdCBvbmVcbiAgICBjb25zdCBjb21wc0J5VHlwZSA9IHRoaXMuZ2V0QnlUeXBlKCk7XG5cbiAgICBpZiAoY29tcHNCeVR5cGUgJiYgY29tcHNCeVR5cGUubGVuZ3RoID49IE5vdGlmaWNhdGlvblNlcnZpY2UubGltaXQpIHtcbiAgICAgIHRoaXMuZGVzdHJveShjb21wc0J5VHlwZVswXSk7XG4gICAgfVxuXG4gICAgLy8gbmF0aXZlIG5vdGlmaWNhdGlvbnMgbmVlZCB0byBiZSBpbnZva2VkXG4gICAgbGV0IGNvbXBvbmVudDogQ29tcG9uZW50UmVmPE5vdGlmaWNhdGlvbkNvbXBvbmVudD4gfCBOb3RpZmljYXRpb247XG5cbiAgICBpZiAoYmluZGluZ3MudHlwZSA9PT0gTm90aWZpY2F0aW9uVHlwZS5uYXRpdmUpIHtcbiAgICAgIGNvbXBvbmVudCA9IHRoaXMuc2hvd05hdGl2ZShiaW5kaW5ncyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbXBvbmVudCA9IHN1cGVyLmNyZWF0ZShiaW5kaW5ncyk7XG4gICAgICB0aGlzLmNyZWF0ZVN1YnNjcmlwdGlvbnMoY29tcG9uZW50KTtcbiAgICAgIHRoaXMuc3RhcnRUaW1lcihjb21wb25lbnQpO1xuICAgIH1cblxuICAgIHJldHVybiBjb21wb25lbnQgYXMgYW55O1xuICB9XG5cbiAgc3RhcnRUaW1lcihjb21wb25lbnQ6IENvbXBvbmVudFJlZjxOb3RpZmljYXRpb25Db21wb25lbnQ+KTogdm9pZCB7XG4gICAgaWYgKGNvbXBvbmVudC5pbnN0YW5jZSAmJiBjb21wb25lbnQuaW5zdGFuY2UudGltZW91dCAhPT0gZmFsc2UpIHtcbiAgICAgIGNsZWFyVGltZW91dChjb21wb25lbnQuaW5zdGFuY2UudGltZXIpO1xuXG4gICAgICBjb21wb25lbnQuaW5zdGFuY2UudGltZXIgPSBzZXRUaW1lb3V0KFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5kZXN0cm95KGNvbXBvbmVudCk7XG4gICAgICAgIH0sXG4gICAgICAgIGNvbXBvbmVudC5pbnN0YW5jZS50aW1lb3V0IGFzIG51bWJlclxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwYXVzZVRpbWVyKGNvbXBvbmVudDogQ29tcG9uZW50UmVmPE5vdGlmaWNhdGlvbkNvbXBvbmVudD4pOiB2b2lkIHtcbiAgICBjbGVhclRpbWVvdXQoY29tcG9uZW50Lmluc3RhbmNlLnRpbWVyKTtcbiAgfVxuXG4gIHJlcXVlc3RQZXJtaXNzaW9ucygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pc05hdGl2ZVN1cHBvcnRlZCkge1xuICAgICAgTm90aWZpY2F0aW9uLnJlcXVlc3RQZXJtaXNzaW9uKC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovIHN0YXR1cyA9PiAodGhpcy5wZXJtaXNzaW9uID0gc3RhdHVzKSk7XG4gICAgfVxuICB9XG5cbiAgYXNzaWduRGVmYXVsdHMob3B0aW9uczogUGFydGlhbDxOb3RpZmljYXRpb25PcHRpb25zPik6IFBhcnRpYWxCaW5kaW5ncyB7XG4gICAgY29uc3QgYmluZGluZ3MgPSBzdXBlci5hc3NpZ25EZWZhdWx0cyhvcHRpb25zIGFzIGFueSk7XG5cbiAgICBpZiAoYmluZGluZ3MuaW5wdXRzICYmIGJpbmRpbmdzLmlucHV0cy50aW1lb3V0ID09PSB0cnVlKSB7XG4gICAgICBiaW5kaW5ncy5pbnB1dHMudGltZW91dCA9IHRoaXMuZGVmYXVsdHMuaW5wdXRzLnRpbWVvdXQ7XG4gICAgfVxuXG4gICAgLy8gYWRkIGEgdGltZXN0YW1wIGZvciBmbG9vZCBjaGVja3NcbiAgICBiaW5kaW5ncy5pbnB1dHMudGltZXN0YW1wID0gK25ldyBEYXRlKCk7XG4gICAgcmV0dXJuIGJpbmRpbmdzO1xuICB9XG5cbiAgaW5qZWN0Q29tcG9uZW50KHR5cGU6IFR5cGU8Tm90aWZpY2F0aW9uQ29udGFpbmVyQ29tcG9uZW50Piwgb3B0aW9uczogUGFydGlhbEJpbmRpbmdzKTogQ29tcG9uZW50UmVmPGFueT4ge1xuICAgIGlmICghdGhpcy5jb250YWluZXIgfHwgIXRoaXMuZG9jdW1lbnQuY29udGFpbnModGhpcy5jb250YWluZXIubG9jYXRpb24ubmF0aXZlRWxlbWVudCkpIHtcbiAgICAgIHRoaXMuY29udGFpbmVyID0gdGhpcy5pbmplY3Rpb25TZXJ2aWNlLmFwcGVuZENvbXBvbmVudChOb3RpZmljYXRpb25Db250YWluZXJDb21wb25lbnQpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmluamVjdGlvblNlcnZpY2UuYXBwZW5kQ29tcG9uZW50KHR5cGUsIG9wdGlvbnMsIHRoaXMuY29udGFpbmVyKTtcbiAgfVxuXG4gIGNyZWF0ZVN1YnNjcmlwdGlvbnMoY29tcG9uZW50OiBDb21wb25lbnRSZWY8Tm90aWZpY2F0aW9uQ29tcG9uZW50Pik6IGFueSB7XG4gICAgbGV0IHBhdXNlU3ViOiBTdWJzY3JpcHRpb247XG4gICAgbGV0IHJlc3VtZVN1YjogU3Vic2NyaXB0aW9uO1xuICAgIGxldCBjbG9zZVN1YjogU3Vic2NyaXB0aW9uO1xuXG4gICAgY29uc3Qga2lsbCA9ICgpID0+IHtcbiAgICAgIGNsb3NlU3ViLnVuc3Vic2NyaWJlKCk7XG4gICAgICByZXN1bWVTdWIudW5zdWJzY3JpYmUoKTtcbiAgICAgIHBhdXNlU3ViLnVuc3Vic2NyaWJlKCk7XG5cbiAgICAgIHRoaXMuZGVzdHJveShjb21wb25lbnQpO1xuICAgIH07XG5cbiAgICBjb25zdCBwYXVzZSA9ICgpID0+IHtcbiAgICAgIHRoaXMucGF1c2VUaW1lcihjb21wb25lbnQpO1xuICAgIH07XG5cbiAgICBjb25zdCByZXN1bWUgPSAoKSA9PiB7XG4gICAgICB0aGlzLnN0YXJ0VGltZXIoY29tcG9uZW50KTtcbiAgICB9O1xuXG4gICAgcGF1c2VTdWIgPSBjb21wb25lbnQuaW5zdGFuY2UucGF1c2Uuc3Vic2NyaWJlKHBhdXNlKTtcbiAgICByZXN1bWVTdWIgPSBjb21wb25lbnQuaW5zdGFuY2UucmVzdW1lLnN1YnNjcmliZShyZXN1bWUpO1xuICAgIGNsb3NlU3ViID0gY29tcG9uZW50Lmluc3RhbmNlLmNsb3NlLnN1YnNjcmliZShraWxsKTtcbiAgfVxuXG4gIGlzRmxvb2RlZChvcHRpb25zOiBQYXJ0aWFsPE5vdGlmaWNhdGlvbk9wdGlvbnM+KTogYm9vbGVhbiB7XG4gICAgY29uc3QgY29tcHNCeVR5cGUgPSB0aGlzLmdldEJ5VHlwZSgpO1xuXG4gICAgZm9yIChjb25zdCBub3RpZmljYXRpb24gb2YgY29tcHNCeVR5cGUpIHtcbiAgICAgIGNvbnN0IGluc3RhbmNlID0gbm90aWZpY2F0aW9uLmluc3RhbmNlO1xuXG4gICAgICBpZiAoXG4gICAgICAgIGluc3RhbmNlLnRpdGxlID09PSBvcHRpb25zLnRpdGxlICYmXG4gICAgICAgIGluc3RhbmNlLmJvZHkgPT09IG9wdGlvbnMuYm9keSAmJlxuICAgICAgICBpbnN0YW5jZS50aW1lc3RhbXAgKyAxMDAwID4gb3B0aW9ucy50aW1lc3RhbXBcbiAgICAgICkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBzaG93TmF0aXZlKG9wdGlvbnM6IFBhcnRpYWw8Tm90aWZpY2F0aW9uT3B0aW9ucz4pOiBhbnkge1xuICAgIGlmICghdGhpcy5pc05hdGl2ZVN1cHBvcnRlZCkgcmV0dXJuO1xuICAgIGlmICghdGhpcy5wZXJtaXNzaW9uKSB0aGlzLnJlcXVlc3RQZXJtaXNzaW9ucygpO1xuICAgIGlmICh0aGlzLnBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb25UeXBlLmRlbmllZCkgcmV0dXJuO1xuXG4gICAgY29uc3Qgbm90ZSA9IG5ldyBOb3RpZmljYXRpb24ob3B0aW9ucy50aXRsZSwgb3B0aW9ucyk7XG5cbiAgICBub3RlLm9uZXJyb3IgPSAoKSA9PiB7XG4gICAgICBjb25zb2xlLmVycm9yKCdOb3RpZmljYXRpb24gZmFpbGVkIScsIG9wdGlvbnMpO1xuICAgIH07XG5cbiAgICAvLyBtYW51YWxseSBkbyB0aGlzXG4gICAgaWYgKG9wdGlvbnMgJiYgdHlwZW9mIG9wdGlvbnMudGltZW91dCA9PT0gJ251bWJlcicpIHtcbiAgICAgIHNldFRpbWVvdXQobm90ZS5jbG9zZS5iaW5kKG5vdGUpLCBvcHRpb25zLnRpbWVvdXQpO1xuICAgIH1cblxuICAgIHJldHVybiBub3RlO1xuICB9XG59XG4iXX0=