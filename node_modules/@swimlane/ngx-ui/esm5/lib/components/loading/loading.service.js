import { __decorate, __metadata } from "tslib";
import { Injectable } from '@angular/core';
import { InjectionService } from '../../services/injection/injection.service';
import { LoadingComponent } from './loading.component';
var LoadingService = /** @class */ (function () {
    function LoadingService(injectionService) {
        this.injectionService = injectionService;
        this.threshold = 250;
        this._count = 0;
        this._progress = 0;
    }
    Object.defineProperty(LoadingService.prototype, "progress", {
        get: function () {
            return this._progress;
        },
        set: function (val) {
            if (this.instance) {
                this.instance.progress = val;
            }
            this._progress = val;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(LoadingService.prototype, "count", {
        get: function () {
            return this._count;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(LoadingService.prototype, "instance", {
        get: function () {
            if (this.component)
                return this.component.instance;
        },
        enumerable: true,
        configurable: true
    });
    LoadingService.prototype.start = function (autoIncrement) {
        var _this = this;
        if (autoIncrement === void 0) { autoIncrement = true; }
        this.create();
        this._count++;
        if (autoIncrement) {
            clearTimeout(this.timeout);
            var fn_1 = function () {
                _this.increment();
                if (_this.progress < 100) {
                    _this.timeout = setTimeout(fn_1.bind(_this), _this.threshold);
                }
                else {
                    _this.complete();
                }
            };
            this.timeout = setTimeout(fn_1.bind(this), this.threshold);
        }
    };
    LoadingService.prototype.stop = function () {
        this._count--;
        clearTimeout(this.timeout);
    };
    LoadingService.prototype.reset = function (num) {
        if (num === void 0) { num = 0; }
        this.progress = num;
    };
    LoadingService.prototype.complete = function (all) {
        var _this = this;
        if (all === void 0) { all = false; }
        this._count--;
        if (this.count <= 0 || all) {
            this.progress = 100;
            this._count = 0;
            setTimeout(function () {
                _this.hide();
                _this.progress = 0;
            }, this.threshold * 2);
        }
    };
    LoadingService.prototype.hide = function () {
        this.stop();
        if (this.instance) {
            this.instance.visible = false;
        }
    };
    LoadingService.prototype.create = function () {
        if (!this.component) {
            this.component = this.injectionService.appendComponent(LoadingComponent);
        }
        this.instance.visible = true;
        this.instance.progress = this.progress;
        return this.component;
    };
    LoadingService.prototype.increment = function () {
        if (this.progress >= 100)
            return;
        // inspired by angular-loading-bar
        // https://github.com/chieffancypants/angular-loading-bar
        var stat = this.progress / 100;
        var rnd = 0;
        if (stat >= 0 && stat < 0.25) {
            // Start out between 3 - 6% increments
            rnd = (Math.random() * (5 - 3 + 1) + 3) / 100;
        }
        else if (stat >= 0.25 && stat < 0.65) {
            // increment between 0 - 3%
            rnd = (Math.random() * 3) / 100;
        }
        else if (stat >= 0.65 && stat < 0.9) {
            // increment between 0 - 2%
            rnd = (Math.random() * 2) / 100;
        }
        else {
            // finally, increment it .5 %
            // after 99%, don't increment:
            rnd = 0.005;
        }
        this.progress = (stat + rnd) * 100;
    };
    LoadingService.ctorParameters = function () { return [
        { type: InjectionService }
    ]; };
    LoadingService = __decorate([
        Injectable(),
        __metadata("design:paramtypes", [InjectionService])
    ], LoadingService);
    return LoadingService;
}());
export { LoadingService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGluZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHN3aW1sYW5lL25neC11aS8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2xvYWRpbmcvbG9hZGluZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFnQixNQUFNLGVBQWUsQ0FBQztBQUV6RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0Q0FBNEMsQ0FBQztBQUM5RSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUd2RDtJQTRCRSx3QkFBNkIsZ0JBQWtDO1FBQWxDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUEzQi9ELGNBQVMsR0FBVyxHQUFHLENBQUM7UUFzQmhCLFdBQU0sR0FBVyxDQUFDLENBQUM7UUFHbkIsY0FBUyxHQUFXLENBQUMsQ0FBQztJQUVvQyxDQUFDO0lBekJuRSxzQkFBSSxvQ0FBUTthQVFaO1lBQ0UsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ3hCLENBQUM7YUFWRCxVQUFhLEdBQVc7WUFDdEIsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO2dCQUNqQixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUM7YUFDOUI7WUFFRCxJQUFJLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQztRQUN2QixDQUFDOzs7T0FBQTtJQU1ELHNCQUFJLGlDQUFLO2FBQVQ7WUFDRSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDckIsQ0FBQzs7O09BQUE7SUFFRCxzQkFBWSxvQ0FBUTthQUFwQjtZQUNFLElBQUksSUFBSSxDQUFDLFNBQVM7Z0JBQUUsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztRQUNyRCxDQUFDOzs7T0FBQTtJQVNELDhCQUFLLEdBQUwsVUFBTSxhQUE2QjtRQUFuQyxpQkFrQkM7UUFsQkssOEJBQUEsRUFBQSxvQkFBNkI7UUFD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QUMvQzthQUFNLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLEdBQUcsSUFBSSxFQUFFO1lBQ3RDLDJCQUEyQjtZQUMzQixHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDO1NBQ2pDO2FBQU0sSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksR0FBRyxHQUFHLEVBQUU7WUFDckMsMkJBQTJCO1lBQzNCLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUM7U0FDakM7YUFBTTtZQUNMLDZCQUE2QjtZQUM3Qiw4QkFBOEI7WUFDOUIsR0FBRyxHQUFHLEtBQUssQ0FBQztTQUNiO1FBRUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7SUFDckMsQ0FBQzs7Z0JBeEY4QyxnQkFBZ0I7O0lBNUJwRCxjQUFjO1FBRDFCLFVBQVUsRUFBRTt5Q0E2Qm9DLGdCQUFnQjtPQTVCcEQsY0FBYyxDQXFIMUI7SUFBRCxxQkFBQztDQUFBLEFBckhELElBcUhDO1NBckhZLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBDb21wb25lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgSW5qZWN0aW9uU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2luamVjdGlvbi9pbmplY3Rpb24uc2VydmljZSc7XG5pbXBvcnQgeyBMb2FkaW5nQ29tcG9uZW50IH0gZnJvbSAnLi9sb2FkaW5nLmNvbXBvbmVudCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBMb2FkaW5nU2VydmljZSB7XG4gIHRocmVzaG9sZDogbnVtYmVyID0gMjUwO1xuXG4gIHNldCBwcm9ncmVzcyh2YWw6IG51bWJlcikge1xuICAgIGlmICh0aGlzLmluc3RhbmNlKSB7XG4gICAgICB0aGlzLmluc3RhbmNlLnByb2dyZXNzID0gdmFsO1xuICAgIH1cblxuICAgIHRoaXMuX3Byb2dyZXNzID0gdmFsO1xuICB9XG5cbiAgZ2V0IHByb2dyZXNzKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX3Byb2dyZXNzO1xuICB9XG5cbiAgZ2V0IGNvdW50KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX2NvdW50O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgaW5zdGFuY2UoKSB7XG4gICAgaWYgKHRoaXMuY29tcG9uZW50KSByZXR1cm4gdGhpcy5jb21wb25lbnQuaW5zdGFuY2U7XG4gIH1cblxuICBwcml2YXRlIF9jb3VudDogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSB0aW1lb3V0OiBhbnk7XG4gIHByaXZhdGUgY29tcG9uZW50OiBDb21wb25lbnRSZWY8TG9hZGluZ0NvbXBvbmVudD47XG4gIHByaXZhdGUgX3Byb2dyZXNzOiBudW1iZXIgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgaW5qZWN0aW9uU2VydmljZTogSW5qZWN0aW9uU2VydmljZSkge31cblxuICBzdGFydChhdXRvSW5jcmVtZW50OiBib29sZWFuID0gdHJ1ZSk6IHZvaWQge1xuICAgIHRoaXMuY3JlYXRlKCk7XG4gICAgdGhpcy5fY291bnQrKztcblxuICAgIGlmIChhdXRvSW5jcmVtZW50KSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0KTtcblxuICAgICAgY29uc3QgZm4gPSAoKSA9PiB7XG4gICAgICAgIHRoaXMuaW5jcmVtZW50KCk7XG4gICAgICAgIGlmICh0aGlzLnByb2dyZXNzIDwgMTAwKSB7XG4gICAgICAgICAgdGhpcy50aW1lb3V0ID0gc2V0VGltZW91dChmbi5iaW5kKHRoaXMpLCB0aGlzLnRocmVzaG9sZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5jb21wbGV0ZSgpO1xuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICB0aGlzLnRpbWVvdXQgPSBzZXRUaW1lb3V0KGZuLmJpbmQodGhpcyksIHRoaXMudGhyZXNob2xkKTtcbiAgICB9XG4gIH1cblxuICBzdG9wKCk6IHZvaWQge1xuICAgIHRoaXMuX2NvdW50LS07XG4gICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dCk7XG4gIH1cblxuICByZXNldChudW06IG51bWJlciA9IDApOiB2b2lkIHtcbiAgICB0aGlzLnByb2dyZXNzID0gbnVtO1xuICB9XG5cbiAgY29tcGxldGUoYWxsOiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcbiAgICB0aGlzLl9jb3VudC0tO1xuXG4gICAgaWYgKHRoaXMuY291bnQgPD0gMCB8fCBhbGwpIHtcbiAgICAgIHRoaXMucHJvZ3Jlc3MgPSAxMDA7XG4gICAgICB0aGlzLl9jb3VudCA9IDA7XG5cbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLmhpZGUoKTtcbiAgICAgICAgdGhpcy5wcm9ncmVzcyA9IDA7XG4gICAgICB9LCB0aGlzLnRocmVzaG9sZCAqIDIpO1xuICAgIH1cbiAgfVxuXG4gIGhpZGUoKTogdm9pZCB7XG4gICAgdGhpcy5zdG9wKCk7XG5cbiAgICBpZiAodGhpcy5pbnN0YW5jZSkge1xuICAgICAgdGhpcy5pbnN0YW5jZS52aXNpYmxlID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGUoKTogQ29tcG9uZW50UmVmPExvYWRpbmdDb21wb25lbnQ+IHtcbiAgICBpZiAoIXRoaXMuY29tcG9uZW50KSB7XG4gICAgICB0aGlzLmNvbXBvbmVudCA9IHRoaXMuaW5qZWN0aW9uU2VydmljZS5hcHBlbmRDb21wb25lbnQoTG9hZGluZ0NvbXBvbmVudCk7XG4gICAgfVxuXG4gICAgdGhpcy5pbnN0YW5jZS52aXNpYmxlID0gdHJ1ZTtcbiAgICB0aGlzLmluc3RhbmNlLnByb2dyZXNzID0gdGhpcy5wcm9ncmVzcztcblxuICAgIHJldHVybiB0aGlzLmNvbXBvbmVudDtcbiAgfVxuXG4gIHByaXZhdGUgaW5jcmVtZW50KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnByb2dyZXNzID49IDEwMCkgcmV0dXJuO1xuXG4gICAgLy8gaW5zcGlyZWQgYnkgYW5ndWxhci1sb2FkaW5nLWJhclxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGllZmZhbmN5cGFudHMvYW5ndWxhci1sb2FkaW5nLWJhclxuICAgIGNvbnN0IHN0YXQgPSB0aGlzLnByb2dyZXNzIC8gMTAwO1xuICAgIGxldCBybmQgPSAwO1xuXG4gICAgaWYgKHN0YXQgPj0gMCAmJiBzdGF0IDwgMC4yNSkge1xuICAgICAgLy8gU3RhcnQgb3V0IGJldHdlZW4gMyAtIDYlIGluY3JlbWVudHNcbiAgICAgIHJuZCA9IChNYXRoLnJhbmRvbSgpICogKDUgLSAzICsgMSkgKyAzKSAvIDEwMDtcbiAgICB9IGVsc2UgaWYgKHN0YXQgPj0gMC4yNSAmJiBzdGF0IDwgMC42NSkge1xuICAgICAgLy8gaW5jcmVtZW50IGJldHdlZW4gMCAtIDMlXG4gICAgICBybmQgPSAoTWF0aC5yYW5kb20oKSAqIDMpIC8gMTAwO1xuICAgIH0gZWxzZSBpZiAoc3RhdCA+PSAwLjY1ICYmIHN0YXQgPCAwLjkpIHtcbiAgICAgIC8vIGluY3JlbWVudCBiZXR3ZWVuIDAgLSAyJVxuICAgICAgcm5kID0gKE1hdGgucmFuZG9tKCkgKiAyKSAvIDEwMDtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gZmluYWxseSwgaW5jcmVtZW50IGl0IC41ICVcbiAgICAgIC8vIGFmdGVyIDk5JSwgZG9uJ3QgaW5jcmVtZW50OlxuICAgICAgcm5kID0gMC4wMDU7XG4gICAgfVxuXG4gICAgdGhpcy5wcm9ncmVzcyA9IChzdGF0ICsgcm5kKSAqIDEwMDtcbiAgfVxufVxuIl19