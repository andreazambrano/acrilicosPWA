import { __decorate, __metadata, __values } from "tslib";
import { Component, Input, Output, EventEmitter, ViewChild, AfterViewInit, ElementRef, TemplateRef, ChangeDetectionStrategy } from '@angular/core';
import { coerceBooleanProperty, coerceNumberProperty } from '@angular/cdk/coercion';
import { KeyboardKeys } from '../../enums';
import { containsFilter } from './contains-filter.util';
var SelectDropdownComponent = /** @class */ (function () {
    function SelectDropdownComponent(elementRef) {
        this.elementRef = elementRef;
        this.allowAdditionsText = 'Add Value';
        this.keyup = new EventEmitter();
        this.selection = new EventEmitter();
        this.close = new EventEmitter();
        this._filterCaseSensitive = false;
    }
    Object.defineProperty(SelectDropdownComponent.prototype, "tagging", {
        get: function () {
            return this._tagging;
        },
        set: function (tagging) {
            this._tagging = coerceBooleanProperty(tagging);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SelectDropdownComponent.prototype, "allowAdditions", {
        get: function () {
            return this._allowAdditions;
        },
        set: function (allowAdditions) {
            this._allowAdditions = coerceBooleanProperty(allowAdditions);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SelectDropdownComponent.prototype, "filterable", {
        get: function () {
            return this._filterable;
        },
        set: function (filterable) {
            this._filterable = coerceBooleanProperty(filterable);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SelectDropdownComponent.prototype, "filterCaseSensitive", {
        get: function () {
            return this._filterCaseSensitive;
        },
        set: function (filterCaseSensitive) {
            this._filterCaseSensitive = coerceBooleanProperty(filterCaseSensitive);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SelectDropdownComponent.prototype, "focusIndex", {
        get: function () {
            return this._focusIndex;
        },
        set: function (val) {
            this._focusIndex = coerceNumberProperty(val);
            this.focusElement(this._focusIndex);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SelectDropdownComponent.prototype, "filterQuery", {
        get: function () {
            return this._filterQuery;
        },
        set: function (val) {
            this._filterQuery = val;
            this.groups = this.calculateGroups(this.groupBy, this.options, val);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SelectDropdownComponent.prototype, "groupBy", {
        get: function () {
            return this._groupBy;
        },
        set: function (val) {
            this._groupBy = val;
            this.groups = this.calculateGroups(val, this.options);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SelectDropdownComponent.prototype, "options", {
        get: function () {
            return this._options;
        },
        set: function (val) {
            this.groups = this.calculateGroups(this.groupBy, val);
            this._options = val;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SelectDropdownComponent.prototype, "element", {
        get: function () {
            return this.elementRef.nativeElement;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SelectDropdownComponent.prototype, "isNotTemplate", {
        get: function () {
            return !(typeof this.allowAdditionsText === 'object' && this.allowAdditionsText instanceof TemplateRef);
        },
        enumerable: true,
        configurable: true
    });
    SelectDropdownComponent.prototype.ngAfterViewInit = function () {
        var _this = this;
        if (this.filterable && !this.tagging) {
            setTimeout(function () {
                _this.filterInput.nativeElement.focus();
            }, 5);
        }
    };
    SelectDropdownComponent.prototype.isSelected = function (option) {
        var _this = this;
        if (!this.selected || !this.selected.length)
            return false;
        var idx = this.selected.findIndex(function (o) {
            if (_this.identifier)
                return o[_this.identifier] === option.value[_this.identifier];
            return o === option.value;
        });
        return idx > -1;
    };
    SelectDropdownComponent.prototype.onInputKeyUp = function (event) {
        event.preventDefault();
        event.stopPropagation();
        var key = event.key;
        var value = event.target.value;
        if (key === KeyboardKeys.ESCAPE) {
            this.close.emit(true);
        }
        else if (event.key === KeyboardKeys.ARROW_DOWN) {
            ++this.focusIndex;
        }
        if (this.filterQuery !== value) {
            this.filterQuery = value;
        }
        this.keyup.emit({ event: event, value: value });
    };
    SelectDropdownComponent.prototype.onOptionKeyDown = function (event) {
        event.preventDefault();
        event.stopPropagation();
        var key = event.key;
        if (key === KeyboardKeys.ARROW_DOWN) {
            if (this.focusIndex < this.options.length - 1)
                ++this.focusIndex;
        }
        else if (key === KeyboardKeys.ARROW_UP) {
            if (this.focusIndex > 0)
                --this.focusIndex;
        }
        else if (key === KeyboardKeys.ENTER) {
            this.selection.emit(this.options[this.focusIndex]);
        }
    };
    SelectDropdownComponent.prototype.onAddClicked = function (event, value) {
        event.preventDefault();
        event.stopPropagation();
        this.selection.emit({ value: value, name: value });
        event.target.value = '';
        this.close.emit();
    };
    SelectDropdownComponent.prototype.focusElement = function (index) {
        var elements = this.element.getElementsByClassName('ngx-select-dropdown-option');
        var element = elements[index];
        if (element) {
            setTimeout(function () { return element.focus(); }, 5);
        }
    };
    SelectDropdownComponent.prototype.calculateGroups = function (groupBy, options, filter) {
        var e_1, _a;
        if (!options)
            return [];
        var filterOptions = { filterCaseSensitive: this.filterCaseSensitive };
        // no group by defined, skip and just return
        // empty group object...
        if (!groupBy) {
            if (filter) {
                // filter options
                options = options.filter(function (o) {
                    return containsFilter({ name: o.name, value: o.value }, filter, filterOptions);
                });
            }
            // need to map indexes
            options = options.map(function (option, index) {
                return { option: option, index: index };
            });
            return [{ options: options }];
        }
        var map = new Map();
        var i = 0;
        try {
            for (var options_1 = __values(options), options_1_1 = options_1.next(); !options_1_1.done; options_1_1 = options_1.next()) {
                var option = options_1_1.value;
                // only show items in filter criteria
                if (filter && !containsFilter({ name: option.name, value: option.value }, filter, filterOptions)) {
                    continue;
                }
                var group = option.value[groupBy];
                var opt = map.get(group);
                // need to map the true indexes
                var kv = { option: option, index: i++ };
                if (!opt) {
                    map.set(group, [kv]);
                }
                else {
                    opt.push(kv);
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (options_1_1 && !options_1_1.done && (_a = options_1.return)) _a.call(options_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        var result = [];
        map.forEach(function (value, key) {
            result.push({ name: key, options: value });
        });
        return result;
    };
    SelectDropdownComponent.ctorParameters = function () { return [
        { type: ElementRef }
    ]; };
    __decorate([
        Input(),
        __metadata("design:type", Array)
    ], SelectDropdownComponent.prototype, "selected", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], SelectDropdownComponent.prototype, "identifier", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], SelectDropdownComponent.prototype, "filterPlaceholder", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], SelectDropdownComponent.prototype, "filterEmptyPlaceholder", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], SelectDropdownComponent.prototype, "emptyPlaceholder", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], SelectDropdownComponent.prototype, "allowAdditionsText", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [Object])
    ], SelectDropdownComponent.prototype, "tagging", null);
    __decorate([
        Input(),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [Object])
    ], SelectDropdownComponent.prototype, "allowAdditions", null);
    __decorate([
        Input(),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [Object])
    ], SelectDropdownComponent.prototype, "filterable", null);
    __decorate([
        Input(),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [Object])
    ], SelectDropdownComponent.prototype, "filterCaseSensitive", null);
    __decorate([
        Input(),
        __metadata("design:type", Number),
        __metadata("design:paramtypes", [Number])
    ], SelectDropdownComponent.prototype, "focusIndex", null);
    __decorate([
        Input(),
        __metadata("design:type", String),
        __metadata("design:paramtypes", [String])
    ], SelectDropdownComponent.prototype, "filterQuery", null);
    __decorate([
        Input(),
        __metadata("design:type", String),
        __metadata("design:paramtypes", [String])
    ], SelectDropdownComponent.prototype, "groupBy", null);
    __decorate([
        Input(),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [Object])
    ], SelectDropdownComponent.prototype, "options", null);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], SelectDropdownComponent.prototype, "keyup", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], SelectDropdownComponent.prototype, "selection", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], SelectDropdownComponent.prototype, "close", void 0);
    __decorate([
        ViewChild('filterInput'),
        __metadata("design:type", ElementRef)
    ], SelectDropdownComponent.prototype, "filterInput", void 0);
    SelectDropdownComponent = __decorate([
        Component({
            exportAs: 'ngxSelectDropdown',
            selector: 'ngx-select-dropdown',
            template: "<div>\n  <div class=\"ngx-select-filter\" *ngIf=\"filterable && !tagging\">\n    <input\n      #filterInput\n      type=\"search\"\n      tabindex=\"\"\n      autocomplete=\"off\"\n      autocorrect=\"off\"\n      spellcheck=\"off\"\n      class=\"ngx-select-filter-input\"\n      [placeholder]=\"filterPlaceholder\"\n      (keyup)=\"onInputKeyUp($event)\"\n    />\n  </div>\n  <ul class=\"vertical-list ngx-select-dropdown-options\">\n    <li *ngFor=\"let group of groups\" class=\"ngx-select-option-group\">\n      <span class=\"ngx-select-option-group-name\" *ngIf=\"group.name\" [innerHTML]=\"group.name\"> </span>\n      <ul class=\"vertical-list ngx-select-dropdown-options\">\n        <li\n          *ngFor=\"let kv of group.options\"\n          class=\"ngx-select-dropdown-option\"\n          [class.disabled]=\"kv.option.disabled\"\n          [class.active]=\"kv.index === focusIndex\"\n          [class.selected]=\"isSelected(kv.option)\"\n          [hidden]=\"kv.option.hidden\"\n          tabindex=\"-1\"\n          (click)=\"selection.emit(kv.option)\"\n          (keydown)=\"onOptionKeyDown($event)\"\n        >\n          <ng-template\n            *ngIf=\"kv.option.optionTemplate\"\n            [ngTemplateOutlet]=\"kv.option.optionTemplate\"\n            [ngTemplateOutletContext]=\"{ option: kv.option }\"\n          >\n          </ng-template>\n          <span *ngIf=\"!kv.option.optionTemplate\" [innerHTML]=\"kv.option.name\"> </span>\n        </li>\n        <li\n          *ngIf=\"filterQuery && filterEmptyPlaceholder && !group.options?.length\"\n          class=\"ngx-select-empty-placeholder\"\n        >\n          <span class=\"ngx-select-empty-placeholder-text\" [innerHTML]=\"filterEmptyPlaceholder\"> </span>\n          <a\n            *ngIf=\"allowAdditions\"\n            href=\"#\"\n            class=\"ngx-select-empty-placeholder-add\"\n            (click)=\"onAddClicked($event, filterQuery)\"\n          >\n            <span *ngIf=\"isNotTemplate; else tpl\" [innerHTML]=\"allowAdditionsText\"> </span>\n            <ng-template #tpl>\n              <ng-container *ngTemplateOutlet=\"allowAdditionsText\"></ng-container>\n            </ng-template>\n          </a>\n        </li>\n        <li\n          *ngIf=\"!filterQuery && emptyPlaceholder && !group.options?.length\"\n          class=\"ngx-select-empty-placeholder\"\n          [innerHTML]=\"emptyPlaceholder\"\n        ></li>\n      </ul>\n    </li>\n  </ul>\n</div>\n",
            host: {
                class: 'ngx-select-dropdown',
                '[class.groupings]': 'groupBy'
            },
            changeDetection: ChangeDetectionStrategy.OnPush
        }),
        __metadata("design:paramtypes", [ElementRef])
    ], SelectDropdownComponent);
    return SelectDropdownComponent;
}());
export { SelectDropdownComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LWRyb3Bkb3duLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bzd2ltbGFuZS9uZ3gtdWkvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9zZWxlY3Qvc2VsZWN0LWRyb3Bkb3duLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsTUFBTSxFQUNOLFlBQVksRUFDWixTQUFTLEVBQ1QsYUFBYSxFQUNiLFVBQVUsRUFDVixXQUFXLEVBQ1gsdUJBQXVCLEVBQ3hCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRXBGLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDM0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBYXhEO0lBc0dFLGlDQUE2QixVQUFzQjtRQUF0QixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBaEcxQyx1QkFBa0IsR0FBOEIsV0FBVyxDQUFDO1FBc0UzRCxVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQTRDLENBQUM7UUFDckUsY0FBUyxHQUFHLElBQUksWUFBWSxFQUF3QixDQUFDO1FBQ3JELFVBQUssR0FBRyxJQUFJLFlBQVksRUFBdUIsQ0FBQztRQXNCbEQseUJBQW9CLEdBQUcsS0FBSyxDQUFDO0lBRWlCLENBQUM7SUE3RnZELHNCQUFJLDRDQUFPO2FBQVg7WUFDRSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDdkIsQ0FBQzthQUNELFVBQVksT0FBTztZQUNqQixJQUFJLENBQUMsUUFBUSxHQUFHLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2pELENBQUM7OztPQUhBO0lBTUQsc0JBQUksbURBQWM7YUFBbEI7WUFDRSxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUM7UUFDOUIsQ0FBQzthQUNELFVBQW1CLGNBQWM7WUFDL0IsSUFBSSxDQUFDLGVBQWUsR0FBRyxxQkFBcUIsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUMvRCxDQUFDOzs7T0FIQTtJQU1ELHNCQUFJLCtDQUFVO2FBQWQ7WUFDRSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDMUIsQ0FBQzthQUNELFVBQWUsVUFBVTtZQUN2QixJQUFJLENBQUMsV0FBVyxHQUFHLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3ZELENBQUM7OztPQUhBO0lBTUQsc0JBQUksd0RBQW1CO2FBQXZCO1lBQ0UsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUM7UUFDbkMsQ0FBQzthQUNELFVBQXdCLG1CQUFtQjtZQUN6QyxJQUFJLENBQUMsb0JBQW9CLEdBQUcscUJBQXFCLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUN6RSxDQUFDOzs7T0FIQTtJQU1ELHNCQUFJLCtDQUFVO2FBQWQ7WUFDRSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDMUIsQ0FBQzthQUNELFVBQWUsR0FBVztZQUN4QixJQUFJLENBQUMsV0FBVyxHQUFHLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3RDLENBQUM7OztPQUpBO0lBT0Qsc0JBQUksZ0RBQVc7YUFBZjtZQUNFLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQztRQUMzQixDQUFDO2FBQ0QsVUFBZ0IsR0FBVztZQUN6QixJQUFJLENBQUMsWUFBWSxHQUFHLEdBQUcsQ0FBQztZQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3RFLENBQUM7OztPQUpBO0lBT0Qsc0JBQUksNENBQU87YUFBWDtZQUNFLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUN2QixDQUFDO2FBQ0QsVUFBWSxHQUFXO1lBQ3JCLElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDO1lBQ3BCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3hELENBQUM7OztPQUpBO0lBT0Qsc0JBQUksNENBQU87YUFBWDtZQUNFLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUN2QixDQUFDO2FBQ0QsVUFBWSxHQUFHO1lBQ2IsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDdEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUM7UUFDdEIsQ0FBQzs7O09BSkE7SUFhRCxzQkFBSSw0Q0FBTzthQUFYO1lBQ0UsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQztRQUN2QyxDQUFDOzs7T0FBQTtJQUVELHNCQUFJLGtEQUFhO2FBQWpCO1lBQ0UsT0FBTyxDQUFDLENBQUMsT0FBTyxJQUFJLENBQUMsa0JBQWtCLEtBQUssUUFBUSxJQUFJLElBQUksQ0FBQyxrQkFBa0IsWUFBWSxXQUFXLENBQUMsQ0FBQztRQUMxRyxDQUFDOzs7T0FBQTtJQWVELGlEQUFlLEdBQWY7UUFBQSxpQkFNQztRQUxDLElBQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDcEMsVUFBVSxDQUFDO2dCQUNULEtBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3pDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUNQO0lBQ0gsQ0FBQztJQUVELDRDQUFVLEdBQVYsVUFBVyxNQUE0QjtRQUF2QyxpQkFTQztRQVJDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNO1lBQUUsT0FBTyxLQUFLLENBQUM7UUFFMUQsSUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsVUFBQSxDQUFDO1lBQ25DLElBQUksS0FBSSxDQUFDLFVBQVU7Z0JBQUUsT0FBTyxDQUFDLENBQUMsS0FBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2pGLE9BQU8sQ0FBQyxLQUFLLE1BQU0sQ0FBQyxLQUFLLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNsQixDQUFDO0lBRUQsOENBQVksR0FBWixVQUFhLEtBQW9CO1FBQy9CLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN2QixLQUFLLENBQUMsZUFBZSxFQUFFLENBQUM7UUFFeEIsSUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQztRQUN0QixJQUFNLEtBQUssR0FBSSxLQUFLLENBQUMsTUFBYyxDQUFDLEtBQUssQ0FBQztRQUUxQyxJQUFJLEdBQUcsS0FBTSxZQUFZLENBQUMsTUFBYyxFQUFFO1lBQ3hDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3ZCO2FBQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxLQUFNLFlBQVksQ0FBQyxVQUFrQixFQUFFO1lBQ3pELEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQztTQUNuQjtRQUVELElBQUksSUFBSSxDQUFDLFdBQVcsS0FBSyxLQUFLLEVBQUU7WUFDOUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7U0FDMUI7UUFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssT0FBQSxFQUFFLEtBQUssT0FBQSxFQUFFLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQsaURBQWUsR0FBZixVQUFnQixLQUFvQjtRQUNsQyxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDdkIsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBRXhCLElBQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUM7UUFFdEIsSUFBSSxHQUFHLEtBQU0sWUFBWSxDQUFDLFVBQWtCLEVBQUU7WUFDNUMsSUFBSSxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUM7Z0JBQUUsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDO1NBQ2xFO2FBQU0sSUFBSSxHQUFHLEtBQU0sWUFBWSxDQUFDLFFBQWdCLEVBQUU7WUFDakQsSUFBSSxJQUFJLENBQUMsVUFBVSxHQUFHLENBQUM7Z0JBQUUsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDO1NBQzVDO2FBQU0sSUFBSSxHQUFHLEtBQU0sWUFBWSxDQUFDLEtBQWEsRUFBRTtZQUM5QyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1NBQ3BEO0lBQ0gsQ0FBQztJQUVELDhDQUFZLEdBQVosVUFBYSxLQUFZLEVBQUUsS0FBVTtRQUNuQyxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDdkIsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBRXhCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxPQUFBLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDM0MsS0FBSyxDQUFDLE1BQWMsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBRWpDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDcEIsQ0FBQztJQUVPLDhDQUFZLEdBQXBCLFVBQXFCLEtBQWE7UUFDaEMsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO1FBQ25GLElBQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVoQyxJQUFJLE9BQU8sRUFBRTtZQUNYLFVBQVUsQ0FBQyxjQUFNLE9BQUEsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFmLENBQWUsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUN0QztJQUNILENBQUM7SUFFTyxpREFBZSxHQUF2QixVQUF3QixPQUFlLEVBQUUsT0FBYyxFQUFFLE1BQWU7O1FBQ3RFLElBQUksQ0FBQyxPQUFPO1lBQUUsT0FBTyxFQUFFLENBQUM7UUFFeEIsSUFBTSxhQUFhLEdBQUcsRUFBRSxtQkFBbUIsRUFBRSxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUV4RSw0Q0FBNEM7UUFDNUMsd0JBQXdCO1FBQ3hCLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDWixJQUFJLE1BQU0sRUFBRTtnQkFDVixpQkFBaUI7Z0JBQ2pCLE9BQU8sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQztvQkFDeEIsT0FBTyxjQUFjLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxhQUFhLENBQUMsQ0FBQztnQkFDakYsQ0FBQyxDQUFDLENBQUM7YUFDSjtZQUVELHNCQUFzQjtZQUN0QixPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFDLE1BQU0sRUFBRSxLQUFLO2dCQUNsQyxPQUFPLEVBQUUsTUFBTSxRQUFBLEVBQUUsS0FBSyxPQUFBLEVBQUUsQ0FBQztZQUMzQixDQUFDLENBQUMsQ0FBQztZQUVILE9BQU8sQ0FBQyxFQUFFLE9BQU8sU0FBQSxFQUFFLENBQUMsQ0FBQztTQUN0QjtRQUVELElBQU0sR0FBRyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7UUFDdEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDOztZQUVWLEtBQXFCLElBQUEsWUFBQSxTQUFBLE9BQU8sQ0FBQSxnQ0FBQSxxREFBRTtnQkFBekIsSUFBTSxNQUFNLG9CQUFBO2dCQUNmLHFDQUFxQztnQkFDckMsSUFBSSxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxhQUFhLENBQUMsRUFBRTtvQkFDaEcsU0FBUztpQkFDVjtnQkFFRCxJQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNwQyxJQUFNLEdBQUcsR0FBUSxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUVoQywrQkFBK0I7Z0JBQy9CLElBQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxRQUFBLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBRWxDLElBQUksQ0FBQyxHQUFHLEVBQUU7b0JBQ1IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2lCQUN0QjtxQkFBTTtvQkFDTCxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2lCQUNkO2FBQ0Y7Ozs7Ozs7OztRQUVELElBQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNsQixHQUFHLENBQUMsT0FBTyxDQUFDLFVBQUMsS0FBSyxFQUFFLEdBQUc7WUFDckIsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDN0MsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDOztnQkE5SHdDLFVBQVU7O0lBckcxQztRQUFSLEtBQUssRUFBRTs7NkRBQWlCO0lBQ2hCO1FBQVIsS0FBSyxFQUFFOzsrREFBaUI7SUFDaEI7UUFBUixLQUFLLEVBQUU7O3NFQUEyQjtJQUMxQjtRQUFSLEtBQUssRUFBRTs7MkVBQWdDO0lBQy9CO1FBQVIsS0FBSyxFQUFFOztxRUFBMEI7SUFDekI7UUFBUixLQUFLLEVBQUU7O3VFQUE2RDtJQUdyRTtRQURDLEtBQUssRUFBRTs7OzBEQUdQO0lBTUQ7UUFEQyxLQUFLLEVBQUU7OztpRUFHUDtJQU1EO1FBREMsS0FBSyxFQUFFOzs7NkRBR1A7SUFNRDtRQURDLEtBQUssRUFBRTs7O3NFQUdQO0lBTUQ7UUFEQyxLQUFLLEVBQUU7Ozs2REFHUDtJQU9EO1FBREMsS0FBSyxFQUFFOzs7OERBR1A7SUFPRDtRQURDLEtBQUssRUFBRTs7OzBEQUdQO0lBT0Q7UUFEQyxLQUFLLEVBQUU7OzswREFHUDtJQU1TO1FBQVQsTUFBTSxFQUFFOzswREFBc0U7SUFDckU7UUFBVCxNQUFNLEVBQUU7OzhEQUFzRDtJQUNyRDtRQUFULE1BQU0sRUFBRTs7MERBQWlEO0lBRzFEO1FBREMsU0FBUyxDQUFDLGFBQWEsQ0FBQztrQ0FDRixVQUFVO2dFQUFtQjtJQWpGekMsdUJBQXVCO1FBVm5DLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxtQkFBbUI7WUFDN0IsUUFBUSxFQUFFLHFCQUFxQjtZQUMvQiwwNkVBQStDO1lBQy9DLElBQUksRUFBRTtnQkFDSixLQUFLLEVBQUUscUJBQXFCO2dCQUM1QixtQkFBbUIsRUFBRSxTQUFTO2FBQy9CO1lBQ0QsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07U0FDaEQsQ0FBQzt5Q0F1R3lDLFVBQVU7T0F0R3hDLHVCQUF1QixDQXFPbkM7SUFBRCw4QkFBQztDQUFBLEFBck9ELElBcU9DO1NBck9ZLHVCQUF1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgRXZlbnRFbWl0dGVyLFxuICBWaWV3Q2hpbGQsXG4gIEFmdGVyVmlld0luaXQsXG4gIEVsZW1lbnRSZWYsXG4gIFRlbXBsYXRlUmVmLFxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneVxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGNvZXJjZUJvb2xlYW5Qcm9wZXJ0eSwgY29lcmNlTnVtYmVyUHJvcGVydHkgfSBmcm9tICdAYW5ndWxhci9jZGsvY29lcmNpb24nO1xuXG5pbXBvcnQgeyBLZXlib2FyZEtleXMgfSBmcm9tICcuLi8uLi9lbnVtcyc7XG5pbXBvcnQgeyBjb250YWluc0ZpbHRlciB9IGZyb20gJy4vY29udGFpbnMtZmlsdGVyLnV0aWwnO1xuaW1wb3J0IHsgU2VsZWN0RHJvcGRvd25PcHRpb24gfSBmcm9tICcuL3NlbGVjdC1kcm9wZG93bi1vcHRpb24uaW50ZXJmYWNlJztcblxuQENvbXBvbmVudCh7XG4gIGV4cG9ydEFzOiAnbmd4U2VsZWN0RHJvcGRvd24nLFxuICBzZWxlY3RvcjogJ25neC1zZWxlY3QtZHJvcGRvd24nLFxuICB0ZW1wbGF0ZVVybDogJy4vc2VsZWN0LWRyb3Bkb3duLmNvbXBvbmVudC5odG1sJyxcbiAgaG9zdDoge1xuICAgIGNsYXNzOiAnbmd4LXNlbGVjdC1kcm9wZG93bicsXG4gICAgJ1tjbGFzcy5ncm91cGluZ3NdJzogJ2dyb3VwQnknXG4gIH0sXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoXG59KVxuZXhwb3J0IGNsYXNzIFNlbGVjdERyb3Bkb3duQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCB7XG4gIEBJbnB1dCgpIHNlbGVjdGVkOiBhbnlbXTtcbiAgQElucHV0KCkgaWRlbnRpZmllcjogYW55O1xuICBASW5wdXQoKSBmaWx0ZXJQbGFjZWhvbGRlcjogc3RyaW5nO1xuICBASW5wdXQoKSBmaWx0ZXJFbXB0eVBsYWNlaG9sZGVyOiBzdHJpbmc7XG4gIEBJbnB1dCgpIGVtcHR5UGxhY2Vob2xkZXI6IHN0cmluZztcbiAgQElucHV0KCkgYWxsb3dBZGRpdGlvbnNUZXh0OiBzdHJpbmcgfCBUZW1wbGF0ZVJlZjxhbnk+ID0gJ0FkZCBWYWx1ZSc7XG5cbiAgQElucHV0KClcbiAgZ2V0IHRhZ2dpbmcoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3RhZ2dpbmc7XG4gIH1cbiAgc2V0IHRhZ2dpbmcodGFnZ2luZykge1xuICAgIHRoaXMuX3RhZ2dpbmcgPSBjb2VyY2VCb29sZWFuUHJvcGVydHkodGFnZ2luZyk7XG4gIH1cblxuICBASW5wdXQoKVxuICBnZXQgYWxsb3dBZGRpdGlvbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2FsbG93QWRkaXRpb25zO1xuICB9XG4gIHNldCBhbGxvd0FkZGl0aW9ucyhhbGxvd0FkZGl0aW9ucykge1xuICAgIHRoaXMuX2FsbG93QWRkaXRpb25zID0gY29lcmNlQm9vbGVhblByb3BlcnR5KGFsbG93QWRkaXRpb25zKTtcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIGdldCBmaWx0ZXJhYmxlKCkge1xuICAgIHJldHVybiB0aGlzLl9maWx0ZXJhYmxlO1xuICB9XG4gIHNldCBmaWx0ZXJhYmxlKGZpbHRlcmFibGUpIHtcbiAgICB0aGlzLl9maWx0ZXJhYmxlID0gY29lcmNlQm9vbGVhblByb3BlcnR5KGZpbHRlcmFibGUpO1xuICB9XG5cbiAgQElucHV0KClcbiAgZ2V0IGZpbHRlckNhc2VTZW5zaXRpdmUoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2ZpbHRlckNhc2VTZW5zaXRpdmU7XG4gIH1cbiAgc2V0IGZpbHRlckNhc2VTZW5zaXRpdmUoZmlsdGVyQ2FzZVNlbnNpdGl2ZSkge1xuICAgIHRoaXMuX2ZpbHRlckNhc2VTZW5zaXRpdmUgPSBjb2VyY2VCb29sZWFuUHJvcGVydHkoZmlsdGVyQ2FzZVNlbnNpdGl2ZSk7XG4gIH1cblxuICBASW5wdXQoKVxuICBnZXQgZm9jdXNJbmRleCgpIHtcbiAgICByZXR1cm4gdGhpcy5fZm9jdXNJbmRleDtcbiAgfVxuICBzZXQgZm9jdXNJbmRleCh2YWw6IG51bWJlcikge1xuICAgIHRoaXMuX2ZvY3VzSW5kZXggPSBjb2VyY2VOdW1iZXJQcm9wZXJ0eSh2YWwpO1xuICAgIHRoaXMuZm9jdXNFbGVtZW50KHRoaXMuX2ZvY3VzSW5kZXgpO1xuICB9XG5cbiAgQElucHV0KClcbiAgZ2V0IGZpbHRlclF1ZXJ5KCkge1xuICAgIHJldHVybiB0aGlzLl9maWx0ZXJRdWVyeTtcbiAgfVxuICBzZXQgZmlsdGVyUXVlcnkodmFsOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9maWx0ZXJRdWVyeSA9IHZhbDtcbiAgICB0aGlzLmdyb3VwcyA9IHRoaXMuY2FsY3VsYXRlR3JvdXBzKHRoaXMuZ3JvdXBCeSwgdGhpcy5vcHRpb25zLCB2YWwpO1xuICB9XG5cbiAgQElucHV0KClcbiAgZ2V0IGdyb3VwQnkoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2dyb3VwQnk7XG4gIH1cbiAgc2V0IGdyb3VwQnkodmFsOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9ncm91cEJ5ID0gdmFsO1xuICAgIHRoaXMuZ3JvdXBzID0gdGhpcy5jYWxjdWxhdGVHcm91cHModmFsLCB0aGlzLm9wdGlvbnMpO1xuICB9XG5cbiAgQElucHV0KClcbiAgZ2V0IG9wdGlvbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX29wdGlvbnM7XG4gIH1cbiAgc2V0IG9wdGlvbnModmFsKSB7XG4gICAgdGhpcy5ncm91cHMgPSB0aGlzLmNhbGN1bGF0ZUdyb3Vwcyh0aGlzLmdyb3VwQnksIHZhbCk7XG4gICAgdGhpcy5fb3B0aW9ucyA9IHZhbDtcbiAgfVxuXG4gIEBPdXRwdXQoKSBrZXl1cCA9IG5ldyBFdmVudEVtaXR0ZXI8eyBldmVudDogS2V5Ym9hcmRFdmVudDsgdmFsdWU/OiBzdHJpbmcgfT4oKTtcbiAgQE91dHB1dCgpIHNlbGVjdGlvbiA9IG5ldyBFdmVudEVtaXR0ZXI8U2VsZWN0RHJvcGRvd25PcHRpb24+KCk7XG4gIEBPdXRwdXQoKSBjbG9zZSA9IG5ldyBFdmVudEVtaXR0ZXI8Ym9vbGVhbiB8IHVuZGVmaW5lZD4oKTtcblxuICBAVmlld0NoaWxkKCdmaWx0ZXJJbnB1dCcpXG4gIHJlYWRvbmx5IGZpbHRlcklucHV0PzogRWxlbWVudFJlZjxIVE1MSW5wdXRFbGVtZW50PjtcblxuICBnZXQgZWxlbWVudCgpIHtcbiAgICByZXR1cm4gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQ7XG4gIH1cblxuICBnZXQgaXNOb3RUZW1wbGF0ZSgpIHtcbiAgICByZXR1cm4gISh0eXBlb2YgdGhpcy5hbGxvd0FkZGl0aW9uc1RleHQgPT09ICdvYmplY3QnICYmIHRoaXMuYWxsb3dBZGRpdGlvbnNUZXh0IGluc3RhbmNlb2YgVGVtcGxhdGVSZWYpO1xuICB9XG5cbiAgZ3JvdXBzOiBhbnlbXTtcblxuICBwcml2YXRlIF9vcHRpb25zOiBTZWxlY3REcm9wZG93bk9wdGlvbltdO1xuICBwcml2YXRlIF9ncm91cEJ5OiBzdHJpbmc7XG4gIHByaXZhdGUgX2ZpbHRlclF1ZXJ5OiBzdHJpbmc7XG4gIHByaXZhdGUgX2ZvY3VzSW5kZXg6IG51bWJlcjtcbiAgcHJpdmF0ZSBfdGFnZ2luZzogYm9vbGVhbjtcbiAgcHJpdmF0ZSBfYWxsb3dBZGRpdGlvbnM6IGJvb2xlYW47XG4gIHByaXZhdGUgX2ZpbHRlcmFibGU6IGJvb2xlYW47XG4gIHByaXZhdGUgX2ZpbHRlckNhc2VTZW5zaXRpdmUgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYpIHt9XG5cbiAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmZpbHRlcmFibGUgJiYgIXRoaXMudGFnZ2luZykge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMuZmlsdGVySW5wdXQubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuICAgICAgfSwgNSk7XG4gICAgfVxuICB9XG5cbiAgaXNTZWxlY3RlZChvcHRpb246IFNlbGVjdERyb3Bkb3duT3B0aW9uKTogYm9vbGVhbiB7XG4gICAgaWYgKCF0aGlzLnNlbGVjdGVkIHx8ICF0aGlzLnNlbGVjdGVkLmxlbmd0aCkgcmV0dXJuIGZhbHNlO1xuXG4gICAgY29uc3QgaWR4ID0gdGhpcy5zZWxlY3RlZC5maW5kSW5kZXgobyA9PiB7XG4gICAgICBpZiAodGhpcy5pZGVudGlmaWVyKSByZXR1cm4gb1t0aGlzLmlkZW50aWZpZXJdID09PSBvcHRpb24udmFsdWVbdGhpcy5pZGVudGlmaWVyXTtcbiAgICAgIHJldHVybiBvID09PSBvcHRpb24udmFsdWU7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gaWR4ID4gLTE7XG4gIH1cblxuICBvbklucHV0S2V5VXAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpOiB2b2lkIHtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuXG4gICAgY29uc3Qga2V5ID0gZXZlbnQua2V5O1xuICAgIGNvbnN0IHZhbHVlID0gKGV2ZW50LnRhcmdldCBhcyBhbnkpLnZhbHVlO1xuXG4gICAgaWYgKGtleSA9PT0gKEtleWJvYXJkS2V5cy5FU0NBUEUgYXMgYW55KSkge1xuICAgICAgdGhpcy5jbG9zZS5lbWl0KHRydWUpO1xuICAgIH0gZWxzZSBpZiAoZXZlbnQua2V5ID09PSAoS2V5Ym9hcmRLZXlzLkFSUk9XX0RPV04gYXMgYW55KSkge1xuICAgICAgKyt0aGlzLmZvY3VzSW5kZXg7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuZmlsdGVyUXVlcnkgIT09IHZhbHVlKSB7XG4gICAgICB0aGlzLmZpbHRlclF1ZXJ5ID0gdmFsdWU7XG4gICAgfVxuXG4gICAgdGhpcy5rZXl1cC5lbWl0KHsgZXZlbnQsIHZhbHVlIH0pO1xuICB9XG5cbiAgb25PcHRpb25LZXlEb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgIGNvbnN0IGtleSA9IGV2ZW50LmtleTtcblxuICAgIGlmIChrZXkgPT09IChLZXlib2FyZEtleXMuQVJST1dfRE9XTiBhcyBhbnkpKSB7XG4gICAgICBpZiAodGhpcy5mb2N1c0luZGV4IDwgdGhpcy5vcHRpb25zLmxlbmd0aCAtIDEpICsrdGhpcy5mb2N1c0luZGV4O1xuICAgIH0gZWxzZSBpZiAoa2V5ID09PSAoS2V5Ym9hcmRLZXlzLkFSUk9XX1VQIGFzIGFueSkpIHtcbiAgICAgIGlmICh0aGlzLmZvY3VzSW5kZXggPiAwKSAtLXRoaXMuZm9jdXNJbmRleDtcbiAgICB9IGVsc2UgaWYgKGtleSA9PT0gKEtleWJvYXJkS2V5cy5FTlRFUiBhcyBhbnkpKSB7XG4gICAgICB0aGlzLnNlbGVjdGlvbi5lbWl0KHRoaXMub3B0aW9uc1t0aGlzLmZvY3VzSW5kZXhdKTtcbiAgICB9XG4gIH1cblxuICBvbkFkZENsaWNrZWQoZXZlbnQ6IEV2ZW50LCB2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgIHRoaXMuc2VsZWN0aW9uLmVtaXQoeyB2YWx1ZSwgbmFtZTogdmFsdWUgfSk7XG4gICAgKGV2ZW50LnRhcmdldCBhcyBhbnkpLnZhbHVlID0gJyc7XG5cbiAgICB0aGlzLmNsb3NlLmVtaXQoKTtcbiAgfVxuXG4gIHByaXZhdGUgZm9jdXNFbGVtZW50KGluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICBjb25zdCBlbGVtZW50cyA9IHRoaXMuZWxlbWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCduZ3gtc2VsZWN0LWRyb3Bkb3duLW9wdGlvbicpO1xuICAgIGNvbnN0IGVsZW1lbnQgPSBlbGVtZW50c1tpbmRleF07XG5cbiAgICBpZiAoZWxlbWVudCkge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiBlbGVtZW50LmZvY3VzKCksIDUpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2FsY3VsYXRlR3JvdXBzKGdyb3VwQnk6IHN0cmluZywgb3B0aW9uczogYW55W10sIGZpbHRlcj86IHN0cmluZyk6IGFueVtdIHtcbiAgICBpZiAoIW9wdGlvbnMpIHJldHVybiBbXTtcblxuICAgIGNvbnN0IGZpbHRlck9wdGlvbnMgPSB7IGZpbHRlckNhc2VTZW5zaXRpdmU6IHRoaXMuZmlsdGVyQ2FzZVNlbnNpdGl2ZSB9O1xuXG4gICAgLy8gbm8gZ3JvdXAgYnkgZGVmaW5lZCwgc2tpcCBhbmQganVzdCByZXR1cm5cbiAgICAvLyBlbXB0eSBncm91cCBvYmplY3QuLi5cbiAgICBpZiAoIWdyb3VwQnkpIHtcbiAgICAgIGlmIChmaWx0ZXIpIHtcbiAgICAgICAgLy8gZmlsdGVyIG9wdGlvbnNcbiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMuZmlsdGVyKG8gPT4ge1xuICAgICAgICAgIHJldHVybiBjb250YWluc0ZpbHRlcih7IG5hbWU6IG8ubmFtZSwgdmFsdWU6IG8udmFsdWUgfSwgZmlsdGVyLCBmaWx0ZXJPcHRpb25zKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIG5lZWQgdG8gbWFwIGluZGV4ZXNcbiAgICAgIG9wdGlvbnMgPSBvcHRpb25zLm1hcCgob3B0aW9uLCBpbmRleCkgPT4ge1xuICAgICAgICByZXR1cm4geyBvcHRpb24sIGluZGV4IH07XG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIFt7IG9wdGlvbnMgfV07XG4gICAgfVxuXG4gICAgY29uc3QgbWFwID0gbmV3IE1hcCgpO1xuICAgIGxldCBpID0gMDtcblxuICAgIGZvciAoY29uc3Qgb3B0aW9uIG9mIG9wdGlvbnMpIHtcbiAgICAgIC8vIG9ubHkgc2hvdyBpdGVtcyBpbiBmaWx0ZXIgY3JpdGVyaWFcbiAgICAgIGlmIChmaWx0ZXIgJiYgIWNvbnRhaW5zRmlsdGVyKHsgbmFtZTogb3B0aW9uLm5hbWUsIHZhbHVlOiBvcHRpb24udmFsdWUgfSwgZmlsdGVyLCBmaWx0ZXJPcHRpb25zKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZ3JvdXAgPSBvcHRpb24udmFsdWVbZ3JvdXBCeV07XG4gICAgICBjb25zdCBvcHQ6IGFueSA9IG1hcC5nZXQoZ3JvdXApO1xuXG4gICAgICAvLyBuZWVkIHRvIG1hcCB0aGUgdHJ1ZSBpbmRleGVzXG4gICAgICBjb25zdCBrdiA9IHsgb3B0aW9uLCBpbmRleDogaSsrIH07XG5cbiAgICAgIGlmICghb3B0KSB7XG4gICAgICAgIG1hcC5zZXQoZ3JvdXAsIFtrdl0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3B0LnB1c2goa3YpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xuICAgIG1hcC5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiB7XG4gICAgICByZXN1bHQucHVzaCh7IG5hbWU6IGtleSwgb3B0aW9uczogdmFsdWUgfSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG59XG4iXX0=