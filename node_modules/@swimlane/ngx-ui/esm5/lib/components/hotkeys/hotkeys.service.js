import { __assign, __decorate, __metadata, __values } from "tslib";
import { Injectable, NgZone } from '@angular/core';
import * as Mousetrap from 'mousetrap';
import { Subject } from 'rxjs';
import { HotkeyStatus } from './hotkey-status.enum';
var hotkeys = {};
var hotkeyChangedSource = new Subject();
var isMac = /Mac|iPod|iPhone|iPad/.test(window.navigator.platform);
var tags = ['INPUT', 'SELECT', 'TEXTAREA'];
/*tslint:disable*/
var map = {
    command: '\u2318',
    shift: '\u21E7',
    left: '\u2190',
    right: '\u2192',
    up: '\u2191',
    down: '\u2193',
    return: '\u23CE',
    backspace: '\u232B' // âŒ«
};
/*tslint:enable*/
function _getDisplay(combo) {
    var e_1, _a;
    var keys = combo.split('+');
    var result = [];
    try {
        for (var keys_1 = __values(keys), keys_1_1 = keys_1.next(); !keys_1_1.done; keys_1_1 = keys_1.next()) {
            var k = keys_1_1.value;
            if (k === 'mod') {
                result.push(isMac ? map.command : /* istanbul ignore next */ 'ctrl');
                continue;
            }
            var mapped = map[k];
            result.push(mapped || k);
        }
    }
    catch (e_1_1) { e_1 = { error: e_1_1 }; }
    finally {
        try {
            if (keys_1_1 && !keys_1_1.done && (_a = keys_1.return)) _a.call(keys_1);
        }
        finally { if (e_1) throw e_1.error; }
    }
    return result;
}
export function _add(combo, opts) {
    opts.status = opts.status || HotkeyStatus.Active;
    opts.keys = _getDisplay(combo);
    opts.visible = opts.visible !== undefined ? opts.visible : true;
    opts.allowIn = Array.isArray(opts.allowIn) ? opts.allowIn.map(function (tag) { return tag.toUpperCase(); }) : [];
    var mousetrap = new Mousetrap();
    if (opts.allowIn.length) {
        /* istanbul ignore next */
        mousetrap.stopCallback = function (_, element) {
            if (!tags.includes(element.tagName) || opts.allowIn.includes(element.tagName)) {
                return false;
            }
            return true;
        };
    }
    mousetrap.bind(combo, callback);
    if (hotkeys[combo] === undefined) {
        hotkeys[combo] = [];
    }
    hotkeys[combo].push(opts);
    hotkeyChangedSource.next(hotkeys);
    /* istanbul ignore next */
    function callback(event) {
        if (event.preventDefault) {
            event.preventDefault();
        }
        else {
            // internet explorer
            event.returnValue = false;
        }
        if (opts && opts.status === HotkeyStatus.Active) {
            opts.zone.run(function () {
                opts.callback(event);
            });
        }
    }
}
export function _suspend(comp) {
    var e_2, _a;
    for (var comb in hotkeys) {
        var hotkeyList = hotkeys[comb];
        try {
            for (var hotkeyList_1 = (e_2 = void 0, __values(hotkeyList)), hotkeyList_1_1 = hotkeyList_1.next(); !hotkeyList_1_1.done; hotkeyList_1_1 = hotkeyList_1.next()) {
                var hotkey = hotkeyList_1_1.value;
                if (hotkey.component === comp) {
                    hotkey.status = HotkeyStatus.Suspended;
                }
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (hotkeyList_1_1 && !hotkeyList_1_1.done && (_a = hotkeyList_1.return)) _a.call(hotkeyList_1);
            }
            finally { if (e_2) throw e_2.error; }
        }
    }
    hotkeyChangedSource.next(hotkeys);
}
export function _pauseOthers(comp) {
    var e_3, _a;
    for (var comb in hotkeys) {
        var hotkeyList = hotkeys[comb];
        try {
            for (var hotkeyList_2 = (e_3 = void 0, __values(hotkeyList)), hotkeyList_2_1 = hotkeyList_2.next(); !hotkeyList_2_1.done; hotkeyList_2_1 = hotkeyList_2.next()) {
                var hotkey = hotkeyList_2_1.value;
                if (hotkey.component !== comp) {
                    hotkey.status = "*" + hotkey.status;
                }
            }
        }
        catch (e_3_1) { e_3 = { error: e_3_1 }; }
        finally {
            try {
                if (hotkeyList_2_1 && !hotkeyList_2_1.done && (_a = hotkeyList_2.return)) _a.call(hotkeyList_2);
            }
            finally { if (e_3) throw e_3.error; }
        }
    }
    hotkeyChangedSource.next(hotkeys);
}
export function _unpauseOthers(comp) {
    var e_4, _a;
    for (var comb in hotkeys) {
        var hotkeyList = hotkeys[comb];
        try {
            for (var hotkeyList_3 = (e_4 = void 0, __values(hotkeyList)), hotkeyList_3_1 = hotkeyList_3.next(); !hotkeyList_3_1.done; hotkeyList_3_1 = hotkeyList_3.next()) {
                var hotkey = hotkeyList_3_1.value;
                if (hotkey.component !== comp && hotkey.status[0] === '*') {
                    hotkey.status = hotkey.status.replace('*', '');
                }
            }
        }
        catch (e_4_1) { e_4 = { error: e_4_1 }; }
        finally {
            try {
                if (hotkeyList_3_1 && !hotkeyList_3_1.done && (_a = hotkeyList_3.return)) _a.call(hotkeyList_3);
            }
            finally { if (e_4) throw e_4.error; }
        }
    }
    hotkeyChangedSource.next(hotkeys);
}
export function _activate(comp) {
    var e_5, _a;
    for (var comb in hotkeys) {
        var hotkeyList = hotkeys[comb];
        try {
            for (var hotkeyList_4 = (e_5 = void 0, __values(hotkeyList)), hotkeyList_4_1 = hotkeyList_4.next(); !hotkeyList_4_1.done; hotkeyList_4_1 = hotkeyList_4.next()) {
                var hotkey = hotkeyList_4_1.value;
                if (hotkey.component === comp) {
                    hotkey.status = HotkeyStatus.Active;
                }
            }
        }
        catch (e_5_1) { e_5 = { error: e_5_1 }; }
        finally {
            try {
                if (hotkeyList_4_1 && !hotkeyList_4_1.done && (_a = hotkeyList_4.return)) _a.call(hotkeyList_4);
            }
            finally { if (e_5) throw e_5.error; }
        }
    }
    hotkeyChangedSource.next(hotkeys);
}
export function _deregister(comp) {
    for (var comb in hotkeys) {
        var hotkeyList = hotkeys[comb];
        for (var i = 0; i < hotkeyList.length; i++) {
            if (hotkeyList[i].component === comp) {
                hotkeyList[i].status = HotkeyStatus.Disabled;
                hotkeyList.splice(hotkeyList.indexOf(hotkeyList[i]), 1);
            }
        }
        if (!hotkeyList.length) {
            Mousetrap.unbind(comb);
        }
    }
    hotkeyChangedSource.next(hotkeys);
}
export function Hotkey(key, description, options) {
    return function (target, name) {
        var oldInit = target.ngOnInit;
        target.ngOnInit = function () {
            var _this = this;
            if (oldInit)
                oldInit.bind(this)();
            _add(key, __assign({ callback: /* istanbul ignore next */ function () {
                    target[name].bind(_this)();
                }, description: description, component: this, zone: new NgZone({ enableLongStackTrace: false }) }, options));
        };
        var oldDestroy = target.ngOnDestroy;
        target.ngOnDestroy = function () {
            if (oldDestroy)
                oldDestroy.bind(this)();
            _deregister(this);
        };
    };
}
var HotkeysService = /** @class */ (function () {
    function HotkeysService(ngZone) {
        this.ngZone = ngZone;
        this.suspend = _suspend;
        this.activate = _activate;
        this.deregister = _deregister;
        this.pauseOthers = _pauseOthers;
        this.unpauseOthers = _unpauseOthers;
        this.changeEvent = hotkeyChangedSource.asObservable();
    }
    Object.defineProperty(HotkeysService.prototype, "hotkeys", {
        get: function () {
            return hotkeys;
        },
        enumerable: true,
        configurable: true
    });
    HotkeysService.prototype.add = function (combo, opts) {
        _add(combo, __assign({ zone: this.ngZone }, opts));
    };
    HotkeysService.prototype.clear = function () {
        hotkeys = {};
        Mousetrap.reset();
    };
    HotkeysService.ctorParameters = function () { return [
        { type: NgZone }
    ]; };
    HotkeysService = __decorate([
        Injectable(),
        __metadata("design:paramtypes", [NgZone])
    ], HotkeysService);
    return HotkeysService;
}());
export { HotkeysService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG90a2V5cy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHN3aW1sYW5lL25neC11aS8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2hvdGtleXMvaG90a2V5cy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEtBQUssU0FBUyxNQUFNLFdBQVcsQ0FBQztBQUN2QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRy9CLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVwRCxJQUFJLE9BQU8sR0FBa0MsRUFBRSxDQUFDO0FBQ2hELElBQU0sbUJBQW1CLEdBQUcsSUFBSSxPQUFPLEVBQWlDLENBQUM7QUFDekUsSUFBTSxLQUFLLEdBQUcsc0JBQXNCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDckUsSUFBTSxJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBRTdDLGtCQUFrQjtBQUNsQixJQUFNLEdBQUcsR0FBRztJQUNWLE9BQU8sRUFBRSxRQUFRO0lBQ2pCLEtBQUssRUFBRSxRQUFRO0lBQ2YsSUFBSSxFQUFFLFFBQVE7SUFDZCxLQUFLLEVBQUUsUUFBUTtJQUNmLEVBQUUsRUFBRSxRQUFRO0lBQ1osSUFBSSxFQUFFLFFBQVE7SUFDZCxNQUFNLEVBQUUsUUFBUTtJQUNoQixTQUFTLEVBQUUsUUFBUSxDQUFDLElBQUk7Q0FDekIsQ0FBQztBQUNGLGlCQUFpQjtBQUVqQixTQUFTLFdBQVcsQ0FBQyxLQUFhOztJQUNoQyxJQUFNLElBQUksR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzlCLElBQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQzs7UUFFbEIsS0FBZ0Is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LEdBQU4sTUFBTSxDQUFRO1FBWGxDLFlBQU8sR0FBRyxRQUFRLENBQUM7UUFDbkIsYUFBUSxHQUFHLFNBQVMsQ0FBQztRQUNyQixlQUFVLEdBQUcsV0FBVyxDQUFDO1FBQ3pCLGdCQUFXLEdBQUcsWUFBWSxDQUFDO1FBQzNCLGtCQUFhLEdBQUcsY0FBYyxDQUFDO1FBQy9CLGdCQUFXLEdBQUcsbUJBQW1CLENBQUMsWUFBWSxFQUFFLENBQUM7SUFNWixDQUFDO0lBSi9DLHNCQUFJLG1DQUFPO2FBQVg7WUFDRSxPQUFPLE9BQU8sQ0FBQztRQUNqQixDQUFDOzs7T0FBQTtJQUlELDRCQUFHLEdBQUgsVUFBSSxLQUFhLEVBQUUsSUFBWTtRQUM3QixJQUFJLENBQUMsS0FBSyxhQUFJLElBQUksRUFBRSxJQUFJLENBQUMsTUFBTSxJQUFLLElBQUksRUFBRyxDQUFDO0lBQzlDLENBQUM7SUFFRCw4QkFBSyxHQUFMO1FBQ0UsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNiLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNwQixDQUFDOztnQkFUb0MsTUFBTTs7SUFaaEMsY0FBYztRQUQxQixVQUFVLEVBQUU7eUNBYTBCLE1BQU07T0FaaEMsY0FBYyxDQXNCMUI7SUFBRCxxQkFBQztDQUFBLEFBdEJELElBc0JDO1NBdEJZLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCAqIGFzIE1vdXNldHJhcCBmcm9tICdtb3VzZXRyYXAnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBIb3RrZXkgfSBmcm9tICcuL2hvdGtleS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSG90a2V5U3RhdHVzIH0gZnJvbSAnLi9ob3RrZXktc3RhdHVzLmVudW0nO1xuXG5sZXQgaG90a2V5czogeyBbY29tYm86IHN0cmluZ106IEhvdGtleVtdIH0gPSB7fTtcbmNvbnN0IGhvdGtleUNoYW5nZWRTb3VyY2UgPSBuZXcgU3ViamVjdDx7IFtjb21ibzogc3RyaW5nXTogSG90a2V5W10gfT4oKTtcbmNvbnN0IGlzTWFjID0gL01hY3xpUG9kfGlQaG9uZXxpUGFkLy50ZXN0KHdpbmRvdy5uYXZpZ2F0b3IucGxhdGZvcm0pO1xuY29uc3QgdGFncyA9IFsnSU5QVVQnLCAnU0VMRUNUJywgJ1RFWFRBUkVBJ107XG5cbi8qdHNsaW50OmRpc2FibGUqL1xuY29uc3QgbWFwID0ge1xuICBjb21tYW5kOiAnXFx1MjMxOCcsIC8vIOKMmFxuICBzaGlmdDogJ1xcdTIxRTcnLCAvLyDih6dcbiAgbGVmdDogJ1xcdTIxOTAnLCAvLyDihpBcbiAgcmlnaHQ6ICdcXHUyMTkyJywgLy8g4oaSXG4gIHVwOiAnXFx1MjE5MScsIC8vIOKGkVxuICBkb3duOiAnXFx1MjE5MycsIC8vIOKGk1xuICByZXR1cm46ICdcXHUyM0NFJywgLy8g4o+OXG4gIGJhY2tzcGFjZTogJ1xcdTIzMkInIC8vIOKMq1xufTtcbi8qdHNsaW50OmVuYWJsZSovXG5cbmZ1bmN0aW9uIF9nZXREaXNwbGF5KGNvbWJvOiBzdHJpbmcpIHtcbiAgY29uc3Qga2V5cyA9IGNvbWJvLnNwbGl0KCcrJyk7XG4gIGNvbnN0IHJlc3VsdCA9IFtdO1xuXG4gIGZvciAoY29uc3QgayBvZiBrZXlzKSB7XG4gICAgaWYgKGsgPT09ICdtb2QnKSB7XG4gICAgICByZXN1bHQucHVzaChpc01hYyA/IG1hcC5jb21tYW5kIDogLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8gJ2N0cmwnKTtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGNvbnN0IG1hcHBlZCA9IG1hcFtrXTtcbiAgICByZXN1bHQucHVzaChtYXBwZWQgfHwgayk7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX2FkZChjb21ibzogc3RyaW5nLCBvcHRzOiBIb3RrZXkpIHtcbiAgb3B0cy5zdGF0dXMgPSBvcHRzLnN0YXR1cyB8fCBIb3RrZXlTdGF0dXMuQWN0aXZlO1xuICBvcHRzLmtleXMgPSBfZ2V0RGlzcGxheShjb21ibyk7XG4gIG9wdHMudmlzaWJsZSA9IG9wdHMudmlzaWJsZSAhPT0gdW5kZWZpbmVkID8gb3B0cy52aXNpYmxlIDogdHJ1ZTtcblxuICBvcHRzLmFsbG93SW4gPSBBcnJheS5pc0FycmF5KG9wdHMuYWxsb3dJbikgPyBvcHRzLmFsbG93SW4ubWFwKHRhZyA9PiB0YWcudG9VcHBlckNhc2UoKSkgOiBbXTtcblxuICBjb25zdCBtb3VzZXRyYXAgPSBuZXcgTW91c2V0cmFwKCk7XG5cbiAgaWYgKG9wdHMuYWxsb3dJbi5sZW5ndGgpIHtcbiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgIG1vdXNldHJhcC5zdG9wQ2FsbGJhY2sgPSBmdW5jdGlvbihfLCBlbGVtZW50KSB7XG4gICAgICBpZiAoIXRhZ3MuaW5jbHVkZXMoZWxlbWVudC50YWdOYW1lKSB8fCBvcHRzLmFsbG93SW4uaW5jbHVkZXMoZWxlbWVudC50YWdOYW1lKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH07XG4gIH1cblxuICBtb3VzZXRyYXAuYmluZChjb21ibywgY2FsbGJhY2spO1xuXG4gIGlmIChob3RrZXlzW2NvbWJvXSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgaG90a2V5c1tjb21ib10gPSBbXTtcbiAgfVxuXG4gIGhvdGtleXNbY29tYm9dLnB1c2gob3B0cyk7XG4gIGhvdGtleUNoYW5nZWRTb3VyY2UubmV4dChob3RrZXlzKTtcblxuICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICBmdW5jdGlvbiBjYWxsYmFjayhldmVudDogRXZlbnQpIHtcbiAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpIHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGludGVybmV0IGV4cGxvcmVyXG4gICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlO1xuICAgIH1cblxuICAgIGlmIChvcHRzICYmIG9wdHMuc3RhdHVzID09PSBIb3RrZXlTdGF0dXMuQWN0aXZlKSB7XG4gICAgICBvcHRzLnpvbmUucnVuKCgpID0+IHtcbiAgICAgICAgb3B0cy5jYWxsYmFjayhldmVudCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9zdXNwZW5kKGNvbXA6IGFueSkge1xuICBmb3IgKGNvbnN0IGNvbWIgaW4gaG90a2V5cykge1xuICAgIGNvbnN0IGhvdGtleUxpc3QgPSBob3RrZXlzW2NvbWJdO1xuXG4gICAgZm9yIChjb25zdCBob3RrZXkgb2YgaG90a2V5TGlzdCkge1xuICAgICAgaWYgKGhvdGtleS5jb21wb25lbnQgPT09IGNvbXApIHtcbiAgICAgICAgaG90a2V5LnN0YXR1cyA9IEhvdGtleVN0YXR1cy5TdXNwZW5kZWQ7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaG90a2V5Q2hhbmdlZFNvdXJjZS5uZXh0KGhvdGtleXMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX3BhdXNlT3RoZXJzKGNvbXA/OiBhbnkpIHtcbiAgZm9yIChjb25zdCBjb21iIGluIGhvdGtleXMpIHtcbiAgICBjb25zdCBob3RrZXlMaXN0ID0gaG90a2V5c1tjb21iXTtcblxuICAgIGZvciAoY29uc3QgaG90a2V5IG9mIGhvdGtleUxpc3QpIHtcbiAgICAgIGlmIChob3RrZXkuY29tcG9uZW50ICE9PSBjb21wKSB7XG4gICAgICAgIGhvdGtleS5zdGF0dXMgPSBgKiR7aG90a2V5LnN0YXR1c31gO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGhvdGtleUNoYW5nZWRTb3VyY2UubmV4dChob3RrZXlzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF91bnBhdXNlT3RoZXJzKGNvbXA/OiBhbnkpIHtcbiAgZm9yIChjb25zdCBjb21iIGluIGhvdGtleXMpIHtcbiAgICBjb25zdCBob3RrZXlMaXN0ID0gaG90a2V5c1tjb21iXTtcblxuICAgIGZvciAoY29uc3QgaG90a2V5IG9mIGhvdGtleUxpc3QpIHtcbiAgICAgIGlmIChob3RrZXkuY29tcG9uZW50ICE9PSBjb21wICYmIGhvdGtleS5zdGF0dXNbMF0gPT09ICcqJykge1xuICAgICAgICBob3RrZXkuc3RhdHVzID0gaG90a2V5LnN0YXR1cy5yZXBsYWNlKCcqJywgJycpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGhvdGtleUNoYW5nZWRTb3VyY2UubmV4dChob3RrZXlzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9hY3RpdmF0ZShjb21wOiBhbnkpIHtcbiAgZm9yIChjb25zdCBjb21iIGluIGhvdGtleXMpIHtcbiAgICBjb25zdCBob3RrZXlMaXN0ID0gaG90a2V5c1tjb21iXTtcblxuICAgIGZvciAoY29uc3QgaG90a2V5IG9mIGhvdGtleUxpc3QpIHtcbiAgICAgIGlmIChob3RrZXkuY29tcG9uZW50ID09PSBjb21wKSB7XG4gICAgICAgIGhvdGtleS5zdGF0dXMgPSBIb3RrZXlTdGF0dXMuQWN0aXZlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGhvdGtleUNoYW5nZWRTb3VyY2UubmV4dChob3RrZXlzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9kZXJlZ2lzdGVyKGNvbXA6IGFueSkge1xuICBmb3IgKGNvbnN0IGNvbWIgaW4gaG90a2V5cykge1xuICAgIGNvbnN0IGhvdGtleUxpc3QgPSBob3RrZXlzW2NvbWJdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBob3RrZXlMaXN0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoaG90a2V5TGlzdFtpXS5jb21wb25lbnQgPT09IGNvbXApIHtcbiAgICAgICAgaG90a2V5TGlzdFtpXS5zdGF0dXMgPSBIb3RrZXlTdGF0dXMuRGlzYWJsZWQ7XG4gICAgICAgIGhvdGtleUxpc3Quc3BsaWNlKGhvdGtleUxpc3QuaW5kZXhPZihob3RrZXlMaXN0W2ldKSwgMSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFob3RrZXlMaXN0Lmxlbmd0aCkge1xuICAgICAgTW91c2V0cmFwLnVuYmluZChjb21iKTtcbiAgICB9XG4gIH1cblxuICBob3RrZXlDaGFuZ2VkU291cmNlLm5leHQoaG90a2V5cyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBIb3RrZXkoa2V5OiBzdHJpbmcsIGRlc2NyaXB0aW9uOiBzdHJpbmcsIG9wdGlvbnM/OiBQYXJ0aWFsPEhvdGtleT4pIHtcbiAgcmV0dXJuICh0YXJnZXQ6IGFueSwgbmFtZTogc3RyaW5nKSA9PiB7XG4gICAgY29uc3Qgb2xkSW5pdCA9IHRhcmdldC5uZ09uSW5pdDtcbiAgICB0YXJnZXQubmdPbkluaXQgPSBmdW5jdGlvbigpIHtcbiAgICAgIGlmIChvbGRJbml0KSBvbGRJbml0LmJpbmQodGhpcykoKTtcblxuICAgICAgX2FkZChrZXksIHtcbiAgICAgICAgY2FsbGJhY2s6IC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovICgpID0+IHtcbiAgICAgICAgICB0YXJnZXRbbmFtZV0uYmluZCh0aGlzKSgpO1xuICAgICAgICB9LFxuICAgICAgICBkZXNjcmlwdGlvbixcbiAgICAgICAgY29tcG9uZW50OiB0aGlzLFxuICAgICAgICB6b25lOiBuZXcgTmdab25lKHsgZW5hYmxlTG9uZ1N0YWNrVHJhY2U6IGZhbHNlIH0pLFxuICAgICAgICAuLi5vcHRpb25zXG4gICAgICB9KTtcbiAgICB9O1xuXG4gICAgY29uc3Qgb2xkRGVzdHJveSA9IHRhcmdldC5uZ09uRGVzdHJveTtcbiAgICB0YXJnZXQubmdPbkRlc3Ryb3kgPSBmdW5jdGlvbigpIHtcbiAgICAgIGlmIChvbGREZXN0cm95KSBvbGREZXN0cm95LmJpbmQodGhpcykoKTtcbiAgICAgIF9kZXJlZ2lzdGVyKHRoaXMpO1xuICAgIH07XG4gIH07XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBIb3RrZXlzU2VydmljZSB7XG4gIHJlYWRvbmx5IHN1c3BlbmQgPSBfc3VzcGVuZDtcbiAgcmVhZG9ubHkgYWN0aXZhdGUgPSBfYWN0aXZhdGU7XG4gIHJlYWRvbmx5IGRlcmVnaXN0ZXIgPSBfZGVyZWdpc3RlcjtcbiAgcmVhZG9ubHkgcGF1c2VPdGhlcnMgPSBfcGF1c2VPdGhlcnM7XG4gIHJlYWRvbmx5IHVucGF1c2VPdGhlcnMgPSBfdW5wYXVzZU90aGVycztcbiAgcmVhZG9ubHkgY2hhbmdlRXZlbnQgPSBob3RrZXlDaGFuZ2VkU291cmNlLmFzT2JzZXJ2YWJsZSgpO1xuXG4gIGdldCBob3RrZXlzKCkge1xuICAgIHJldHVybiBob3RrZXlzO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBuZ1pvbmU6IE5nWm9uZSkge31cblxuICBhZGQoY29tYm86IHN0cmluZywgb3B0czogSG90a2V5KSB7XG4gICAgX2FkZChjb21ibywgeyB6b25lOiB0aGlzLm5nWm9uZSwgLi4ub3B0cyB9KTtcbiAgfVxuXG4gIGNsZWFyKCkge1xuICAgIGhvdGtleXMgPSB7fTtcbiAgICBNb3VzZXRyYXAucmVzZXQoKTtcbiAgfVxufVxuIl19