!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs"),require("@angular/common/http"),require("@angular/core"),require("@angular/forms"),require("@angular/common")):"function"==typeof define&&define.amd?define("@wkoza/ngx-upload",["exports","rxjs","@angular/common/http","@angular/core","@angular/forms","@angular/common"],t):t(((e=e||self).wkoza=e.wkoza||{},e.wkoza["ngx-upload"]={}),e.rxjs,e.ng.common.http,e.ng.core,e.ng.forms,e.ng.common)}(this,function(e,t,r,o,n,i){"use strict";function s(e,t,r,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(i<3?n(s):i>3?n(t,r,s):n(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s}function a(e,t){return function(r,o){t(r,o,e)}}function l(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function p(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function u(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var o,n,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(o=i.next()).done;)s.push(o.value)}catch(e){n={error:e}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}return s}function c(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(u(arguments[t]));return e}var f=function(){function e(e,t,r,o){this.file=e,this.uploadService=t,this.logger=r,this.disableMultipart=o,this.isReady=!0,this.progress=0,this.formData=new FormData,this.alias="file"}return e.prototype.upload=function(e,t){e?this.uploadService.uploadFileItem(this,e,t):this.logger.error("You must define a UploadEndPoint object.")},e.prototype.cancel=function(){this.logger.debug("upload cancel"),this.uploadInProgress&&(this.ɵonCancel(),this.uploadService.cancelFileItem(this))},e.prototype.remove=function(){this.logger.debug("upload remove"),this.uploadService.removeFromQueue(this)},e.prototype.ɵonBeforeUploadItem=function(){this.isReady=!0,this.uploadInProgress=!1,this.isSuccess=!1,this.isCancel=!1,this.isError=!1,this.progress=0},e.prototype.ɵonProgress=function(e){this.isReady=!1,this.progress=e},e.prototype.ɵonSuccess=function(){this.isReady=!1,this.uploadInProgress=!1,this.isSuccess=!0,this.isCancel=!1,this.isError=!1,this.progress=100},e.prototype.ɵonError=function(){this.isReady=!1,this.uploadInProgress=!1,this.isSuccess=!1,this.isCancel=!1,this.isError=!0,this.progress=0},e.prototype.ɵonCancel=function(){this.isReady=!0,this.uploadInProgress=!1,this.isSuccess=!1,this.isCancel=!0,this.isError=!1,this.progress=0,this.sub.unsubscribe()},e}(),h=function(){},d=function(){},g=function(){function e(e,t){void 0===t&&(t=!0),this._console=e,this._debugEnabled=t}return e.prototype.log=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._invokeConsoleMethod("log",e)},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._invokeConsoleMethod("info",e)},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._invokeConsoleMethod("warn",e)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._invokeConsoleMethod("error",e)},e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._debugEnabled&&this._invokeConsoleMethod("debug",e)},e.prototype._invokeConsoleMethod=function(e,t){var r=this._console[e]||this._console.log||d;r.apply||(r=Function.prototype.bind.call(r,this._console)),r.apply(this._console,t)},e}(),m=function(){function e(){}return e.prototype.log=function(){},e.prototype.info=function(){},e.prototype.warn=function(){},e.prototype.error=function(){},e.prototype.debug=function(){},e}(),v=function(){function e(e,r){this.logger=e,this.httpClient=r,this.progressTotal=0,this.onCancel$=new t.Subject,this.onError$=new t.Subject,this.onDropError$=new t.Subject,this.onSuccess$=new t.Subject,this.onBeforeUploadItem$=new t.Subject,this.onProgress$=new t.Subject,this.onAddToQueue$=new t.Subject,this.queue=new Array,this.headers=new Map}return e.prototype.addToQueue=function(e,t,r){if(this.logger.info("add to queue"),r&&!r.multiple&&e.length>1)return this.logger.error("there is more than one file."),void this.onDropError$.next({errorAccept:!1,errorMultiple:!0});for(var o=function(o){var i,s=e.item(o);if((n.logger.debug(e.item(o)),r&&r.accept)&&!r.accept.some(function(e){return e.indexOf("/*")>-1?e.split("/")[0]===s.type.split("/")[0]:"*"===e||e===s.type}))return n.logger.error("this file is not accepted because of its type",s),n.onDropError$.next({item:s,errorAccept:!0,errorMultiple:!1}),"continue";r&&r.disableMultipart?i=new f(s,n,n.logger,!0):(i=new f(s,n,n.logger,!1),t&&Object.keys(t.controls).forEach(function(e){i.formData.append(e,t.get(e).value)})),n.queue.push(i),n.onAddToQueue$.next(i)},n=this,i=0;i<e.length;i++)o(i)},e.prototype.uploadFileItem=function(e,t,o){var n=this;void 0===o&&(o={}),this.logger.info("enter uploadService.uploadFileItem()");var i=t.method,s=t.url,a=this.queue.indexOf(e),l=this.queue[a];if(this.onBeforeUploadItem(l),!l.isCancel){var p;l.uploadInProgress=!0,e.disableMultipart?p=l.file:(p=l.formData).append(l.alias,l.file,l.file.name);var u=new r.HttpRequest(i,s,p,Object.assign(o,{reportProgress:!0}));e.sub=this.httpClient.request(u).subscribe(function(t){if(t.type===r.HttpEventType.UploadProgress){var o=Math.round(100*t.loaded/(t.total?t.total:t.loaded));n.logger.debug("File is "+o+"% uploaded."),e.ɵonProgress(o),n.onProgressItem(l,o)}else t instanceof r.HttpResponse&&(e.ɵonSuccess(),n.onSuccess(l,t.body,t.status,t.headers))},function(e){e instanceof r.HttpErrorResponse&&("ngx_upload_mock"===s?(l.ɵonSuccess(),n.onSuccess(l,e.message,e.status,e.headers)):e.error instanceof Error?(l.ɵonError(),n.onError(l,e.error.message,e.status,e.headers)):(l.ɵonError(),n.onError(l,e.error,e.status,e.headers)))})}},e.prototype.cancelFileItem=function(e){this.progressTotal=this.computeTotalProgress(),this.onCancel$.next(e)},e.prototype.uploadAll=function(e,t){var r,o,n=this.queue.filter(function(e){return e.isReady});if(n.length)try{for(var i=p(n),s=i.next();!s.done;s=i.next()){s.value.upload(e,t)}}catch(e){r={error:e}}finally{try{s&&!s.done&&(o=i.return)&&o.call(i)}finally{if(r)throw r.error}}},e.prototype.cancelAll=function(){var e,t,r=this.queue.filter(function(e){return e.uploadInProgress});if(r.length){try{for(var o=p(r),n=o.next();!n.done;n=o.next()){n.value.cancel()}}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}this.progressTotal=this.computeTotalProgress()}},e.prototype.removeAllFromQueue=function(){var e,t,r=this.queue.filter(function(e){return!e.uploadInProgress&&!e.isSuccess});if(r.length)try{for(var o=p(r),n=o.next();!n.done;n=o.next()){var i=n.value;this.removeFromQueue(i)}}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}},e.prototype.removeFromQueue=function(e){var t=this.queue.indexOf(e),r=this.queue[t];r.uploadInProgress&&r.cancel(),this.queue.splice(t,1),this.progressTotal=this.computeTotalProgress()},e.prototype.computeTotalProgress=function(){var e,t,r=0,o=0;try{for(var n=p(this.queue),i=n.next();!i.done;i=n.next()){var s=i.value;(s.uploadInProgress||s.isSuccess)&&(r+=s.file.size/100*s.progress||0,o+=s.file.size,this.logger.debug(r+" / "+o))}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}return Math.round(100*r/o)},e.prototype.onBeforeUploadItem=function(e){this.logger.info("enter uploadService.ɵonBeforeUploadItem()"),e.ɵonBeforeUploadItem(),this.onBeforeUploadItem$.next(e)},e.prototype.onProgressItem=function(e,t){this.logger.info("call onProgressItem "+e+" "+t),this.progressTotal=this.computeTotalProgress(),e.ɵonProgress(t),this.onProgress$.next({item:e,progress:t})},e.prototype.onError=function(e,t,r,o){this.logger.info("call onError "+e+" "+t+" "+r+" "+o),e.ɵonError(),this.onError$.next({item:e,body:t,status:r,headers:o})},e.prototype.onSuccess=function(e,t,r,o){this.logger.info("call onSuccess "+e+" "+t+" "+r+" "+o),this.progressTotal=this.computeTotalProgress(),e.ɵonSuccess(),this.onSuccess$.next({item:e,body:t,status:r,headers:o})},e.ngInjectableDef=o.ɵɵdefineInjectable({factory:function(){return new e(o.ɵɵinject(h),o.ɵɵinject(r.HttpClient))},token:e,providedIn:"root"}),e=s([o.Injectable({providedIn:"root"}),l("design:paramtypes",[h,r.HttpClient])],e)}(),y=new o.InjectionToken("Ngx drop Zone Options"),b=new o.InjectionToken("Ngx Logger Options"),I={color:"",colorDrag:"",colorDrop:"",multiple:!0,disableMultipart:!1},w={enabled:!1,debug:!0},x={multiple:!0,disableMultipart:!1},E=function(){function e(e,t,r,o,n,s,a,l,p){var u=this;this.el=e,this.renderer=t,this.injector=r,this.logger=o,this.uploader=n,this.dropOptions=s,this.ngForm=a,this.formGroupDirective=l,this.ngForm?this.formGroup=a.form:this.formGroupDirective?this.formGroup=l.form:this.formGroup=null,i.isPlatformBrowser(p)&&(this.renderer.listen(e.nativeElement,"dragleave",function(e){return u.onDragLeave(e)}),this.renderer.listen(e.nativeElement,"drop",function(e){return u.dropEvent(e)}),this.renderer.listen(e.nativeElement,"dragover",function(e){return u.onDragOver(e)}))}return Object.defineProperty(e.prototype,"ngxDragAndDrop",{set:function(e){e&&(this.logger.debug(JSON.stringify(e)),this.dropOptions=e)},enumerable:!0,configurable:!0}),e.prototype.ngOnInit=function(){this.renderer.addClass(this.el.nativeElement,this.dropOptions.color)},e.prototype.onDragLeave=function(e){this.logger.debug("dragleave event"),this.renderer.removeClass(this.el.nativeElement,this.dropOptions.colorDrag),this.renderer.removeClass(this.el.nativeElement,this.dropOptions.colorDrop),this.renderer.addClass(this.el.nativeElement,this.dropOptions.color),this.stopAndPrevent(e)},e.prototype.dropEvent=function(e){this.logger.debug("drop event"),this.renderer.removeClass(this.el.nativeElement,this.dropOptions.color),this.renderer.removeClass(this.el.nativeElement,this.dropOptions.colorDrag),this.renderer.addClass(this.el.nativeElement,this.dropOptions.colorDrop);var t=this.getTransfer(e);t&&(t.dropEffect="copy",this.stopAndPrevent(e),this.uploader.addToQueue(t.files,this.formGroup,this.dropOptions))},e.prototype.onDragOver=function(e){this.logger.debug("dragover event"),this.renderer.removeClass(this.el.nativeElement,this.dropOptions.color),this.renderer.removeClass(this.el.nativeElement,this.dropOptions.colorDrop),this.renderer.addClass(this.el.nativeElement,this.dropOptions.colorDrag);var t=this.getTransfer(e);this.haveFiles(t.types)&&this.stopAndPrevent(e)},e.prototype.stopAndPrevent=function(e){e.stopPropagation(),e.preventDefault()},e.prototype.getTransfer=function(e){return e.dataTransfer?e.dataTransfer:e.originalEvent.dataTransfer},e.prototype.haveFiles=function(e){return!!e&&(e.indexOf?-1!==e.indexOf("Files"):!!e.contains&&e.contains("Files"))},s([o.Input(),l("design:type",Object),l("design:paramtypes",[Object])],e.prototype,"ngxDragAndDrop",null),e=s([o.Directive({selector:"[ngxDragAndDrop]",exportAs:"ngxDragAndDrop"}),a(5,o.Inject(y)),a(6,o.Optional()),a(7,o.Optional()),a(8,o.Inject(o.PLATFORM_ID)),l("design:paramtypes",[o.ElementRef,o.Renderer2,o.Injector,h,v,Object,n.NgForm,n.FormGroupDirective,Object])],e)}(),O=function(){function e(e,t){this.renderer=e,this.el=t}return e.prototype.ngOnInit=function(){var e=this;if(0===this.fileItem.file.type.indexOf("image/jpeg")||0===this.fileItem.file.type.indexOf("image/png")){var t=this.renderer.createElement("img");this.renderer.appendChild(this.el.nativeElement,t),this.renderer.setStyle(t,"width","100%"),this.renderer.setStyle(t,"height","100%"),this._getOrientation(this.fileItem.file,function(r){var o=new Image,n=new FileReader;n.onload=function(n){o.onload=function(){var n=o.width,i=o.height,s=document.createElement("canvas"),a=s.getContext("2d");switch(4<r&&r<9?(s.width=i,s.height=n):(s.width=n,s.height=i),r){case 2:a.transform(-1,0,0,1,n,0);break;case 3:a.transform(-1,0,0,-1,n,i);break;case 4:a.transform(1,0,0,-1,0,i);break;case 5:a.transform(0,1,1,0,0,0);break;case 6:a.transform(0,1,-1,0,i,0);break;case 7:a.transform(0,-1,-1,0,i,n);break;case 8:a.transform(0,-1,1,0,0,n)}a.drawImage(o,0,0),e.renderer.setProperty(t,"src",s.toDataURL())},o.src=n.target.result},n.readAsDataURL(e.fileItem.file)})}},e.prototype._getOrientation=function(e,t){var r=new FileReader;r.onload=function(e){var r=new DataView(e.target.result);if(65496!==r.getUint16(0,!1))return t(-2);for(var o=r.byteLength,n=2;n<o;){var i=r.getUint16(n,!1);if(n+=2,65505===i){if(1165519206!==r.getUint32(n+=2,!1))return t(-1);var s=18761===r.getUint16(n+=6,!1);n+=r.getUint32(n+4,s);var a=r.getUint16(n,s);n+=2;for(var l=0;l<a;l++)if(274===r.getUint16(n+12*l,s))return t(r.getUint16(n+12*l+8,s))}else{if(65280!=(65280&i))break;n+=r.getUint16(n,!1)}}return t(-1)},r.readAsArrayBuffer(e.slice(0,65536))},s([o.Input("ngxThumbnail"),l("design:type",f)],e.prototype,"fileItem",void 0),e=s([o.Directive({selector:"[ngxThumbnail]",exportAs:"ngxThumbnail"}),l("design:paramtypes",[o.Renderer2,o.ElementRef])],e)}(),j=function(){function e(e,t,r,o,n){this.injector=e,this.uploader=t,this.renderer=r,this.ngForm=o,this.formGroupDirective=n,this.files=new Set,this.ngForm?this.formGroup=o.form:this.formGroupDirective?this.formGroup=n.form:this.formGroup=null}return e.prototype.onFilesAdded=function(){this.uploader.addToQueue(this.file.nativeElement.files,this.formGroup,this.options),this.file.nativeElement.value=""},e.prototype.ngAfterViewInit=function(){!1!==this.options.multiple&&this.renderer.setProperty(this.file.nativeElement,"multiple","multiple"),this.options.accept&&this.renderer.setProperty(this.file.nativeElement,"accept",this.options.accept.join()),this.options.capture&&this.renderer.setProperty(this.file.nativeElement,"capture",this.options.capture)},s([o.ViewChild("file",{static:!0}),l("design:type",Object)],e.prototype,"file",void 0),e=s([o.Component({selector:"ngx-upload-inputfile",template:'\n      <label class="input-file">\n          <input type="file" #file (change)="onFilesAdded()">\n          <ng-content></ng-content>\n      </label>',styles:['input[type="file"] { display: none; } .input-file { width: 100%; }']}),a(3,o.Optional()),a(4,o.Optional()),l("design:paramtypes",[o.Injector,v,o.Renderer2,n.NgForm,n.FormGroupDirective])],e)}(),D=function(){function e(e,t,r,o){this.resolver=e,this.injector=t,this.vcRef=r,this.templateRef=o}return e.prototype.ngOnInit=function(){var e=this.templateRef.createEmbeddedView(null),t=this.resolver.resolveComponentFactory(j);this.vcRef.createComponent(t,0,this.injector,[e.rootNodes]).instance.options=this.ngxInputFile?this.ngxInputFile:x,e.detectChanges()},s([o.Input(),l("design:type",Object)],e.prototype,"ngxInputFile",void 0),e=s([o.Directive({selector:"[ngxInputFile]"}),l("design:paramtypes",[o.ComponentFactoryResolver,o.Injector,o.ViewContainerRef,o.TemplateRef])],e)}(),P=[E,O,j,D];function C(e){if(e.enabled?e.enabled:o.isDevMode()){var t="object"==typeof console?console:{},r=!e.debug||e.debug;return new g(t,r)}return new m}var S=new o.InjectionToken("Internal forRoot Guard");function F(e){if(e)throw new TypeError("NgxUploadModule.forRoot() is called twice.");return"guarded"}var R=function(){function e(){}var t;return t=e,e.forRoot=function(e,r){return{ngModule:t,providers:[{provide:b,useValue:r||w},{provide:y,useValue:e||I},{provide:h,useFactory:C,deps:[b]},{provide:S,useFactory:F,deps:[[b,new o.Optional,new o.SkipSelf]]}]}},e=t=s([o.NgModule({declarations:c(P),exports:c(P),imports:[r.HttpClientModule],entryComponents:[j]})],e)}();e.FileItem=f,e.HttpClientUploadService=v,e.NgxUploadModule=R,e.ɵa=y,e.ɵb=b,e.ɵc=I,e.ɵd=w,e.ɵe=C,e.ɵf=S,e.ɵg=F,e.ɵh=h,e.ɵi=E,e.ɵj=O,e.ɵk=j,e.ɵl=D,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=wkoza-ngx-upload.umd.min.js.map